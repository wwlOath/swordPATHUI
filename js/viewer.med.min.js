var SlideLabel = function() {
  var n = !1
      , a = [];
  this.add = function(e) {
    a.push(e),
    n && e.setVisibility(n)
  }
      ,
      this.setVisibility = function(e) {
        n = e;
        for (var t = 0; t < a.length; t++)
          a[t].setVisibility(e)
      }
      ,
      this.elmt = document.createElement("div"),
      this.bindContainer = function(e) {
        e = $(e).bind("click", function() {
          e.toggleClass("tool-k2s")
        }),
        SlideViewerConfig.isPhone && e.toggleClass("tool-k2s")
      }
}
    , MedSlideLabel = function(n, a) {
  var i = this
      , o = !1
      , s = !1
      , r = !1
      , m = $('<div class="hide"><div style="position:relative;display:inline-block;"><canvas style="position:absolute;width:100%;height:100%;"></canvas></div></div>');
  this.elmt = m[0],
      this.setVisibility = function(e) {
        (r = e) && !s && function() {
          s = !0,
          r && i.setVisibility(!0);
          var t = document.createElement("img");
          t.src = n,
              t.className = "slide_label ctrl_b_b",
              t.onerror = function(e) {
                o = !1
              }
              ,
              t.onload = function(e) {
                o = !0,
                a && setTimeout(function() {
                  !function(f, v) {
                    a.provider.getSlideExtPromise().then(function(e) {
                      var t = e.scanArea;
                      if (t) {
                        var n = m.find("canvas");
                        n[0].width = n.width(),
                            n[0].height = n.height();
                        var a = n[0].getContext("2d");
                        a.strokeStyle = "rgba(1,93,145,0.6)",
                            a.lineWidth = 1;
                        var i = n.width() / f
                            , o = n.height() / v;
                        if (a.save(),
                            a.translate(n.width() / 2, n.height() / 2),
                            a.rotate(-e.slideRotation),
                            t.x *= i,
                            t.y *= o,
                            t.width *= i,
                            t.height *= o,
                            t.mask) {
                          a.fillStyle = "rgba(0,255,0,1)";
                          for (var s = t.width / t.cols, r = t.height / t.rows, l = [t.rows], d = 0; d < t.rows; d++) {
                            l[d] = [t.cols];
                            for (var c = t.cols * d, u = 0; u < t.cols; u++)
                              l[d][u] = 49 == t.mask.charCodeAt(c + u) ? 1 : 0
                          }
                          for (d = 0; d < t.rows; d++) {
                            var p = t.y + d * r;
                            for (u = 0; u < t.cols; u++) {
                              var g = (0 <= d - 1 && l[d - 1][u]) + (0 <= u - 1 && l[d][u - 1]) + (u + 1 < t.cols && l[d][u + 1]) + (d + 1 < t.rows && l[d + 1][u]);
                              if (l[d][u] && 1 < g && g < 4) {
                                var h = t.x + u * s;
                                a.fillRect(h, p, s, r)
                              }
                            }
                          }
                        } else
                          a.strokeRect(t.x, t.y, t.width, t.height)
                      }
                    })
                  }(t.naturalWidth, t.naturalHeight)
                }, 10),
                r && i.setVisibility(!0)
              }
              ,
              m.addClass("ctrl_wrap").find("div").append(t)
        }(),
            o && e ? m.removeClass("hide") : m.addClass("hide")
      }
};
!function() {
  if (!SlideViewerConfig.showZoom) {
    $.extend($.support, {
      mouse: "onmousemove"in window,
      isIframe: this.parent == this,
      isIE: !!window.ActiveXObject || "ActiveXObject"in window
    });
    var t = $.query;
    SeadragonConfig.imageLoaderLimit = 8,
        SeadragonConfig.zoomOnCursor = !0;
    var n = SlideViewerConfig;
    n.enableRelevantSlide = !0,
        n.enableSnapshot = !0,
        n.enableComment = !0,
        n.enableAnnotation = 2,
        n.enableRelevantAnnotation = !1,
        n.enableVoiceAnnotation = !0,
        n.enableLabel = !0,
        n.isPhone = -1 != navigator.userAgent.toLocaleLowerCase().indexOf("mobile") && window.screen.width < 900 && window.screen.height < 900,
        n.enableAdvanced = !1,
        n.autoShowAnnoDialog = !1,
        n.syncDel = t.get("sync_del"),
        n.isSSL = "https:" === location.protocol,
        n.enableMenu = 0 !== t.get("menu"),
        n.defaults = {
          showMenu: !n.isPhone
        },
        n.enableProxy = 1 == t.get("p") || "1" == sessionStorage.getItem("sv_proxy"),
        sessionStorage.removeItem("sv_proxy"),
        n.proxy = function(e, t) {
          if (e = "mg_proxy_" + e,
          void 0 === t)
            return !!sessionStorage.getItem(e);
          !0 === t ? sessionStorage.setItem(e, 1) : sessionStorage.removeItem(e)
        }
        ,
        n.isSimple = 1 === t.get("simple"),
        n.compactBrowsing(n.isSimple),
        n.isClientImageAdjust = !0,
        n.isDSM = !1,
        n.showLabel = function(e) {
          return o("showlabel", e, !0)
        }
        ,
        n.showMenu = function(e) {
          return o("showmenu", e, n.defaults.showMenu)
        }
        ,
        n.showZoom = function(e) {
          return o("showzoom", e, !0)
        }
        ,
        n.showFrame = function(e) {
          return o("showframe", e, !1)
        }
        ,
        n.frameArea = function(e) {
          return n.localStorage("frameArea", e, !1)
        }
        ,
        n.showMeasurement = function(e) {
          return o("showMeasurement", e, !1)
        }
        ,
        n.fluorescent = function(e) {
          return o("fluorescent", e, !1)
        }
        ,
        n.showLogo = function(e) {
          return o("showLogo", e, !1)
        }
        ,
        n.s4hy = function(e) {
          return (null != e || 1 !== t.get("simple_toggle")) && o("s4hy", e, !0)
        }
        ,
        n.hotKey = function(e) {
          if (null == e)
            return $.cookie("hotKey") || 119;
          $.cookie("hotKey", e, {
            expires: 365
          })
        }
        ,
        n.changeViewportOffset = function(e) {
          if (null == e) {
            var t = $.cookie("c_vp_off");
            if (null == t)
              t = {
                x: 0,
                y: 0
              };
            else if ("string" == typeof t)
              try {
                t = JSON.parse(t)
              } catch (e) {}
            return t
          }
          $.cookie("c_vp_off", JSON.stringify(e), {
            expires: 365
          })
        }
        ,
        n.position = function(e, t) {
          if (null == t) {
            var n = $.cookie(e + "_p");
            return null == n ? void 0 : JSON.parse(n)
          }
          $.cookie(e + "_p", t, {
            expires: 365
          })
        }
        ,
        n.showAnnotationList = function(e) {
          return o("s_a_l", e, !1)
        }
        ,
        n.showScale = function(e) {
          if (void 0 === e)
            return "true" == n.localStorage("scale_enable");
          n.localStorage("scale_enable", e)
        }
        ,
        n.annShowType = function(e) {
          if (void 0 === e) {
            var t = parseInt(n.localStorage("ann_showType"));
            return isNaN(t) ? 1 : t
          }
          n.localStorage("ann_showType", e)
        }
    ;
    var a = {};
    n.localStorage = function(e, t, n) {
      if (e = "mg_" + e,
      !0 === n)
        localStorage.removeItem(e),
            a[e];
      else {
        if (void 0 === t) {
          if (null == (t = a[e])) {
            if (null != (t = localStorage.getItem(e)) && ("{" == t[0] || "[" == t[0]))
              try {
                t = JSON.parse(t)
              } catch (e) {
                console.error(e)
              }
            a[e] = t
          }
          return t
        }
        t && "object" == typeof t && (t = JSON.stringify(t)),
            localStorage.setItem(e, t),
            a[e] = t
      }
    }
    ;
    var i = {};
    function o(e, t, n) {
      if (void 0 === t) {
        if (void 0 === i[e]) {
          var a = $.cookie(e);
          i[e] = a ? "on" === a : !0 === n
        }
        return i[e]
      }
      (i[e] = t) ? $.cookie(e, "on", {
        expires: 365
      }) : $.cookie(e, "off", {
        expires: 365
      })
    }
  }
}();
var UserInfo = {};
function ErrorOutput(e, t) {
  console.error(["[", e, "Error]-[RequestId:", t.requestId, ";ErrorType:", t.errorType, ";ErrorMessage:", t.errorMessage, "]"].join(""))
}
var BaseResult = function() {
  this.requestId,
      this.errorMessage,
      this.errorType
}, RelevantSlideResult = function(e) {
  BaseResult.apply(this),
      this.host,
      this.state,
      this.caseId,
      this.isVM = !1,
      this.relevantSlides = !1 === e ? {
        slides: []
      } : new Array
}, SnapshotResult = function() {
  BaseResult.apply(this),
      this.snapshots = new Array
}, RotateResult = function() {
  BaseResult.apply(this),
      this.radion
}, CommentResult = function() {
  BaseResult.apply(this),
      this.comments = new Array
}, CaptureResult = function() {
  BaseResult.apply(this),
      this.id
}, SignatureResult = function() {
  BaseResult.apply(this),
      this.host,
      this.expiry,
      this.signature
}, MMDSSlideViewerStrings, MedLang, SlideProvider;
!function() {
  if (!MMDSSlideViewerStrings) {
    !function() {
      var e = $.query.get("locale") || window.locale;
      e = e || $.cookie("LOCALE");
      e && (SlideViewerConfig.language = e.split("_")[0])
    }(),
        MedLang = MMDSSlideViewerStrings = {};
    var s = {
      en: {
        Loading: "Loading...",
        Menus: {
          Annotation: "Annotations",
          ImageAdjustment: "Image Adjust",
          Options: "Options",
          Capture: "Capture",
          RelevantSlide: "Relevant Slide",
          Comment: "Comment",
          SearchResult: "Search Result",
          RelevantAnnotations: "Relevant Annotations",
          Advanced: "APP",
          A_Stain: "StainSeparationAdjust",
          A_Stain_Desc: "For HE stain composition independent enhance or weaken processing.<br/>powered by BUAA"
        },
        Default: {
          presets: "Presets -  Alt+(1, 2, 3 ...)",
          overwrite: "Overwrite Preset",
          restore: "Restore to Default",
          msg_source_sys: "System's ",
          msg_source_user: "User's ",
          preset: "{source} preset {title} has been applied"
        },
        Labels: {
          Compact: "Animation:",
          Logo: "Logo:",
          Overlap_v: "V.Overlap:",
          Overlap_h: "H.Overlap:",
          ImageRotate: "Rotate:",
          Frame: "F.O.V:",
          FrameTitle: "Double Click to edit",
          EidtFrame: "Edit Marker",
          Zoom: "Zoom:",
          Scale: "Scale:",
          EnableAdjust: "Enable Adjust",
          CaptureDescribe: "Capture Description (Optional)",
          InputComment: "Please Input Comment...",
          ComfirmDelete: "Comfirm delete?",
          DragToRotate: "Drag to rotate",
          NotSupported: 'It seems this function is not supported well on your browser. Please use the latest <a href="https://www.google.com/chrome" target="_blank">Chrome</a> or other for a better browsing experience.',
          Size: "Size:",
          Similarity: "Similarity:",
          Arrow: "Arrow:",
          Arrow_Start: "Start",
          Arrow_End: "End",
          Arrow_Double: "Double",
          show_measurement: "Show all measurement",
          s_name: "Name",
          s_measurement: "Measurement",
          Hot_Key: "HotKey",
          ann_list: "Annotation list",
          a_stain_no: "Not support for this slide!",
          fluorescent: "Fluorescent",
          fluorescent_enter: "Enter Fluorescent",
          fluorescent_exit: "Exit Fluorescent",
          RecentCaptureDesc: "Recent Capture Description",
          CapturingWarn: "There are capture to complete, leave page may cause data loss!",
          FN: "FN:",
          Objective: "Objective:"
        },
        Buttons: {
          Ok: "OK",
          Capture: "Capture",
          Left: "L",
          Right: "R",
          Send: "Send",
          Delete: "Delete"
        },
        Messages: {
          Capturing: "Please wait,Capturing...",
          CaptureSuccess: "Capture successfully.",
          CaptureFailed: "Capture failed.",
          SaveRotateSuccess: "Save rotate info successfully.",
          SaveRotateFailed: "Save rotate info failed.",
          SelectAnnotation: "Please select annotations.",
          AddCommentFailed: "Add comment failed.",
          DeleteSnapshotFailed: "Delete snapshot failed.",
          SessionExpire: "Session expires, refresh retry.",
          Disconnected: "Uploader lose connection.",
          Connected: "Connection with uploader.",
          F11Fullscreen: "Please press F11 to toggle fullscreen"
        },
        Annotations: {
          Draw: {
            RectangleMarquee: "Draw Rectangle AOI",
            PolygonMarquee: "Draw Polygon AOI",
            CurveRoundedMarquee: "Draw Closed Curve AOI",
            VoiceAnnotation: "Draw Voice Annotation",
            CurveEditor: "Edit CurveRounded"
          },
          save: {
            success: "Saved",
            fail: "Save failed",
            drawing: "Updating"
          }
        },
        visible: {
          private: "Private annotation",
          public: "Public annotation",
          admin: "Admin visible"
        }
      },
      zh: {
        Loading: "加载中...",
        Menus: {
          Annotation: "标注",
          ImageAdjustment: "图像调节",
          Options: "选项",
          Capture: "截图",
          RelevantSlide: "相关切片",
          Comment: "评论",
          SearchResult: "搜索结果",
          RelevantAnnotations: "相关标注",
          Advanced: "应用",
          A_Stain: "染色分离调节",
          A_Stain_Desc: "可针对HE染色成分进行独立的增强或削弱处理。<br/>powered by 北京航空航天大学"
        },
        Default: {
          presets: "预设值 - Alt+(1, 2, 3 ...)",
          overwrite: "保存配置",
          restore: "重置配置",
          msg_source_sys: "系统",
          msg_source_user: "用户",
          preset: "{source}配置{title}已应用"
        },
        Labels: {
          Compact: "动画：",
          Logo: "Logo：",
          Overlap_v: "垂直重叠：",
          Overlap_h: "水平重叠：",
          ImageRotate: "图像旋转：",
          Frame: "镜下视野：",
          FrameTitle: "双击编辑",
          EidtFrame: "编辑标志区",
          Zoom: "缩放：",
          Scale: "比例尺：",
          EnableAdjust: "启用图像调节:",
          CaptureDescribe: "截图描述(可选)",
          InputComment: "请输入评论内容",
          ComfirmDelete: "确认删除？",
          DragToRotate: "拖拽旋转",
          NotSupported: '您的浏览器还不能很好的支持此功能，请使用最新的 <a href="https://www.google.com/chrome" target="_blank">Chrome</a>等浏览器以获得更好的体验。',
          Size: "大小:",
          Similarity: "相似度:",
          Arrow: "箭头:",
          Arrow_Start: "起点",
          Arrow_End: "终点",
          Arrow_Double: "双箭头",
          show_measurement: "显示所有测量值",
          s_name: "名称描述",
          s_measurement: "测量信息",
          Hot_Key: "快捷键",
          ann_list: "标注列表",
          a_stain_no: "该切片暂不支持染色调节！",
          fluorescent: "荧光笔模式",
          fluorescent_enter: "进入荧光笔模式",
          fluorescent_exit: "退出荧光笔模式",
          RecentCaptureDesc: "最近描述",
          CapturingWarn: "尚有截图未完成，离开页面可能造成数据丢失！",
          FN: "视场数:",
          Objective: "物&nbsp;&nbsp;&nbsp;镜:"
        },
        Buttons: {
          Ok: "确定",
          Capture: "截图",
          Left: "左",
          Right: "右",
          Send: "发送",
          Delete: "删除"
        },
        Messages: {
          Capturing: "截图中，请稍候……",
          CaptureSuccess: "截图成功。",
          CaptureFailed: "截图失败。",
          SaveRotateSuccess: "保存旋转信息成功。",
          SaveRotateFailed: "保存旋转信息失败。",
          SelectAnnotation: "请先选择标注",
          AddCommentFailed: "添加评论失败。",
          DeleteSnapshotFailed: "删除截图失败。",
          SessionExpire: "会话过期，请刷新页面重试。",
          Disconnected: "上传端失去连接。",
          Connected: "连接成功。",
          F11Fullscreen: "请按F11切换全屏显示"
        },
        Annotations: {
          Draw: {
            RectangleMarquee: "绘制矩形ROI",
            PolygonMarquee: "绘制多边形ROI",
            CurveRoundedMarquee: "绘制闭合曲线ROI",
            VoiceAnnotation: "绘制语音",
            CurveEditor: "编辑闭合曲线"
          },
          save: {
            success: "已保存",
            fail: "保存失败",
            drawing: "更新中"
          }
        },
        visible: {
          private: "仅自己可见",
          public: "公开",
          admin: "切片管理员可见"
        }
      }
    };
    MedLang.getString = function(e, t) {
      for (var n = e.split("."), a = function(e) {
        e = e || s;
        var t = SlideViewerConfig.language;
        if (e[t])
          return e[t];
        null != t && "" !== t && "auto" !== t || (t = window.navigator.userLanguage || window.navigator.language);
        t = t.split("-")[0],
        e[t] || (t = "en");
        return SlideViewerConfig.language = t,
            e[t]
      }(t), i = 0; i < n.length; i++)
        a = a[n[i]] || {};
      "string" != typeof a && (a = "");
      var o = arguments;
      return a.replace(/\{\d+\}/g, function(e) {
        var t = parseInt(e.match(/\d+/)) + 1;
        return t < o.length ? o[t] : ""
      })
    }
        ,
        MedLang.interpretElem = function(e, t) {
          return e.find("[data-lang]").html(function() {
            return MedLang.getString($(this).attr("data-lang"), t)
          }),
              e
        }
  }
}(),
    SlideProvider = function() {
      var d, c, u, f, v, p, i, g, m = this, b = !0 !== (b = $.query.get("gurl")) && b ? b : "", h = $.query.get("extUrl"), n = $.Deferred(), a = n.promise(), o = $.Deferred(), e = o.promise(), s = {};
      $(document).ajaxSend(function(e, t, n) {
        return !(!n.fullUrl && 0 != n.url.indexOf("http")) || (n.url,
            n.url = m.getSigUrl(n.url, n.type, !0, !1),
            n.fullUrl = !0)
      }),
          this.getSigUrl = function(e, t, n, a) {
            var i = n ? u : c;
            if (!i) {
              if (i = $.extend({}, tokenDTO),
                  n ? u = i : (c = i,
                  h && (i.extUrl = h),
                      i.locale = "zh" == SlideViewerConfig.language ? "zh_CN" : "en"),
                  i.addits) {
                for (var o in i.addit = [],
                    i.addits)
                  i[o] = i.addits[o],
                      i.addit.push(o);
                delete i.addits
              }
              delete i.token
            }
            var s = "";
            if (e.startsWith("http")) {
              var r = e.indexOf("/", 9);
              s = e.substring(0, r),
                  e = e.substring(r)
            }
            r = e.indexOf("?");
            var l = (a ? "" : apiPath) + (-1 == r ? e : e.substring(0, r));

            if(e.indexOf('.jpg') != -1) {
              //l = 'https://motic3.oss-cn-shanghai.aliyuncs.com/'+e;
              l = 'http://localhost:63342/moticSlide/'+e;
              return i.random = (new Date).getTime(),
                  i.sig = mAppSig(tokenDTO.token, "GET", l, i.random),
              s + (l += -1 < r ? e.substring(r) + "&" : "?");

            }else{
              return i.random = (new Date).getTime(),
                  i.sig = mAppSig(tokenDTO.token, t || "GET", l, i.random),
              s + (l += -1 < r ? e.substring(r) + "&" : "?") + $.param(i, !0)
            }
          }
      ;
      var y, r = {};
      this.openSlide = function(e, t) {
        var a = $.Deferred();
        d = a.promise(),
            f = e.toLowerCase(),
            m.getRequest("Metadata", !0, new OpenSlideResult, function(e, t) {
              e.resultCode = 0;
              var n = e.slide = function(e) {
                var t = new SlideInfo
                    , n = e.id;
                36 == e.id.length && 8 == n.indexOf("-") && (n = n.toLowerCase()),
                    t.id = t.guid = n,
                    t.name = e.name,
                    t.barcode = e.barcode,
                    t.groupSize = e.groupSize,
                    t.stain = e.stain,
                    t.watermark = e.watermark,
                    t.sensitive = e.sensitive,
                    t.storageStatus = e.storageStatus;
                for (var a = e.images, i = e.rois, o = 0; o < i.length; o++) {
                  var s = new ROI;
                  s.id = i[o].id,
                      s.x = i[o].x1,
                      s.y = i[o].y1,
                      s.width = parseInt(i[o].x2) - parseInt(i[o].x1),
                      s.height = parseInt(i[o].y2) - parseInt(i[o].y1);
                  for (var r = 0; r < a.length; r++)
                    if (a[r].id == i[o].id) {
                      s.hasImage = !0,
                          s.image = new SlideImage,
                          s.image.id = s.id,
                          s.image.scanObjective = s.scanObjective = a[r].scanObjective,
                          s.image.calibration = a[r].calibration,
                          s.image.width = a[r].width,
                          s.image.height = a[r].height,
                          s.image.tileSize = parseInt(a[o].tileWidth);
                      break
                    }
                  t.ROIs.push(s)
                }
                for (o = 0; o < a.length; o++)
                  if ("f" == a[o].id) {
                    var l = t.baseImage;
                    l.id = "f",
                        l.isBaseImage = !0,
                        l.scanObjective = parseInt(a[o].scanObjective),
                        l.calibration = parseFloat(a[o].calibration),
                        l.width = parseInt(a[o].width),
                        l.height = parseInt(a[o].height),
                        l.tileSize = parseInt(a[o].tileWidth),
                        l.tierCount = e.tierCount,
                        l.tierSpacing = e.tierSpacing;
                    break
                  }
                return t
              }(t);
              f = n.id,
                  x = n.groupSize,
                  E = n.stain = "HE",
                  w = n.watermark,
                  g = 1 < n.baseImage.tierCount,
                  p = t.storageType,
              "Local" != t.storageType && !A.proxy(t.storageId) || (A.enableProxy = !0),
                  0 < t.storageId ? (v = n.storageId = t.storageId,
                      m.getSignature(t.storageId, function(e, t, n) {
                        for (var a = 0; a < e.length; a++)
                          k.push(e[a] + "/" + f + "/");
                        S = t,
                            y = n
                      }, !0, null, ["f.jpg", "f.index.gz"])) : A.isDSM = !0,
                  i = t.status,
                  r.alias = n.name,
              h || a.resolve(r)
            }, t, !0),
            m.getRequest("Extension", !1, {}, function(e, t) {
              C = t,
                  n.resolve(t)
            }),
            m.getRequest("Properties", !1, {}, function(e, t) {
              s = t,
                  o.resolve(t)
            }),
        h && m.request(h, "GET", {}, !0, {}, function(e, t) {
          $.extend(e, t)
        }, function(e) {
          $.extend(r, e),
              a.resolve(r)
        }, void 0, !0, !0)
      }
          ,
          this.getExtPromise = function() {
            return d
          }
          ,
          this.getPropPromise = function() {
            return e
          }
          ,
          this.getSlideExtPromise = function() {
            return a
          }
          ,
          this.getTitle = function(t) {
            d.done(function(e) {
              t(e.alias || "")
            })
          }
          ,
          this.getWatermark = function(t) {
            d.done(function(e) {
              t(e.watermark)
            })
          }
          ,
          this.isSensitive = function(t) {
            d.done(function(e) {
              t(e.isSensitive)
            })
          }
      ;
      var S, w, C = {
        adjustments: {},
        annotations: {},
        rotate: 0
      }, k = [], x = 0, A = SlideViewerConfig, T = !(this.isReadOnly = function() {
            return A.isReadOnly
          }
      ), M = A.isDSM;
      this.enableProxy = function() {
        return !A.enableProxy && !M && (A.enableProxy = !0,
            A.proxy(v, !0),
            !0)
      }
          ,
          this.postMessage = function(e) {
            var t = window.parent;
            t && t !== window && t.postMessage && t.postMessage(e, "*")
          }
      ;
      var l, R = [], I = !1, D = [];
      this.subscribe = function(e, t) {
        var n;
        l || P(),
        l.connected && (n = l.subscribe(e, t)),
            D.push({
              url: e,
              callback: t,
              sub: n
            })
      }
          ,
          this.unsubscribe = function(e) {
            for (var t = 0; t < D.length; t++)
              if (D[t].url == e) {
                D[t].sub.unsubscribe(),
                    D.splice(t, 1);
                break
              }
          }
      ;
      var O = [];
      function P() {
        (l = Stomp.client((A.isSSL ? "wss://" : "ws://") + location.host + "/MotiCloud/IM?userId=" + userId)).ws.onclose = t,
            l.ws.onerror = t,
            l.connect({}, function(e) {
              for (var t = 0; t < D.length; t++)
                D[t].sub = l.subscribe(D[t].url, D[t].callback);
              for (t = 0; t < O.length; t++)
                l.send("/app" + O[t].url, {}, O[t].msg);
              O.length = 0
            }, t)
      }
      function t(e) {
        I = !1,
            l.ws.onclose = null,
            l.ws.onerror = null,
            setTimeout(P, 4e3)
      }
      this.send = function(e, t) {
        l || P(),
            l.connected ? l.connected && l.send("/app" + e, {}, t) : O.push({
              url: e,
              msg: t
            })
      }
          ,
          this.sendMessage = function(e) {
            I || (40 < R.push(e) && R.shift(),
                console.warn("disconnect!" + e)),
            l.connected && l.send("/app/Slides/" + f + "/Tiles", {}, e)
          }
          ,
          this.subscribeMessage = function(a) {
            0 != i && m.subscribe("/topic/Slides/" + f + "/Tiles", function(e) {
              var t = $.parseJSON(e.body);
              if (t.status)
                if ("connected" == t.status) {
                  t.connected = !0,
                      I = !0;
                  for (var n = R.length - 1; 0 <= n; n--)
                    m.sendMessage(R[n]);
                  R = []
                } else
                  "disconnected" == t.status && (I = !1,
                      t.connected = !1);
              a(t)
            })
          }
          ,
          this.updateProp = function(t, n, a) {
            m.updateRequest("Properties/" + encodeURIComponent(t), "PUT", JSON.stringify(n), !0, function(e) {
              s[t] = n,
                  a(e)
            })
          }
          ,
          this.updateRotate = function(t, n) {
            t %= 2 * Math.PI,
                m.updateRequest("Rotation", "PUT", t.toString(), !0, function(e) {
                  n(e),
                      C.rotate = t
                })
          }
          ,
          this.getRotate = function(e, t) {
            var n = new RotateResult;
            n.radian = C.rotation,
                n.radian,
                a.done(function() {
                  e(n)
                })
          }
      ;
      var E, N = {}, L = ["0,202,204", "205,198,232", "242,203,131", "252,180,186", "65,148,179", "169,222,230"];
      this.color = function(e) {
        return "rgba(" + L[parseInt(e.substring(0, 1), 16) % L.length] + ",0.7)"
      }
          ,
          this.releaseAnnotation = function(e, t) {
            var n = N[e];
            null != n && delete n[t]
          }
          ,
          this.getAnnotation = function(e, t, n, a, s, i) {
            var o = new AnnotationResult;
            if (null == a) {
              o.annotations = JSON.parse(C.annotations[t] || "[]");
              for (var r = 0; r < o.annotations.length; r++)
                o.annotations[r].visible = !0;
              n(o)
            } else {
              var l = N[t];
              null == l && (l = N[t] = {}),
                  i || null == l[a] ? (null == l[a] && (l[a] = "loading"),
                      o.userId = a,
                      d.done(function(e) {
                        m.getRequest("Annotations?ownerId=" + a + "&imageId=" + t + "&role=" + e.role, !0, o, function(e, t, n) {
                          if (0 != t.length) {
                            var a = {
                              owner: s,
                              color: "rgba(" + L[parseInt(e.userId.substring(0, 1), 16) % L.length] + ",0.7)"
                            };
                            t = t[0].annotations;
                            for (var i = 0; i < t.length; i++) {
                              var o = t[i];
                              o.visible = !0,
                                  o.isLocked = !0,
                                  o.status = -1,
                              o.externalData || (o.externalData = {}),
                                  $.extend(o.externalData, a)
                            }
                            e.annotations = t,
                                e.oldAnnotations = l[e.userId],
                                l[e.userId] = t
                          }
                        }, function(e) {
                          e.success ? n(e) : (l[e.userId] = void 0,
                              ErrorOutput("GetRelevantSlide", e))
                        }, !0)
                      })) : "loading" != l[a] && (o.success = !0,
                      o.annotations = l[a],
                      n(o))
            }
          }
          ,
          this.updateAnnotations = function(e, t, n, a) {
            var i = "Annotations?imageId=" + t
                , o = JSON.stringify({
              visible: m.annVisible(t),
              annotations: n
            });
            m.updateRequest(i, "PUT", o, !0, function(e) {
              a(e),
                  C.annotations[t] = o,
                  hasAnn = 0 < n.length
            })
          }
      ;
      var _ = {};
      this.getAdjustFactor = function(e) {
        return _[e] || ("BASE" == e ? new ImageAdjustment : new window[e + "Factor"](E,null))
      }
          ,
          this.updateFactor = function(e, t) {
            _[e] = t,
                z()
          }
      ;
      var V = "";
      function z() {
        for (var e in V = "",
            _) {
          var t = _[e];
          if ("BASE" === e) {
            if (A.isClientImageAdjust || !t.isChanged())
              continue;
            for (var n in V += "&base=1",
                t)
              "rotateDegree" != n && "function" != typeof t[n] && (V += "&" + n + "=" + t[n])
          } else {
            if (t.isDefault())
              continue;
            V += t.getParam()
          }
        }
      }
      this.getImageAdjustment = function(e, t, n, a) {
        var i = new ReadImageAdjustmentResult;
        !function(e, t) {
          var n = new ImageAdjustment;
          for (var a in t) {
            var i = t[a];
            if ("string" == typeof i)
              if (i = JSON.parse(i),
                  t[a] = i,
              "BASE" === a)
                void 0 !== i.gamma && (n.gamma = i.gamma),
                void 0 !== i.red && (n.red = i.red),
                void 0 !== i.green && (n.green = i.green),
                void 0 !== i.blue && (n.blue = i.blue),
                void 0 !== i.saturation && (n.saturation = i.saturation),
                void 0 !== i.contrastMin && (n.contrastMin = i.contrastMin),
                void 0 !== i.contrastMax && (n.contrastMax = i.contrastMax),
                void 0 !== i.sharpness && (n.sharpness = i.sharpness),
                    t[a] = n;
              else {
                var o = window[a + "Factor"];
                t[a] = void 0 === o ? new IFactor : new o(E,i)
              }
          }
          $.extend(_, t),
          A.isClientImageAdjust && (e.adjustment = n,
              T = e.adjustment.isChanged(),
              A.enableProxy),
              z()
        }(i, C.adjustments),
            a(i)
      }
          ,
          this.updateImageAdjustment = function(e, t, n, a, i) {
            if ("BUAA" != i) {
              var o = "Adjustment";
              void 0 !== i && (o += "?app=" + i),
                  m.updateRequest(o, "PUT", JSON.stringify(n), !0, function(e) {
                    a && a(e),
                    null == i && (i = "BASE"),
                    "BASE" === i && (T = n.isChanged()),
                        C.adjustments[i] = n
                  }, {
                    "Content-Type": "application/json"
                  })
            } else
              C.adjustments[i] = n
          }
          ,
          this.getDefaults = function(e) {
            var t = ["/Info/ViewerDefaults/", userId].join("");
            m.request(t, "GET", {
              onlyMenu: !0
            }, !0, {}, function(e, t) {
              e.adjusts = t
            }, e)
          }
          ,
          this.updateDefault = function(e, t) {
            var n = ["/Info/ViewerDefaults/", userId].join("");
            m.request(n, "PUT", JSON.stringify(e), !0, new UpdateResult, null, t)
          }
          ,
          this.deleteDefault = function(e, t) {
            var n = ["/Info/ViewerDefaults/", userId, "?title=", encodeURIComponent(e.title)].join("");
            m.request(n, "DELETE", null, !0, new UpdateResult, null, t)
          }
          ,
          this.addComment = function(e, t) {
            m.updateRequest("Comments", "POST", {
              comment: e
            }, !0, t)
          }
          ,
          this.getComments = function(e) {
            m.getRequest("Comments", !0, new CommentResult, function(e, t) {
              e.comments = t
            }, e)
          }
          ,
          this.getSlidePermission = function(e, t) {
            t(2)
          }
          ,
          this.getRelevantSlide = function(t) {
            d.done(function(e) {
              t(e.relevantSlide)
            })
          }
          ,
          this.getCaseSlide = function(n, a, i, e) {
            var t = [a || location.origin, "API/Case/Slides", n];
            isNaN(parseInt(i)) || t.push(i),
                t = t.join("/"),
                t += "?slideId=" + f,
                m.jsonpRequest(t, new RelevantSlideResult, function(e, t) {
                  e.state = i,
                      e.caseId = n,
                      e.host = a,
                      e.isVM = !0,
                      e.currentSlideId = f,
                      e.relevantSlides = t
                }, e, !0)
          }
          ,
          this.addLog = function(e, t) {}
          ,
          this.jsonpRequest = function(e, n, t, a) {
            $.ajax({
              url: e,
              dataType: "jsonp",
              success: function(e) {
                n.success = !0,
                    t(n, e),
                "function" == typeof a && a(n)
              },
              error: function(e, t) {
                n.errorMessage = e.statusText,
                    n.errorType = t,
                "function" == typeof a && a(n)
              }
            })
          }
          ,
          this.annVisible = function(e, t) {
            if (null == t)
              return null == (t = C.annotations[e + "_visible"]) ? 1 : t;
            C.annotations[e + "_visible"] = t
          }
      ;
      var j, U = Math.abs;
      this.getTileUrl = function(e, t, n, a, i, o, s) {
        var r, l;
        if (r = j ? t + ".jpg" : (r = [g ? n + "_" : "", t, "_", a],
            0 < x ? r.push("/", parseInt(o / x), "-", parseInt(i / x), "/") : r.push("_"),
            r.push(o, "_", i, ".jpg"),
            r.join("")),
            A.enableProxy || V ? l = m.getSigUrl(["", e, "/", r, "", '', ''].join(""), "GET", !0) : y && y[r] ? l = y[r] : (l = [k[1 < k.length ? U((i - o) % 2) : 0], r, S].join(""),
            "MTS" == p && (l = m.getSigUrl(l, "GET", !0, !0))),
            j) {
          var d = j[n][a][o]
              , c = (0 == i ? 0 : d[0]) + d[i]
              , u = d[0] + d[i + 1];
          if (c == u)
            return;
          l = [l, c + "-" + u];
        }
        l = l.slice(0, l.length - 1);
        return l
      }
          ,
          this.capture = function(n, e) {
            n.image.width,
                n.scale;
            var t = n.bounds
                , a = (n.image.height,
                n.scale,
                {
                  i: n.image.id,
                  x: Math.round(t.x),
                  y: Math.round(t.y),
                  w: Math.round(t.width),
                  h: Math.round(t.height),
                  rotation: n.description.rotation,
                  scale: n.scale,
                  comment: n.description.desc,
                  bgc: n.description.bgc,
                  storage: v
                });
            if (function(e) {
              return w || M || e || A.isClientImageAdjust && T
            }(n.hasAnnotation)) {
              var i = window.location.pathname
                  , o = i.indexOf(";jsessionid=");
              0 < o && (i = i.substring(0, o));
              var s = t.x
                  , r = t.y
                  , l = t.width
                  , d = t.height;
              n.isROI || (t.width / t.height > 4 / 3 ? (l = t.width,
                  d = t.width / (4 / 3),
                  r = t.y - (d - t.height) / 2,
                  s = t.x) : (d = t.height,
                  l = 4 * t.height / 3,
                  s = t.x - (l - t.width) / 2,
                  r = t.y));
              var c = i + $.query.REMOVE("user").REMOVE("appId").REMOVE("v").REMOVE("appId").REMOVE("se").REMOVE("sig").REMOVE("random").REMOVE("addit").set("i", n.image.id).set("simple", 1).set("x", s / n.scale).set("y", r / n.scale).set("w", l / n.scale).set("h", d / n.scale).set("rotation", a.rotation).set("t", n.tierIndex).set("locale", A.language);
              A.showMeasurement() ? c += "&sm=1" : n.activeShape && (c += "&a=" + n.activeShape.guid),
                  a.url = encodeURIComponent(c)
            }
            a.tileSize = n.image.tileSize,
                a.width = n.image.width,
                a.height = n.image.height,
                a.groupSize = x;
            var u = _.BASE;
            if (u && u.isChanged()) {
              for (var p in a.base = {},
                  u)
                "function" != typeof (g = u[p]) && (a.base[p] = g);
              a.base = JSON.stringify(a.base)
            }
            if ((u = _.BUAA) && !u.isDefault()) {
              for (var p in a.buaa = {},
                  u) {
                var g;
                "function" != typeof (g = u[p]) && (a.buaa[p] = g)
              }
              a.buaa.stain = E,
                  a.buaa = JSON.stringify(a.buaa)
            }
            if (n.isROI && (a.isROI = !0),
            n.is3DImage && (a.t = n.tierIndex),
            n.description.nextOperateId && (a.nextOperateId = n.description.nextOperateId),
            b && (a.gurl = b),
                n.getParam)
              return a.slideId = f,
                  a.scanObjective = n.image.scanObjective,
                  void e(a);
            var h = ["/Slides/", f, "/Snapshots"].join("");
            m.request(h, "POST", a, !0, new CaptureResult, function(e, t) {
              e.snapshot = {
                Id: t,
                i: a.i,
                t: a.t,
                s: a.scale,
                x: a.x,
                y: a.y,
                w: a.w,
                h: a.h,
                rotation: a.rotation,
                desc: n.description.desc
              },
                  e.slideId = f
            }, e, null, !0)
          }
          ,
          this.updateCaptureDesc = function(e, t, n, a) {
            var i = ["Snapshots/", e, "/Comment", a ? "?isStepwise=true" : ""].join("");
            m.updateRequest(i, "PUT", t, !0, function(e) {
              e.desc = t,
                  n(e)
            }, null, !0)
          }
          ,
          this.searchFocusArea = function(e) {
            var t = window.location.pathname
                , n = t.indexOf(";jsessionid=");
            0 < n && (t = t.substring(0, n));
            var a = t + $.query.REMOVE("user").set("i", e.i).set("simple", 1).set("x", e.x).set("y", e.y).set("w", e.w).set("h", e.h).set("t", e.t)
                , i = $("<form target='_blank' method='post' action='" + apiPath + "/Search' enctype='multipart/form-data'></form>");
            $("<input type='hidden' name='url'>").val(encodeURIComponent(a)).appendTo(i),
                $("<input type='hidden' name='wpx'>").val(e.wpx).appendTo(i),
                $("<input type='hidden' name='hpx'>").val(e.hpx).appendTo(i),
                $("<input type='hidden' name='c'>").val(225).appendTo(i),
                i.appendTo("body"),
                i.submit()
          }
          ,
          this.getSnapshotList = function(e, n) {
            var t = ["/Slides/", n || f, "/Snapshots"].join("");
            b && (t += "?gurl=" + encodeURIComponent(b)),
                m.request(t, "GET", {}, !0, new SnapshotResult, function(e, t) {
                  e.slideId = n || f,
                      e.snapshots = t,
                      e.isRelevant = !!n
                }, e)
          }
          ,
          this.deleteSnapshot = function(e, t, n) {
            var a = ["/Slides/", e, "/Snapshots/", t].join("");
            1 == A.syncDel && b && (a += "?sync_del=1&gurl=" + encodeURIComponent(b)),
                m.request(a, "DELETE", {}, !0, new UpdateResult, null, n, null, !0)
          }
          ,
          this.getSnapshotUrl = function(e, t) {
            return m.getSigUrl(["/Slides/", e, "/Snapshots/", t].join(""), "GET", !0)
          }
          ,
          this.stopBrowse = function() {
            null != l && l.ws.close(),
                m.updateRequest("BrowseEnd", "PUT", {}, !1, null, null, !0)
          }
          ,
          this.getThumbnailUrl = function(e, t, n, a) {
            if (n)
              return ["../../Open/Slides/", e, "/Thumbnail"].join("");
            var i = ["/Tiles/thumbnails/", e, "_", t, "_256.jpg?storage=", v, n ? "" : V].join("");
            return m.getSigUrl(i, "GET", !0)
          }
          ,
          this.getLabelUrl = function() {
            return m.getSigUrl("/Slides/" + f + "/Label?storage=" + v, "GET", !0)
          }
          ,
          this.getSlideSlideUrl = function() {
            return m.getSigUrl("/Slides/" + f + "/Slide?storage=" + v, "GET", !0)
          }
          ,
          this.loadImageIndex = function(e, t) {
            if (e.storageStatus.endsWith("Archive")) {
              var n = t.id + ".index.gz"
                  , a = y && y[n];
              a = a ? a || k[0] + n + S : m.getSigUrl("/Storages/" + e.storageId + "/" + f + "/" + t.id + ".index.gz", "GET", !0),
                  m.request(a, "GET", {}, !1, {}, function(e, t) {
                    return t
                  }, function(e) {
                    0 < e.length && (j = function(e, t) {
                      for (var n = parseInt(t.charAt(0)), a = 1, i = 0, o = Math.ceil(Math.log(Math.max(e.width, e.height)) / Math.log(2)) + 1, s = [e.tierCount], r = 0; r < e.tierCount; r++) {
                        s[r] = [o];
                        for (var l = 0; l < o; l++)
                          for (var d = Math.ceil(e.width * Math.pow(.5, l) / e.tileSize), c = Math.ceil(e.height * Math.pow(.5, l) / e.tileSize), u = s[r][l] = [c], p = 0; p < c; p++)
                            for (var g = u[p] = [d], h = g[0] = i, f = 0; f < d; ) {
                              var v = B(t.substring(a, a += n));
                              i += v,
                                  g[++f] = i - h
                            }
                      }
                      return s
                    }(t, e))
                  }, void 0, !0, !0)
            }
          }
      ;
      var q = 94;
      function B(e) {
        for (var t = 0, n = 0; n < e.length; n++) {
          var a = e.charCodeAt(n);
          93 <= a && a--,
          35 <= a && a--,
              t += a -= 32,
          n < e.length - 1 && (t *= q)
        }
        return t
      }
      function F(e, t) {
        if (null == sessionStorage)
          return null;
        if (null == t) {
          if (null !== (t = sessionStorage.getItem(e)))
            return decodeURI(t)
        } else
          sessionStorage.setItem(e, encodeURI(t))
      }
      this.getSignature = function(a, i, e, t, n) {
        var o, s = "sig_" + f;
        if (!e && (o = F(s)) && (o = JSON.parse(o),
        36e5 < new Date(o.signedexpiry).getTime() - (new Date).getTime()))
          l(o);
        else {
          var r = ["/Slides/", f, "/Signature"], result;
          t && (r.push("?container="),
              r.push(t)),
              r = r.join(""),

          result = {"Type":2,"Expiry":"2021-06-22T09:04:47Z","Host":"oss-cn-shanghai.aliyuncs.com","Endpoint":"https://motic3.oss-cn-shanghai.aliyuncs.com","CName":null,"TilePath":"","ToMG":false,"files":{"f.index.gz":"https://motic3.oss-cn-shanghai.aliyuncs.com/9e971be8-219a-4c6e-aa13-43002ce1ad00/f.index.gz?Expires=1624352687&OSSAccessKeyId=g7ksHnt1H6oUAUaP&Signature=RUdhovbp0uRu6tk0zLVpYTYzwGo%3D","f.jpg":"https://motic3.oss-cn-shanghai.aliyuncs.com/9e971be8-219a-4c6e-aa13-43002ce1ad00/f.jpg?Expires=1624352687&OSSAccessKeyId=g7ksHnt1H6oUAUaP&Signature=AoS0AzZ6tNUtglxoEDVQryoIspk%3D"},"Id":null,"Secret":null,"Token":null,"Bucket":"motic3","Time":1624345487896};
          result.Bucket ? e.host = result.Bucket + "." + result.Host : e.host = result.Host,
              e.endpoint = result.Endpoint,
              e.signedexpiry = result.Expiry || (new Date).getTime() + 864e5,
              e.signature = result.Signature || "",
              e.cName = result.CName,
              e.type = result.Type,
              e.tilePath = result.TilePath,
              e.files = result.files

              /*m.request(r, "GET", $.param({
                storage: a,
                files: n
              }, !0), !1, new SignatureResult, function(e, t) {
                var t = {"Type":2,"Expiry":"2021-06-22T09:04:47Z","Host":"oss-cn-shanghai.aliyuncs.com","Endpoint":"https://motic3.oss-cn-shanghai.aliyuncs.com","CName":null,"TilePath":"","ToMG":false,"files":{"f.index.gz":"https://motic3.oss-cn-shanghai.aliyuncs.com/9e971be8-219a-4c6e-aa13-43002ce1ad00/f.index.gz?Expires=1624352687&OSSAccessKeyId=g7ksHnt1H6oUAUaP&Signature=RUdhovbp0uRu6tk0zLVpYTYzwGo%3D","f.jpg":"https://motic3.oss-cn-shanghai.aliyuncs.com/9e971be8-219a-4c6e-aa13-43002ce1ad00/f.jpg?Expires=1624352687&OSSAccessKeyId=g7ksHnt1H6oUAUaP&Signature=AoS0AzZ6tNUtglxoEDVQryoIspk%3D"},"Id":null,"Secret":null,"Token":null,"Bucket":"motic3","Time":1624345487896};
                t.Bucket ? e.host = t.Bucket + "." + t.Host : e.host = t.Host,
                    e.endpoint = t.Endpoint,
                    e.signedexpiry = t.Expiry || (new Date).getTime() + 864e5,
                    e.signature = t.Signature || "",
                    e.cName = t.CName,
                    e.type = t.Type,
                    e.tilePath = t.TilePath,
                    e.files = t.files
              }, function(e) {
                if (e.error)
                  throw "Azure Signature Failed:" + status;
                l(e),
                    F(s, JSON.stringify(e))
              }, null, !0)*/
        }
        function l(e) {
          var t = []
              , n = "";
          switch (t.push((e.endpoint || "") + e.tilePath),
          e.cName && !A.isSSL && t.push(e.cName + e.tilePath),
              e.type) {
            case 0:
            case 2:
              n = "";
              break;
            case 4:
              n = "?storage=" + a;
              break;
            case 1:
              n = "?" + e.signature;
              break;
            case 3:
              n = "?sign=" + e.signature
          }
          i(t, n, e.files)
        }
      }
          ,
          this.slideId = function() {
            return f
          }
          ,
          this.getWebSiteUrl = function() {
            return apiPath
          }
          ,
          this.getActionUrl = function(e, t) {
            return ["/Slides/", t || f, "/", e].join("")
          }
          ,
          this.getRequest = function(e, t, n, a, i, o) {
            var s = ["/Slides/", f, "/", e].join("");
            m.request(s, "GET", {}, t, n, a, i, void 0, o)
          }
          ,
          this.updateRequest = function(e, t, n, a, i, o, s) {
            var r = ["/Slides/", f, "/", e].join("");
            b && (r += (-1 == r.indexOf("?") ? "?" : "&") + "gurl=" + encodeURIComponent(b)),
                m.request(r, t, n, a, new UpdateResult, null, i, o, s)
          }
          ,
          this.request = function(e, n, t, a, s, r, l, i, o, d) {
            if (!o && m.isReadOnly())
              return s.success = !0,
                  void ("GET" == n && "function" == typeof l && setTimeout(function() {
                    l(s)
                  }, 0));
            console.log(e)
            var values = e.split('/');
            var ajaxUrl = values[values.length - 1];
            var responseTexts = '';

            console.log(ajaxUrl)
            if(ajaxUrl == 'Metadata'){
              responseTexts = '{"id":"9e971be8-219a-4c6e-aa13-43002ce1ad00","name":"2.上海胸科医院-208428-b2 he","barcode":"","tierCount":1,"tierSpacing":0.0,"storageId":1,"storageStatus":"Hot","status":0,"storageType":"OSS","groupSize":0,"rois":[],"images":[{"id":"f","width":50439,"height":84728,"scanObjective":40.0,"calibration":0.265018,"tileWidth":512,"tileHeight":512,"backgroundColor":15922165,"layers":[{"cols":"99","index":"0","rows":"166","scale":"1"},{"cols":"50","index":"1","rows":"83","scale":"0.5"},{"cols":"25","index":"2","rows":"42","scale":"0.25"},{"cols":"13","index":"3","rows":"21","scale":"0.125"},{"cols":"7","index":"4","rows":"11","scale":"0.0625"},{"cols":"4","index":"5","rows":"6","scale":"0.03125"},{"cols":"2","index":"6","rows":"3","scale":"0.015625"},{"cols":"1","index":"7","rows":"2","scale":"0.0078125"},{"cols":"1","index":"8","rows":"1","scale":"0.00390625"},{"cols":"1","index":"9","rows":"1","scale":"0.001953125"},{"cols":"1","index":"10","rows":"1","scale":"0.0009765625"},{"cols":"1","index":"11","rows":"1","scale":"0.00048828125"},{"cols":"1","index":"12","rows":"1","scale":"0.000244140625"},{"cols":"1","index":"13","rows":"1","scale":"0.0001220703125"},{"cols":"1","index":"14","rows":"1","scale":"6.103515625e-05"},{"cols":"1","index":"15","rows":"1","scale":"3.0517578125e-05"},{"cols":"1","index":"16","rows":"1","scale":"1.52587890625e-05"},{"cols":"1","index":"17","rows":"1","scale":"7.62939453125e-06"}]}],"manufacturer":"MDSX"}';
            }else if(ajaxUrl == 'Extension') {
              responseTexts = '{"rotation":0.0,"annotations":{},"adjustments":{},"scanArea":{"x":-28,"y":-188,"width":504,"height":306,"rows":46,"cols":23},"slideRotation":0.0}';
            }else if(ajaxUrl == 'Properties'){
              responseTexts = '{}';
            }/*else if(ajaxUrl == 'Signature'){
              responseTexts = '{"Type":2,"Expiry":"2021-06-17T05:30:05Z","Host":"oss-cn-shanghai.aliyuncs.com","Endpoint":"https://motic3.oss-cn-shanghai.aliyuncs.com","CName":null,"TilePath":"","ToMG":false,"files":{"f.index.gz":"https://motic3.oss-cn-shanghai.aliyuncs.com/9e971be8-219a-4c6e-aa13-43002ce1ad00/f.index.gz?Expires=1623907805&OSSAccessKeyId=g7ksHnt1H6oUAUaP&Signature=nt8et4JYPG%2F4XNwkc6WZIlmjoT0%3D","f.jpg":"https://motic3.oss-cn-shanghai.aliyuncs.com/9e971be8-219a-4c6e-aa13-43002ce1ad00/f.jpg?Expires=1623907805&OSSAccessKeyId=g7ksHnt1H6oUAUaP&Signature=hT7Hif3INrxIQ0FIrK%2B3aWXylBk%3D"},"Id":null,"Secret":null,"Token":null,"Bucket":"motic3","Time":1623900605153}';
            }*//*else if(ajaxUrl == 'Snapshots') {
              responseTexts = '[]';
            }*/else if(ajaxUrl == 'Users?role=undefined') {
              responseTexts = '[{"id":"B927C53D-D917-4519-8E94-71F609BA3A33","name":"大鹏","hasAvatar":false},{"id":"36EFCDEA-A6A5-407A-8EE9-501EEB4C4187","name":"张海青","hasAvatar":true}]';
            }else if(ajaxUrl == '39FDEB0B-2C8B-419D-A93D-0435F391231B') {
              responseTexts = '[]';
            }else if(ajaxUrl == 'Tasks?app=DC8F8344-8FEB-46C3-87E4-3CC2B49B957F&app=E712329A-C94D-E811-B7D9-005056B50E11&app=630F8B63-CA5F-E711-AFA7-005056B50E11') {
              responseTexts = '[]';
            }else if(ajaxUrl == 'Config?slideId=9e971be8-219a-4c6e-aa13-43002ce1ad00') {
              responseTexts = '';
            }


            var n = responseTexts;
            try {
              n = $.parseJSON(n)
            } catch (e) {}
            var a = r(s, n, e);
            null != a && (s = a)

            "function" == typeof l && l(s)

            /*$.ajax({
              url: e,
              fullUrl: d,
              type: n,
              data: t,
              async: a,
              beforeSend: function(e) {
                for (var t in "PUT" == n && e.setRequestHeader("Content-Type", "application/json;charset=UTF-8"),
                    i){
                  e.setRequestHeader(t, i[t])
                }
                //e.setRequestHeader("Set-Cookie", "JSESSIONID=5351C1BA3A53835552FABF821BF8B3E8; Hm_lvt_ed76e74be4e9ac140e970801edd48234=1623832206; Hm_lpvt_ed76e74be4e9ac140e970801edd48234=1623832206; Hm_lvt_c1f8938e2eb3cf3620ca0b3d4691cba9=1623832503; Hm_lpvt_c1f8938e2eb3cf3620ca0b3d4691cba9=1623832510")
              },
              complete: function(e, t) {
                if (s.success = !0,
                e.responseText && r) {
                  //var n = e.responseText;
                  var n = responseTexts;
                  try {
                    n = $.parseJSON(n)
                  } catch (e) {}
                  var a = r(s, n, e);
                  null != a && (s = a)
                }
                /!*if (s.statusCode = e.status,
                "success" == t) {
                  if (s.success = !0,
                  e.responseText && r) {
                    var n = e.responseText;
                    try {
                      n = $.parseJSON(n)
                    } catch (e) {}
                    var a = r(s, n, e);
                    null != a && (s = a)
                  }
                } else {
                  var i = e.getResponseHeader("Generator");
                  if (i && -1 < i.indexOf("Motic")) {
                    var o = $.parseJSON(e.responseText);
                    s.requestId = o.RequestId,
                        s.errorMessage = o.Message,
                        s.errorType = o.ErrorType
                  } else
                    s.errorMessage = e.statusText,
                        s.errorType = t
                }*!/
                "function" == typeof l && l(s)
              }
            })*/
          }
    }
;
var BackBaseImage = function(e) {
  var t = '<div class="ctrl_wrap" style="display: none"><a class="roi-back" data-lang="Tooltips.BtnBackToBase"></a></div>';
  t = $(t),
      $("[data-lang]", t).attr("title", function() {
        return SlideViewerStrings.getString($(this).attr("data-lang"))
      }),
      $(".roi-back", t).bind("click", function() {
        e.openImage()
      }),
      e.bind("m.open", function() {
        e.isBaseImage() ? t.hide() : t.show()
      }),
      this.elmt = t[0]
}, SlideZoom = function(r) {
  var l, d, e, a, i, c, u, p, n, o, s, g = [0, 2, 4, 10, 20, 40, 60, 100], h = 35, f = $('<div class="ctrl_wrap"><div class="zoom_tool">                    <div class="col tips-col zoom-vertical"></div>\t                <div class="col slide-col">\t                   <div class="zoom_btn zoom_in" data-lang="Tooltips.ZoomIn"></div>\t                   <div id="zoom-vertical" class="zoom-vertical"></div>\t                   <div class="zoom_btn zoom_out" data-lang="Tooltips.ZoomOut"></div>\t                </div>                    <div class="col value-col">                       <div id="objTip" class="tip value-tip"><span></span></div>                    </div>                    <div class="clear"></div>                </div></div>'), v = !1, t = SlideViewerConfig.showZoom(), m = !0, b = null, y = 200, S = $("#objTip", f), w = !0, C = !1, k = !1, x = !1, A = 1 == $.query.get("zoom");
  function T() {
    var e = r.getCurrentImage();
    d = e.scanObjective;
    var t = r.viewport.getHomeZoom()
        , n = r.viewport.getContainerSize().x * t / e.width;
    c = n * d,
        l = [];
    for (var a = 0; a < g.length; a++)
      if (g[a] < c)
        l[0] = g[a];
      else {
        if (!(g[a] <= d))
          break;
        l.push(g[a])
      }
    l.push(2 * d);
    var i, o = "", s = (p = u = (l[1] - c) / (l[1] - l[0])) * h;
    for (a = 1; a < l.length; a++)
      o += '<a class="tip" style="position:absolute;bottom:' + (i = (a - 1) * h + s) + 'px;">' + l[a] + "</a>",
          u++;
    u--,
        f.find(".tips-col").html(o),
        $(".zoom-vertical", f).css("height", i)
  }
  function M() {
    w || (clearTimeout(e),
        $(".tip", f).show(),
        w = !0)
  }
  function R() {
    A || C || (w = !1,
        e = setTimeout(function() {
          $(".tip", f).fadeOut()
        }, 2e3))
  }
  function I() {
    if (isChanged) {
      isChanged = !1;
      var e = (d * s).toFixed(2);
      if (!v) {
        var t;
        if (e > l[1]) {
          t = (l[1] - c) / (l[1] - l[0]);
          for (var n = 2; n < l.length; n++) {
            if (!(e >= l[n])) {
              t += (e - l[n - 1]) / (l[n] - l[n - 1]);
              break
            }
            t++
          }
        } else
          t = (e - c) / (l[1] - l[0]);
        a.slider("value", 100 / u * t)
      }
      !function(e) {
        var t;
        t = 100 < e ? 1 : 10 < e ? 10 : 100,
            e = Math.round(e * t) / t,
            S.position({
              of: i,
              my: "right center",
              at: "left center"
            }).find("span").html(e + "X")
      }(e),
          b = setTimeout(I, y)
    } else
      b = null
  }
  $("[data-lang]", f).attr("title", function() {
    return SlideViewerStrings.getString($(this).attr("data-lang"))
  }),
      f.find(".slide-col").delegate(".zoom_btn", "click", function() {
        $(this).hasClass("zoom_in") ? r.zoomByRatio(2) : r.zoomByRatio(.5)
      }),
      $(".tips-col", f).delegate("a", "click", function() {
        if (!v) {
          var e = parseFloat($(this).html());
          r.zoomToObj(e)
        }
      }),
      r.addEventListener("animation", function() {
        s = r.getScale(),
            isChanged = !0,
        t && null == b && (b = setTimeout(I, y))
      }),
      r.addEventListener("updatefinish", function() {
        m && (m = !1,
            r.addEventListener("animation", M),
            r.addEventListener("animationfinish", R),
            R())
      }),
      r.addEventListener("resize", T),
      a = $("#zoom-vertical", f).slider({
        orientation: "vertical",
        range: "min",
        min: 0,
        max: 100,
        value: 0,
        slide: function(e, t) {
          if (0 != t.value) {
            var n = 0;
            if (100 == t.value)
              n = l[l.length - 1];
            else {
              var a = u / 100 * t.value;
              if (p < a) {
                var i = a - p
                    , o = Math.floor(i);
                n = l[o + 1] + (i - o) * (l[o + 2] - l[o + 1])
              } else
                n = c + a * (l[1] - l[0])
            }
            r.zoomToObj(n)
          }
        },
        start: function(e, t) {
          $("a", this).addClass("drag"),
              v = !0
        },
        stop: function(e, t) {
          $("a", this).removeClass("drag"),
              setTimeout(function() {
                v = !1
              }, 800)
        }
      }),
      f.hover(function() {
        C = !0,
            M()
      }, function() {
        C = !1,
            R()
      }),
      r.bind("m.open", T),
  t || f.hide(),
      i = a.find("a"),
  $.support.touch && $("body").bind("touchstart", function(e) {
    if (!r.isDisabled) {
      var t = e.originalEvent.touches.length;
      1 == t ? k ? (r.zoomByRatio(2),
          k = !1,
          clearTimeout(n)) : (k = !0,
          n = setTimeout(function() {
            k = !1
          }, 200)) : 2 == t && (x = !0,
          o = setTimeout(function() {
            x = !1
          }, 100))
    }
  }).bind("touchend", function() {
    x && (x = !1,
        clearTimeout(o),
        r.zoomByRatio(.5))
  }),
      this.toggle = function(e) {
        (t = e) ? (f.show(),
            I()) : f.hide()
      }
      ,
      this.elmt = f[0]
}, TierScroll = function(a) {
  var i, o, s, n, r, l, d, c, e = $('<div class="ctrl_wrap">\t\t\t\t\t<div class="scroll ui-widget-content">\t\t\t\t\t\t<div class="wheel"></div>\t\t\t\t\t\t<div class="shade"></div>\t\t\t\t\t\t<div class="tip value-tip tierTip"><span>0</span></div>\t\t\t\t\t</div>\t\t\t\t</div>'), u = 0, p = $(".wheel", e), g = $(".tierTip", e), h = 0, t = !1, f = !1;
  this.addTierIndex = y;
  var v, m = null, b = 0;
  function y(e, t, n) {
    t && (clearTimeout(d),
        g.show(),
        d = setTimeout(function() {
          g.fadeOut()
        }, 2e3)),
        c = 40,
        function e(t, n) {
          h += n,
              h %= 6,
              p.css("background-position", "50% " + h + "px"),
          0 < --c && setTimeout(function() {
            e(t, n)
          }, t)
        }(8, e),
    s < (u -= e) && (u = s),
    u < o && (u = o),
        g.html(u),
        clearTimeout(l),
        n ? a.change3DTierIndex(i + u) : l = setTimeout(function() {
          a.change3DTierIndex(i + u)
        }, 800)
  }
  v = $("div.scroll", e).draggable({
    start: function(e) {
      b = 0,
      (n = p.css("background-position-y")) && "" != n || (n = p.css("background-position").split(" ")[1]),
          n = parseInt(n.replaceAll("px", "")),
          r = e.screenY,
          t = !0,
          a.setViewerEnabled(!1)
    },
    drag: function(e) {
      h -= e.screenY - r,
          b -= e.screenY - r,
          h %= 20,
          r = e.screenY;
      var t = (e.screenY + n) % 6;
      p.css("background-position", "50% " + t + "px")
    },
    stop: function(e) {
      s < (u += 0 < b ? 1 : -1) ? u = s : u < o && (u = o),
          g.html(u),
          a.change3DTierIndex(i + u),
          t = !1,
          a.setViewerEnabled(!0),
      f || (d = setTimeout(function() {
        g.fadeOut()
      }, 2e3))
    },
    helper: function() {
      return "<p/>"
    }
  }).hover(function() {
    f = !0,
        clearTimeout(d),
        g.show()
  }, function() {
    f = !1,
    t || (d = setTimeout(function() {
      g.fadeOut()
    }, 2e3))
  }),
  $.support.touch || v.mousewheel(function(e, t, n, a) {
    null == m && (b = 0),
        b += a,
        clearTimeout(m),
        m = setTimeout(function() {
          y(0 < b ? 1 : -1, !1, !(m = null))
        }, 200)
  }),
      a.bind("tierIndexChange", function() {
        u = a.getCurrent3DTierIndex() - i,
            g.html(u),
            clearTimeout(d),
            g.show(),
            d = setTimeout(function() {
              g.fadeOut()
            }, 2e3)
      }),
      a.bind("m.open", function() {
        var e = a.getCurrentImage();
        i = Math.floor(e.tierCount / 2),
            o = -i,
            s = e.tierCount - i - 1,
            u = a.getCurrent3DTierIndex() - i,
            g.html(u)
      }),
      d = setTimeout(function() {
        g.fadeOut()
      }, 2e3),
      this.elmt = e[0]
}, FieldArea = function(d) {
  var c, t, u = $('<div class="popover bottom measure" visibility="hidden">        \t    <div class="arrow"></div>        \t    <div class="popover-content">\t\t\t\t</div>         \t  </div>'), p = !1, n = !0, g = 500, h = null, f = SlideViewerConfig.showNavMap(), v = SlideViewerStrings.getString("Annotations.Measurement.TxtAreaUnit");
  function m() {
    if (!p || !f)
      return clearTimeout(h),
          void (h = null);
    p = !1;
    var e, t, n = "50%", a = c.shadeBounds, i = c.navigationBounds, o = d.getViewportMeasure(), s = u.find(".popover-content").html(floatRound(o.width * o.height) + v).width() / 2, r = a.x + a.width / 2, l = a.y + a.height;
    r < s ? (t = 0,
        n = r < i.x ? i.x : r) : t = r > i.x + i.width ? i.x + i.width - s - 5 : r - s - 5,
        e = l > i.y + i.height ? i.y + i.height : l,
        u.css({
          left: t,
          top: e
        }).find(".arrow").css("left", n),
        h = setTimeout(m, g)
  }
  function a(e) {
    f && !e ? clearTimeout(t) : (f = !0,
        u.show(),
        m())
  }
  function i() {
    t = setTimeout(function() {
      u.hide(),
          f = !1
    }, 2e3)
  }
  !function() {
    f || u.hide();
    var e = d.getNavigationView();
    e.bind("visibilitychanged", function(e) {
      (f = e) ? (a(!0),
          i()) : u.hide()
    }),
        e.bind("viewerchanged", function(e) {
          c = e,
              p = !0,
          null == h && m()
        }),
        $.support.touch ? $(e.elmt).bind("touchstart", function() {
          a(!1)
        }).bind("touchend", i) : $(e.elmt).hover(function() {
          a(!1)
        }, i),
        d.addEventListener("updatefinish", function() {
          n && (n = !1,
              i())
        }),
        d.addOverlay(u[0])
  }()
}, SlideMarker = function(o) {
  var s, a, i, r, l, d, c, e, u = '<div class="frame" style="display: none">                    <img class="arrow t"/>\x3c!--<div class="arrow rt"></div>--\x3e\t\t\t\t\t<img class="arrow r"/>\x3c!--<div class="arrow rb"></div>--\x3e\t\t\t\t\t<img class="arrow b"/>\x3c!--<div class="arrow lb"></div>--\x3e\t\t\t\t\t<img class="arrow l"/>\x3c!--<div class="arrow lt"></div>--\x3e\t\t\t\t\t<div class="settings hidden">\t\t\t\t\t    <div><span></span><input style="width: 30px" value="2.2"> mm</div>\t\t\t\t\t    <div><span></span><select></select> X</div>\t\t\t\t\t</div>\t\t\t\t\t<div class="frame-border"></div>\t\t\t\t\t<div class="frame-border" style="border:2px black dashed;"></div>\t\t\t\t</div>', p = o.viewport, g = !1, h = !1, t = parseFloat(SlideViewerConfig.frameArea()), f = t;
  function v() {
    var e = u.position();
    e = new SeadragonPoint(e.left + d / 2,e.top + c / 2),
        s = x(e);
    var t = o.getScale()
        , n = d / 2 / t
        , a = c / 2 / t
        , i = {
      x1: n,
      y1: a,
      x2: b.x - n,
      y2: b.y - a
    };
    s.x < i.x1 ? s.x = i.x1 : s.x > i.x2 && (s.x = i.x2),
        s.y < i.y1 ? s.y = i.y1 : s.y > i.y2 && (s.y = i.y2)
  }
  function n() {
    if (s) {
      var e = o.getShapeCanvas()
          , t = imgToCanvasPoint(s, e.getCavScale(), e.getCavOffset(), o.rotate(), e.getRotateOriginPoint(), !0)
          , n = t.x - d / 2
          , a = t.y - c / 2;
      u.css({
        left: n + "px",
        top: a + "px"
      })
    }
  }
  function m() {
    var e = Math.sqrt(f)
        , t = C(e, !0)
        , n = o.viewport.getContainerSize();
    t < n.x && t < n.y ? (r = l = e,
        d = c = C(e)) : (r = Math.sqrt(f * n.x / n.y),
        l = f / r,
        d = C(r),
        c = C(l)),
        w()
  }
  u = $(u).delegate(".arrow", "click", function(e) {
    h = !(g = !0);
    var t = this.className.replace("arrow ", "")
        , n = new SeadragonPoint(d * (-1 != t.indexOf("l") ? -1 : -1 != t.indexOf("r") ? 1 : 0),c * (-1 != t.indexOf("t") ? -1 : -1 != t.indexOf("b") ? 1 : 0));
    n = p.deltaPointsFromPixels(n, !0);
    var a = o.rotate();
    if (a) {
      var i = new SeadragonPoint(0,0);
      n = n.rotate(-a, i)
    }
    p.panTo(p.getCenter(!0).plus(n)),
        e.stopPropagation(),
    SlideViewerConfig.showAnimation() || setTimeout(function() {
      g = !1
    }, 20)
  }).bind("touchstart mousedown", function(e) {
    -1 == e.target.className.indexOf("arrow") && setTimeout(function() {
      h = !0
    }, 0)
  }),
      $(o.elmt).find("div:first").bind("touchstart mousedown", function() {
        h = !(g = !0)
      }).bind("touchend mouseup", function() {
        SlideViewerConfig.showAnimation() || (h = g = !1)
      }),
      o.addEventListener("animationfinish", function() {
        SlideViewerConfig.showAnimation() && (h = g = !1)
      });
  var b, y = u.find(".t")[0], S = u.find(".b")[0];
  function w() {
    if (!isNaN(d)) {
      u.css({
        width: d + "px",
        height: c + "px"
      });
      var e = .186 * -d + "px";
      y.style.top = e,
          S.style.bottom = e
    }
  }
  function C(e, t) {
    return 1e3 * e / a * (t ? 1 : o.getScale())
  }
  o.addEventListener("animation", function() {
    e !== o.getScale() && (e = o.getScale(),
        d = C(r),
        c = C(l),
        w(),
        g = !1),
    g && !h && v(),
        n()
  });
  var k = [2, 4, 10, 20, 40, 60, 100];
  function x(e) {
    e = e || p.getContainerSize().divide(2);
    var t = o.getShapeCanvas();
    return cavToImagePoint(e, t.getCavScale(), t.getCavOffset(), -o.rotate(), t.getRotateOriginPoint(), !0)
  }
  o.bind("m.open", function() {
    var e = o.getCurrentImage();
    b = {
      x: e.width,
      y: e.height
    },
        a = e.calibration;
    for (var t = '<option value="' + 2 * (i = e.scanObjective) + '">' + 2 * i + "</option>", n = k.length - 1; 0 <= n; n--)
      i < k[n] || (t += '<option value="' + k[n] + '">' + k[n] + "</option>");
    u.find("select").html(t),
        o.addOverlay(u[0]),
        setTimeout(function() {
          m(),
              v()
        }, 50)
  }),
      this.toggle = function(e) {
        (t = e) ? (f = e,
            s = x(),
            setTimeout(function() {
              m(),
                  n(),
                  u.show()
            }, 0)) : u.hide()
      }
      ,
  t && this.toggle(t),
      this.elmt = u[0],
      u.find("img").attr("src", "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEoAAAB/CAMAAAB/uaRdAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABj1BMVEUAAAAyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzkyNzn///+HHuviAAAAg3RSTlMAAAtHo9bv/u7TnUQKM6nwKwNg4tpTAl/pWzHf6gEHoD7rWJTJ3OC+ff0thOhaG8ZcONU7Xc82XjrQzjTU7WMyN+w50mY1zWVi0WfdoghDmswwy+NyS+FMyo1N5wQkSk/eRkjkRU5JUOVRUiPbBZNCiMRBkSXmPCL8+4YcL7vY17d2KiQm6zMAAAABYktHRIRi0FpxAAAC8klEQVRo3sWa+VsSURSG56ayZFQohTJSkUJWVqKWhqLiUpZlCzGlWdpihtG+78v9x2PsB624H3zDefT8Ae/znZdz7iyMZZVL7WhobPL5A8GdzbuUVUcpFdq9R/8pX+Ne5R2mwi2teqMi+/Z7ZSkVDejN1dbulaVitv67Otrj3lgHDmotxDqU+A+l2w57YnXqCuUtV5euzPLgPqm1VK6UNrB4XxEDqjxfLOuICcX32H0UsDj3x2wtlSt+3IzSPSeYXOrkKcDq6CVyKZXugywil1L9TYKsIGINUKzQacBKcLlCMBfnHvoic/UL/o5noK9BqkfonsyVxvMl6J6br6GzKFdLmPKVAaxAlOpxeATl4nqE85UY4NyPQBa3j8hXdpTKNZYRzBWUY1VxT7HG0T7mRqlZhb6y3DkxhnYoMUj1ONEnxxqaRKyonC/flKR7qsdpuI+kL0HW9Dk0q+cpXzHE8s1QuSCL7RH5ypFzD6/bM4K+puR8ZaMc64Kc+wl0RufI3UY9Bi4Kuu8l3ilUYc3GmMcO7P7S5dpR7j0myJWdI1BVerzCoFzWVSMqQ6HKrGvXTag8hyqzbvhNs8WSCo4plUOSbrYaXd0SI+l5irQASLfHqUx5MO2di0Ld6ck7Ne9gFZLTUPPJUIWUukuQlpCn5XtMJjkS6s4Wy+TIebpPkBYeINJDhoQyzYqRHKa7FUSyHxGkVeSJ6m5FjAQ92WKklJwnZluWtsbTNhmX2+DVx6i7ZrHJpEj5LSHZjKei2DwVkfGkmHE5UorZO7jBSea+QM4TnPHk3LYYh+cTdeUsinUnR4LdyZGWGdIa7I4xvibmqSBEstQT9ERcIkjW02eAFHnOfEeQ7hHKZFkv/FIk66WI8fUqyXhyy/RveOkV/eWGIVWJzmRy5YVU+Rf0RLKGK6xNhPfkVvi1UKbyDr4JCpHcp723dc7TBite2HQ2+Lve1fMlkHo/n/+wDvpof/pcB8mFLX7p/vot8v3Hz1/ES8l/6zfQ5cL+5/PVNAAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxNS0wNy0zMFQwMDoyNTozOCswODowMO7Fay4AAAAldEVYdGRhdGU6bW9kaWZ5ADIwMTUtMDctMzBUMDA6MjU6MzgrMDg6MDCfmNOSAAAATnRFWHRzb2Z0d2FyZQBJbWFnZU1hZ2ljayA2LjguOC0xMCBRMTYgeDg2XzY0IDIwMTUtMDctMTkgaHR0cDovL3d3dy5pbWFnZW1hZ2ljay5vcmcFDJw1AAAAGHRFWHRUaHVtYjo6RG9jdW1lbnQ6OlBhZ2VzADGn/7svAAAAGXRFWHRUaHVtYjo6SW1hZ2U6OkhlaWdodAAxMDY4ivxRkgAAABd0RVh0VGh1bWI6OkltYWdlOjpXaWR0aAA2MjI1F+5GAAAAGXRFWHRUaHVtYjo6TWltZXR5cGUAaW1hZ2UvcG5nP7JWTgAAABd0RVh0VGh1bWI6Ok1UaW1lADE0MzgxODcxMzjTVg96AAAAE3RFWHRUaHVtYjo6U2l6ZQAxMi40S0JCUMf85QAAAFp0RVh0VGh1bWI6OlVSSQBmaWxlOi8vL2hvbWUvd3d3cm9vdC93d3cuZWFzeWljb24ubmV0L2Nkbi1pbWcuZWFzeWljb24uY24vc3JjLzExOTA1LzExOTA1NzgucG5n+bg+2gAAAABJRU5ErkJggg==")
}, Exchange = function(i) {
  var o, t = $.query.get("room"), s = !1, r = "", n = {
    zh: {
      start: "同步浏览开始",
      pause: "同步浏览暂停",
      notStart: "同步浏览未开始",
      closed: "同步浏览结束"
    },
    en: {
      start: "Sync Browse Start",
      pause: "Sync Browse Pause",
      notStart: "Sync Browse Not Start",
      closed: "Sync Browse Over"
    }
  };
  t && u(t);
  var l, a = 0, d = !1, c = i.getCurrentSlide().id;
  function u(n) {
    var a = !0;
    i.provider.subscribe("/topic/Tasks/" + n + "/Exchange/Status", function(e) {
      var t = JSON.parse(e.body);
      if (r = t.ownerName,
          s = userId !== t.ownerId,
      o && o(t),
      d != t.duplex && (d = t.duplex,
      s || (d ? p(n) : i.provider.unsubscribe("/topic/Tasks/" + n + "/Exchange/Action"))),
          s) {
        if ("FINISHED" == t.status)
          return i.provider.unsubscribe("/topic/Tasks/" + n + "/Exchange/Status"),
              i.provider.unsubscribe("/topic/Tasks/" + n + "/Exchange/Action"),
              l = null,
              void v("closed");
        if ("STARTED" == t.status && t.status !== l ? v("start") : "PAUSE" == t.status && t.status !== l ? v("pause") : "BOOTSUCCESS" == t.status && t.status !== l && v("notStart"),
            l = t.status,
        i.shadowId && t.slideId && t.slideId != i.shadowId)
          return void (location.href = i.provider.getWebSiteUrl() + "/Slides/" + t.slideId + "?user=any&room=" + n);
        a && (a = !1,
            p(n),
            i.trigger("SubAnnotation", t.ownerId, t.ownerName, t.ownerAvatar))
      }
    })
  }
  function p(e) {
    i.provider.subscribe("/topic/Tasks/" + e + "/Exchange/Action", function(e) {
      if (f && !(0 < a)) {
        a = -1;
        var t = JSON.parse(e.body);
        i.zoomByRatio(.999999999),
            setTimeout(function() {
              i.viewport.fitBounds(new SeadragonRect(t.x,t.y,t.width,t.height))
            }, 200)
      }
    })
  }
  var g, h = null, f = !0;
  function e() {
    if (h = null,
    0 <= a && t) {
      a = 1;
      var e = i.viewport.getBounds();
      e.equals(g) || (g = e,
          i.provider.send("/Tasks/" + t + "/Exchange/" + c + "/Action", JSON.stringify(e)))
    }
  }
  function v(e) {
    s && i.showMessage((r || "") + MedLang.getString(e, n))
  }
  this.setTaskId = function(e) {
    t !== e && (u(e),
        t = e,
        f = !1)
  }
      ,
      this.start = function(e) {
        f = !0,
            v("start")
      }
      ,
      this.pause = function() {
        f = !1,
            v("pause")
      }
      ,
      this.stop = function() {
        f = !1,
            t = null
      }
      ,
      this.registerStatus = function(e) {
        o = e
      }
      ,
      i.bind("animation", function() {
        (f || s && d) && null === h && (h = setTimeout(e, 200))
      }),
      i.bind("updatefinish", function() {
        null != h && (clearTimeout(h),
            e()),
            a = 0,
            console.log("updatefinish")
      })
}, Scale = function(s) {
  var r = 1280
      , l = SlideViewerConfig.showScale();
  this.enable = function(e) {
    l = e,
        SlideViewerConfig.showScale(e),
        s.getShapeCanvas().renderCommonCanvas()
  }
      ,
      s.getShapeCanvas().bind("renderComCav", function(e, t, n) {
        if (l) {
          for (var a, i = s.getCurrentImage().calibration / s.getScale(); a = r / i; )
            if (100 < a)
              r *= .5;
            else {
              if (!(a < 50))
                break;
              r *= 2
            }
          var o;
          e.save(),
              e.translate(t / 2, n - 10),
              e.textAlign = "center",
              o = 1e3 < r ? parseInt(r / 10) / 100 + "mm" : r + "um",
              e.strokeText(o, 0, -5),
              e.lineWidth = 3,
              e.beginPath(),
              e.moveTo(-a / 2, -10),
              e.lineTo(-a / 2, 0),
              e.lineTo(a / 2, 0),
              e.lineTo(a / 2, -10),
              e.stroke(),
              e.restore()
        }
      })
}, SnapshotThumbnail = function(i, o, s, e) {
  var n = '<li class="snapshot">\t\t<a href="javascript:void(0)"><div class="thumbnail">\t\t\t<div class="btn-group pull-right tools">      \t\t\t<span class="btn btn-xs btn-primary share">      \t\t\t  <i class="glyphicon glyphicon-share-alt"></i>      \t\t\t</span>        \t\t<span class="btn btn-xs btn-primary download">      \t\t\t  <i class="glyphicon glyphicon-download-alt"></i>      \t\t\t</span>      \t\t\t<span class="btn btn-xs btn-danger delete">      \t\t\t  <i class="glyphicon glyphicon-remove"></i>      \t\t\t</span>      \t\t</div>        \t<img>        \t<div class="onelintext desc" style="border-top:1px solid #DDD;margin: 4px -4px -4px;width:101px;height:15px;color: #777;font-size: 65%;"></div>            </div></a>            <div class="deleteAlert"><span class="btn btn-sm btn-danger" data-lang="Buttons.Delete">Delete</span></div>        </li>';
  n = $(n);
  var t, a, r = '<div id="shade_capture_dialog" class="modal fade" style="overflow:auto"><div class="modal-dialog" style="margin-top:10%"><div class="modal-content">            <div class="modal-header">              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>              <h3 data-lang="title"></h3>            </div>            <div class="modal-body">              \t<label data-lang="html"></label>\t\t\t\t<div class="share-content-wrap">\t\t\t\t\t<iframe class="share-content"></iframe>\t\t\t\t</div>\t\t\t\t<div class="share-sns-label">\t\t\t\t\t<label style="margin-top:10px" data-lang="url"></label>\t\t\t\t</div>\t\t\t\t<div class="clearfix"></div>\t\t\t\t\t<div class="share-url-wrap">\t\t\t\t\t<input class="form-control">\t\t\t\t\t</div>\t\t\t\t\t<div class="share-sns-label hide">\t\t\t\t\t<label>\t社交网络\t:</label>\t\t\t\t</div>\t        </div>        </div></div></div>', l = this, d = $.query.get("case"), c = i.getCurrentSlide().id !== o;
  this.snapshot = s,
      this.id = s.id.toLowerCase(),
      this.elmt = n[0],
      function() {
        if ($("[data-lang]", n).html(function() {
          return MMDSSlideViewerStrings.getString($(this).attr("data-lang"))
        }),
            n.delegate("span", "click", function(e) {
              var t = $(this);
              if (t.hasClass("delete")) {
                a = 2;
                var n = $(this).closest(".snapshot");
                n.find("div.tools").hide(),
                    n.find("div.deleteAlert").fadeIn("fast")
              } else
                t.hasClass("download") ? function(e, t) {
                  var n = $("#downloader");
                  0 == n.length && (n = $("<iframe></iframe>").hide().attr("id", "downloader").appendTo("body"));
                  "function" == typeof t && n.load(t);
                  n.attr("src", e)
                }(i.provider.getSnapshotUrl(o, l.id) + "&isSave=1") : t.hasClass("btn-danger") ? i.provider.deleteSnapshot(o, l.id, f) : t.hasClass("share") && function() {
                  var e = $("#shade_capture_dialog");
                  0 == e.length && (e = MedLang.interpretElem($(r), g).appendTo("body")).find("button").bind("click", function() {});
                  e.modal("show");
                  i.getCurrentImage().width,
                      s.scale;
                  var t = i.provider.getSnapshotUrl(i.getCurrentSlide().id, s.id);
                  t.startsWith("http") || t.startsWith("//") || (t = location.protocol + "//" + location.host + t);
                  e.find("input").val(t),
                      setTimeout(function() {
                        e.find("input").select()
                      }, 200);
                  var n = ["<div style='padding: 20px 0;'><div>", s.desc || s.Comment, "</div><a href='", t, "' target='_blank'><img style='max-width: 100%;' src='", location.protocol, "//", location.host, i.provider.getSnapshotUrl(o, l.id), "&width=512", "'></a></div>"].join("")
                      , a = e.find("iframe");
                  window.clipboardData ? a.contents().find("html").html(n) : a.attr("src", "data:text/html;charset=utf-8," + encodeURIComponent(n))
                }();
              return !1
            }),
            n.bind("mouseenter", function() {
              clearTimeout(t),
              a || (a = 1,
                  $(this).find("div.tools").show())
            }).bind("mouseleave", function() {
              var e = $(this);
              t = setTimeout(function() {
                1 == a ? e.find("div.tools").hide() : 2 == a && e.find("div.deleteAlert").fadeOut(),
                    a = 0
              }, 1e3)
            }),
            n.find("img").attr("src", i.provider.getSnapshotUrl(o, l.id) + "&width=93"),
            n.find(".desc").text(s.desc).attr("title", s.desc),
            c) {
          var e = s.url;
          e += -1 == e.indexOf("?") ? "?" : "&",
              e += $.query.empty().set("i", s.imageId).set("t", s.tier).set("x", s.x).set("y", s.y).set("w", s.width).set("h", s.height).set("s", s.scale).set("rotation", s.rotation).toString().substring(1),
              e += "#" + l.id,
              s.url = e,
              n.find("a").attr("href", e)
        } else {
          i.getCurrentSlide();
          n.bind("click", function() {
            if (i.trigger("EditSnapshotDesc", s, function() {
              n.find(".desc").text(s.desc).attr("title", s.desc)
            }),
            i.getCurrentImage().id === s.imageId)
              h();
            else {
              if ("f" == s.imageId)
                i.openImage();
              else
                for (var e = 0, t = i.getCurrentSlide().ROIs; e < t.length; e++)
                  if (t[e].id == s.imageId) {
                    i.openImage(t[e]);
                    break
                  }
              setTimeout(h, 0)
            }
          })
        }
      }();
  var u, p, g = {
    zh: {
      title: "分享",
      html: "复制截图内容：",
      url: "截图地址："
    },
    en: {
      title: "Share",
      html: "Copy Content",
      url: "URL："
    }
  };
  function h() {
    var e = s.width / s.scale
        , t = s.height / s.scale
        , n = s.x / s.scale
        , a = s.y / s.scale;
    i.broadcast({
      type: "mv-panTo",
      x: n,
      y: a,
      w: e,
      h: t,
      rotation: s.rotation,
      slideId: o
    }, -1)
  }
  function f(e) {
    e.success ? function(e, t) {
      var n = {
        type: "DeleteSnapshot",
        slideId: e,
        id: t.toLowerCase(),
        case: d
      };
      i.provider.postMessage(JSON.stringify(n)),
          i.broadcast(n)
    }(o, l.id) : (i.showMessage(MMDSSlideViewerStrings.getString("Messages.DeleteSnapshotFailed")),
        ErrorOutput("DeleteSnapshot", e))
  }
  this.clone = function() {
    return u || (u = n.clone(!0),
        n = n.add(u[0])),
        u
  }
      ,
      this.delete = function() {
        n.fadeOut(function() {
          n.remove()
        })
      }
      ,
      this.highlight = function() {
        clearTimeout(p),
            p = setTimeout(function() {
              n.find(".thumbnail").css({
                "border-color": "#0088cc"
              }).animate({
                "border-width": "2px"
              }, 500).animate({
                "border-width": "1px",
                "border-color": "#ddd"
              }, 500)
            }, 10)
      }
}, ROICapture = function(o) {
  var t, s = '<div style="width: 100%;height: 100%;display: none">                    <div class="drsElement">                        <div class="border border-top"></div>                        <div class="border border-bottom"></div>                        <div class="border border-left"></div>                        <div class="border border-right"></div>                        <div class="drsMoveHandle"></div>                        <div class="back top"></div>                        <div class="back bottom"></div>                        <div class="back left"></div>                        <div class="back right"></div>                        <div class="tools hidden">                            <button class="search">Search</button>                        </div>                        <button type="button" class="close">&times;</button>                    </div>              </div>';
  s = $(s).bind("mousedown", function(e) {
    -1 == e.target.className.indexOf("back") && e.stopPropagation()
  }),
      this.setToggleCallback = function(e) {
        t = e
      }
  ;
  var e = this;
  s.delegate(".search", "click", function() {
    var e = s.position()
        , t = s.find(".zone")
        , n = t.width()
        , a = t.height()
        , i = (e = o.viewport.pointFromPixel(new SeadragonPoint(e.left,e.top), !0),
        o.viewport.deltaPointsFromPixels(new SeadragonPoint(n,a), !0));
    o.provider.searchFocusArea({
      x: e.x,
      y: e.y,
      w: i.x,
      h: i.y,
      t: o.getCurrent3DTierIndex(),
      i: o.getCurrentImage().id,
      wpx: n,
      hpx: a
    })
  }).delegate(".close", "click", function() {
    e.show(!1)
  });
  var n = new DragResize("dragresize",{
    minWidth: 256,
    minHeight: 256
  });
  n.isElement = function(e) {
    if (e.className && -1 < e.className.indexOf("drsElement"))
      return !0
  }
      ,
      n.isHandle = function(e) {
        if (e.className && -1 < e.className.indexOf("drsMoveHandle"))
          return !0
      }
      ,
      n.apply(s[0]),
      $(o.elmt).bind("mouseup", function(e) {
        n.mouseUp(e)
      }),
      o.Med_ROI = this,
      o.bind("m.open", function() {
        o.addOverlay(s[0])
      });
  var a = !1
      , i = !0;
  this.show = function(e) {
    if (null == e)
      return a;
    i && (i = !1,
        s.find(">div").css({
          left: parseInt(s.width() / 2 - 150),
          top: parseInt(s.height() / 2 - 150)
        })),
        e ? s.show() : s.hide(),
        a = e,
    t && t(e)
  }
      ,
      this.getRect = function() {
        if (a) {
          var e = s.find(">div")
              , t = e.position();
          return new SeadragonRect(t.left,t.top,e.width(),e.height())
        }
      }
}, SlideCapture_Base = function(v, e) {
  var l = v.capturer = this
      , d = [[]]
      , c = 0
      , o = location.hash && location.hash.substring(1);
  this.elmt;
  var m, b, r, u, p, g = '<div class="modal fade" style="overflow:auto"><div class="modal-dialog" style="margin-top:10%"><div class="modal-content">        <div class="modal-header">          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>          <h3 data-lang="Labels.CaptureDescribe"><span></span></h3>        </div>        <div class="modal-body">          <textarea id="snapshotDesc" rows="5" style="width:100%"></textarea>        </div>        <div class="modal-footer">            <select style="padding: 5px;float: left;" disabled>                <option value="" data-lang="Labels.RecentCaptureDesc"></option>            </select>        <button id="btnSnapshotSubmit" class="btn btn-primary" data-lang="Buttons.Ok">确定</button>        <button class="btn btn-default" data-dismiss="modal" aria-hidden="true" data-lang="Buttons.Cancel">取消</button>        </div>    </div></div></div>', h = !1, n = !1, y = 0, S = v.getCurrentSlide().id, f = $.query.get("case"), w = !!window.Advanced_mpcc;
  function a() {
    if (!n) {
      n = !0,
          (g = $(g)).find("[data-lang]").html(function() {
            var e = $(this).attr("data-lang");
            return MMDSSlideViewerStrings.getString(e) || SlideViewerStrings.getString(e)
          }),
          g.modal({
            show: !1,
            backdrop: "static"
          }).on("shown.bs.modal", function() {
            v.setViewerEnabled(!1),
                v.isDisabled = !0
          }).on("hidden.bs.modal", function() {
            v.setViewerEnabled(!0),
                v.isDisabled = !1,
            p && (g.find("#snapshotDesc").val(""),
                p = null)
          }).appendTo("body").find("#btnSnapshotSubmit").on("click", function() {
            var t = g.find("#snapshotDesc").val();
            if (p) {
              var n = p;
              v.provider.updateCaptureDesc(n.id, t, function(e) {
                e.success ? (n.desc = t,
                    v.broadcast({
                      type: "UpdateSnapshotDesc",
                      slideId: S,
                      id: n.id,
                      desc: t,
                      case: f
                    }),
                u && u()) : ErrorOutput("UpdateCaptureDesc", e)
              })
            } else if (h) {
              var a = $.Deferred();
              y++,
                  v.provider.updateCaptureDesc(m, t, function(e) {
                    y--,
                        e.success ? a.resolve(e) : (a.reject(e),
                            v.showMessage(MMDSSlideViewerStrings.getString("Messages.CaptureFailed")),
                            ErrorOutput("UpdateCaptureDesc", e))
                  }, !0),
                  r = a.promise(),
                  $.when(b, r).done(function(e, t) {
                    e.snapshot.Comment = t.desc,
                        C(e)
                  })
            } else
              l.capture(t);
            g.modal("hide"),
                function(e) {
                  if ("" == e)
                    return;
                  0 == s.length && o.removeAttr("disabled");
                  s.unshift(e);
                  for (var t = o.find("option"), n = 1; n < s.length; n++)
                    if (s[n] == e)
                      return s.splice(n, 1),
                          1 == s.length ? o.append(t.eq(n - 1 + i)) : t.eq(n - 1 + i).insertBefore(t.eq(i));
                  var a = $("<option></option>");
                  a.attr("value", e).attr("title", e).html(20 < e.length ? e.substring(0, 19) + "..." : e),
                      1 == s.length ? o.append(a) : a.insertBefore(t.eq(i))
                }(t)
          });
      var i = 1
          , o = g.find("select").bind("change", function() {
        "" != this.value && g.find("#snapshotDesc").val(this.value)
      })
          , s = []
    }
  }
  function C(e) {
    s(e.snapshot),
    n && g.find("#snapshotDesc").val("");
    var t = e.snapshot;
    !function(e, t, n, a, i, o, s, r, l, d, c) {
      var u = {
        type: "AddSnapshot",
        slideId: e,
        id: t,
        desc: n,
        url: location.protocol + "//" + location.host + apiPath,
        tier: a || 0,
        imageId: i,
        x: o,
        y: s,
        width: r,
        height: l,
        rotation: c,
        scale: d,
        scanObjective: v.getCurrentImage().scanObjective,
        case: f
      };
      v.broadcast(u)
    }(e.slideId, t.id, t.desc, t.tier, t.imageId, t.x, t.y, t.width, t.height, t.scale, t.rotation)
  }
  function s(n) {
    function e(e, t) {
      void 0 !== n[e] && (n[t] = n[e])
    }
    return e("Id", "id"),
        e("i", "imageId"),
        e("w", "width"),
        e("h", "height"),
        e("s", "scale"),
        e("t", "tier"),
        e("Comment", "desc"),
        n
  }
  v.bind("EditSnapshotDesc", function(e, t) {
    a(),
        g.find("#snapshotDesc").val(e.desc),
        u = t,
        p = e,
        g.modal("show")
  }),
      this.showModal = function() {
        a(),
            g.modal("show")
      }
      ,
      this.capture = function(e, t) {
        var n = {
          desc: e,
          rotation: v.rotate() || 0,
          bgc: v.getCurrentImage().backgroundColor
        }
            , a = $.Deferred();
        if (b = a.promise(),
            t ? m = n.nextOperateId = (new Date).getTime() + "_" + Math.random().toString(16).substring(2) : (b.done(C),
                v.showMessage(MMDSSlideViewerStrings.getString("Messages.Capturing"), 1e3)),
            y++,
        v.Med_ROI && v.Med_ROI.show()) {
          var i = v.Med_ROI.getRect()
              , o = v.getShapeCanvas()
              , s = o.hasAnnotationOnView(new Rect(i.x,i.y,i.width,i.height))
              , r = v.viewport.getContainerSize()
              , l = new SeadragonPoint(r.x / 2,r.y / 2);
          i = i.rotate(-v.rotate(), l);
          var d = v.getScale()
              , c = v.getCurrentImage()
              , u = v.viewport.getBounds()
              , p = c.width * d
              , g = new SeadragonRect(p * u.x + i.x,p * u.y + i.y,i.width,i.height)
              , h = {
            slideId: S,
            image: c,
            bounds: g,
            scale: v.getScale(),
            tierIndex: v.getCurrent3DTierIndex(),
            is3DImage: v.is3DImage(),
            hasAnnotation: s,
            description: n,
            isROI: !0
          };
          o && (h.activeShape = o.getActiveShape()),
              v.provider.capture(h, f),
              v.Med_ROI.show(!1)
        } else
          v.capture(n, f);
        function f(e) {
          y--,
              e.success ? a.resolve(e) : (401 == e.statusCode ? v.showMessage(MMDSSlideViewerStrings.getString("Messages.SessionExpire")) : (v.showMessage(MMDSSlideViewerStrings.getString("Messages.CaptureFailed")),
                  v.provider.addLog("Capture", ["[User:", UserInfo.Name, ";RequestId:", e.requestId, ";ErrorType:", e.errorType, ";ErrorMessage:", e.errorMessage, ";StatusCode:", e.statusCode, "]"].join("")),
                  ErrorOutput("CaptureFailed", e)),
                  a.reject(e))
        }
      }
      ,
      v.bind("AddSnapshot", function(e) {
        if (f && f == e.case || e.slideId == S) {
          var t = new SnapshotThumbnail(v,e.slideId,e)
              , n = c;
          if (e.slideId !== S)
            for (var a = 0; a < d.length; a++)
              if (d[a].slideId == e.slideId) {
                n = a;
                break
              }
          d[n].push(t),
              l.updateUI(!0)
        }
      }),
      this.getSnapshotList = function(e, t, n) {
        var a = [];
        e && (a.slideId = e),
        n && (a.url = n),
            d.splice(t, 0, a),
            c++,
            v.provider.getSnapshotList(function(e) {
              !function(e, t) {
                for (var n = d[e.isRelevant ? t : c], a = 0, i = e.snapshots; a < i.length; a++)
                  i[a].url = n.url,
                      n.push(new SnapshotThumbnail(v,e.slideId,s(i[a])));
                0 < e.snapshots.length && (l.updateUI(o),
                    v.trigger("ListCapture"))
              }(e, t)
            }, e)
      }
      ,
      v.bind("DeleteSnapshot", function(e) {
        (f && f == e.case || S == e.slideId) && function(e) {
          for (var t = 0; t < d.length; t++)
            for (var n = d[t], a = 0; a < n.length; a++)
              if (n[a].id === e)
                return n[a].delete(),
                    n.splice(a, 1)
        }(e.id)
      });
  var t = SlideViewerConfig.hotKey();
  this.hotKey = function(e) {
    if (isNaN(parseInt(e)))
      return t;
    t = e,
        SlideViewerConfig.hotKey(e)
  }
  ;
  var i = SlideViewerConfig.enableMenu && e;
  $("body").on("keyup", function(e) {
    i && e.keyCode == t && l.actionCaptureBtn()
  });
  var k = 0 !== $.query.get("comment");
  this.actionCaptureBtn = function() {
    k ? ((h = !SlideViewerConfig.isDSM) && l.capture("", !0),
        l.showModal()) : (h = !1,
        l.capture(""))
  }
      ,
      v.bind("Capture", l.actionCaptureBtn),
      this.getContainer = function() {}
      ,
      this.scrollHeight = function(e) {}
      ,
      this.updateUI = function(e, t) {
        var n = !0;
        t || (t = l.getContainer(),
            n = !1),
            t.children().detach();
        for (var a = 0; a < d.length; a++)
          if (!w || n || a == c)
            for (var i = d[a], o = 0; o < i.length; o++) {
              var s = i[o]
                  , r = n ? s.clone() : s.elmt;
              t.append(r),
              (!0 === e && a == c && o == i.length - 1 || e === s.id) && (t[0].scrollTop = t[0].scrollHeight,
                  l.scrollHeight(t[0].scrollHeight),
                  s.highlight(),
                  e = !1)
            }
      }
      ,
      $(window).bind("beforeunload", function() {
        0 < y && (event.returnValue = MMDSSlideViewerStrings.getString("Labels.CapturingWarn"))
      });
  function x(e) {
    if (e.data) {
      var t = "object" == typeof e.data ? e.data : JSON.parse(e.data);
      "DeleteSnapshot" == t.t ? v.broadcast({
        type: "DeleteSnapshot",
        slideId: S,
        id: t.imageId.toLowerCase(),
        case: f
      }, -1) : "DoSnapshot" == t.type && l.actionCaptureBtn()
    }
  }
  window.addEventListener ? window.addEventListener("message", x, !1) : window.attachEvent && window.attachEvent("onmessage", x),
      l.getSnapshotList(),
      v.bind("loadedRelevantSlide", function(e) {
        if (1 == $.query.get("rc"))
          for (var t = 0; t < e.length; t++)
            e[t].isCurrent || l.getSnapshotList(e[t].id, t, e[t].url)
      })
}, SlideCapture = function(n, e) {
  SlideCapture_Base.apply(this, [n, e]);
  var a, i = this;
  this.footer,
      this.name = MMDSSlideViewerStrings.getString("Menus.Capture"),
      function() {
        i.elmt = a = $('<ul class="snapshots"></ul>');
        var e = $('<div class="text-right footer-wrap">        <label id="roiCapture" class="checkbox hide" style="text-align: left;"><input type="checkbox"><span data-lang1="Labels.private_ann">ROI</span></label>        <span class="hotKey-wrap"><span data-lang="Labels.Hot_Key"></span>：        <select>        <option value="113">F2</option>        <option value="115">F4</option>        <option value="118">F7</option>        <option value="119">F8</option>        <option value="120">F9</option>        <option value="121">F10</option>        </select></span>        <a class="btn btn-primary" id="lnkCapture" data-lang="Buttons.Capture"></a>        </div>');
        if (e.find("[data-lang]").html(function() {
          return MMDSSlideViewerStrings.getString($(this).attr("data-lang"))
        }),
            e.find("#lnkCapture").on("click", function() {
              i.actionCaptureBtn()
            }),
            e.find("select").bind("change", function() {
              i.hotKey(this.value)
            }).val(i.hotKey()),
            n.Med_ROI) {
          var t = e.find("input:checkbox").bind("click", function() {
            n.Med_ROI.show(this.checked)
          })[0];
          n.Med_ROI.setToggleCallback(function(e) {
            t.checked = e
          })
        }
        SlideViewerConfig.roiCapture && e.find("#roiCapture").removeClass("hide"),
            i.footer = e[0]
      }(),
      this.getContainer = function() {
        return a
      }
      ,
      this.scrollHeight = function(e) {
        $(this).trigger("append", e)
      }
}, SlideSnapshotForPhone = function(t) {
  var n = $('<div class="snapshot-phone">    <h3 data-lang="Labels.CaptureDescribe"></h3>                <textarea id="snapshotDescription" rows="4"></textarea>              <button id="btnSnapshotSubmit" class="btn btn-primary" data-lang="Buttons.Ok">确定</button>              <button class="btn btn-default" data-lang="Buttons.Cancel">取消</button>              </div>')
      , e = '<div class="btn btn-primary snapshot-phone-btn" data-lang="Menus.Capture">截图</div>';
  function a(e) {
    e.success ? $("#snapshotDescription", dialog).val("") : 401 == e.statusCode ? t.showMessage(MMDSSlideViewerStrings.getString("Messages.SessionExpire")) : (t.showMessage(MMDSSlideViewerStrings.getString("Messages.CaptureFailed")),
    e.statusCode < 520 && t.provider.addLog("Capture", ["[User:", UserInfo.Name, ";RequestId:", e.requestId, ";ErrorType:", e.errorType, ";ErrorMessage:", e.errorMessage, ";StatusCode:", e.statusCode, "]"].join("")),
        ErrorOutput("CaptureFailed", e))
  }
  $("[data-lang]", n).html(function() {
    var e = SlideViewerStrings.getString($(this).attr("data-lang"));
    return e = e || MMDSSlideViewerStrings.getString($(this).attr("data-lang"))
  }),
      n.hide().appendTo("body").delegate("button", "click", function(e) {
        "btnSnapshotSubmit" == this.id && (t.capture($("#snapshotDescription", n).val(), a),
            t.showMessage(MMDSSlideViewerStrings.getString("Messages.Capturing"))),
            n.fadeOut(),
            t.isDisabled = !1,
            t.setViewerEnabled(!0)
      }),
      (e = $(e).bind("click", function() {
        t.isDisabled = !0,
            n.fadeIn(),
            t.setViewerEnabled(!1)
      })).html(function() {
        return MMDSSlideViewerStrings.getString($(this).attr("data-lang"))
      }),
      t.addControl(e[0], Seadragon.ControlAnchor.TOP_LEFT)
}, RectangleMarquee, PolygonMarquee, CurveRoundedMarquee;
function MarqueeFactory(e) {
  var t = this.prototype;
  t.isROI = function() {
    return !this.isDemo
  }
      ,
      t.showMeasurement = function() {}
  ;
  var n = t.demo;
  t.demo = function(e) {
    return n.call(this)
  }
  ;
  var a = t.draw;
  t.draw = function() {
    var e = this.getContext();
    e.setLineDash && e.setLineDash([10, 8]),
        a.call(this)
  }
  ;
  var i = t.active;
  t.active = function() {
    var e = this.getContext();
    e.setLineDash && e.setLineDash([]),
        i.call(this)
  }
      ,
      AnnotationType.AddType(e, e),
      CustomShapeTypes.AddAnnotationType(e, this)
}
SlideProvider.prototype.getAdvanced = function(e, t) {
  this.getRequest("Advanced?app=" + e, !0, {}, function(e, t) {
    e.conf = t
  }, t)
}
    ,
    SlideProvider.prototype.updateAdvanced = function(e, t, n) {
      this.updateRequest("Advanced?app=" + e, "PUT", JSON.stringify(t), !0, n)
    }
    ,
    (RectangleMarquee = function(e, t, n, a, i) {
          Rectangle.apply(this, [e, t, n, a, i])
        }
    ).prototype = new Rectangle,
    MarqueeFactory.call(RectangleMarquee, "RectangleMarquee"),
    (PolygonMarquee = function(e, t, n, a, i) {
          Polygon.apply(this, [e, t, n, a, i])
        }
    ).prototype = new Polygon,
    MarqueeFactory.call(PolygonMarquee, "PolygonMarquee"),
    (CurveRoundedMarquee = function(e, t, n, a, i, o, s, r) {
          CurveRounded.apply(this, [e, t, n, a, i, o, s, r])
        }
    ).prototype = new CurveRounded,
    MarqueeFactory.call(CurveRoundedMarquee, "CurveRoundedMarquee"),
    ShapeCanvas.prototype.checkShapeOnContainer = function(e, t) {
      return "VoiceAnnotation" != e.type
    }
;
var Watermark = function(a) {
  a.provider.getWatermark(function(n) {
    if (n) {
      var o = 256
          , s = function() {
        var t = document.createElement("canvas");
        t.getContext("2d");
        function e() {
          var e = a.viewport.getContainerSize();
          t.width = e.x,
              t.height = e.y
        }
        return t.style.position = "absolute",
            e(),
            a.insertOverlay(t, 0),
            a.addEventListener("resize", e),
            t
      }()
          , r = s.getContext("2d");
      a.addEventListener("animation", u),
          a.addEventListener("rotate", u);
      var l = function() {
        var e = document.createElement("canvas");
        e.width = o,
            e.height = o;
        var t = e.getContext("2d");
        return t.textAlign = "center",
            t.font = "24px microsoft yahei",
            t.fillStyle = "white",
            t.globalAlpha = .4,
            t.fillText(n, o / 2, o / 2),
            t.strokeText(n, o / 2, o / 2),
            e
      }()
          , d = a.getShapeCanvas()
          , c = l.width
    }
    function u() {
      var e = d.getCavScale()
          , t = c * e;
      if (t < o)
        return c *= 2,
            void u();
      if (2 * o < t)
        return c /= 2,
            void u();
      r.clearRect(0, 0, s.width, s.height);
      for (var n = d.getCavOffset(), a = n.x % t - t; a < s.width; a += t)
        for (var i = n.y % t - t; i < s.height; i += t)
          r.drawImage(l, a, i, t, t)
    }
  })
}, CurveEditor;
(CurveEditor = function(e, t, n, a, i, o) {
      Curve.apply(this, [e, t, n, a, i, o])
    }
).prototype = new Curve,
    CurveEditor.prototype.active = function() {}
    ,
    MarqueeFactory.call(CurveEditor, "CurveEditor");
var AnnotationEditor = function(l) {
  var S, t = this, d = !1, w = l.getShapeCanvas(), c = {
    CurveEditor: {
      support: [AnnotationType.CurveRounded, AnnotationType.Curve, AnnotationType.CurveRoundedMarquee, AnnotationType.Polygon, AnnotationType.PolygonMarquee],
      init: n
    },
    PointMinus: {
      support: [AnnotationType.CurveRounded, AnnotationType.Curve, AnnotationType.CurveRoundedMarquee, AnnotationType.Polygon, AnnotationType.PolygonMarquee],
      init: function() {
        l.getShapeCanvas().setSelectedEnable(!1)
      }
    }
  }, u = {
    zh: {
      delEdit: "该标注正被修剪",
      select: "请先选中标注",
      nosupport: "该标注不支持修剪",
      noeditable: "无可修剪标注",
      CurveEditor: {
        enable: "修改曲线"
      },
      PointMinus: {
        enable: "删除曲线顶点"
      }
    },
    en: {
      delEdit: "The annotation is editing",
      select: "Please selected annotation",
      nosupport: "The annotation does not support",
      noeditable: "There isn't editable annotation",
      CurveEditor: {
        enable: "Modify the curve"
      },
      PointMinus: {
        enable: "Delete the curve peak"
      }
    }
  };
  function r(e) {
    switch (S.type) {
      case AnnotationType.Curve:
      case AnnotationType.CurveRounded:
      case AnnotationType.CurveRoundedMarquee:
        var t = new Point(e.x,e.y)
            , n = (S.rePoint.x - S.rsPoint.x) / S.initRect.width
            , a = (S.rePoint.y - S.rsPoint.y) / S.initRect.height;
        t.x = (e.x - S.initRect.x) * n + S.rsPoint.x,
            t.y = (e.y - S.initRect.y) * a + S.rsPoint.y,
            e = t
    }
    return e
  }
  function p(e) {
    for (var t = w.getAnnotations(), n = 0; n < t.length; n++) {
      var a = t[n];
      a == S ? a.visible = !0 : e ? a.visible = a.visible_bak : (null == a.visible_bak && (a.visible_bak = a.visible),
          a.visible = !1)
    }
    w.setShowInfoEnable(e),
        w.showImageShapes(),
        l.trigger("shape:visible", e)
  }
  function e(e) {
    "PointMinus" === d && (l.trigger("beforeMinusPoint", S),
        function(e) {
      console.log('删除点2')
          var t = S.cavPoints;
          if (S.type == AnnotationType.Curve) {
            if (2 == t.length)
              return
          } else if (3 == t.length)
            return;
          if (!S.isHitMyArea(e, S.width / 2 + ShapeDefaultConfig.thumbHitRadius))
            return;
          e = function(e) {
            switch (S.type) {
              case AnnotationType.Curve:
              case AnnotationType.CurveRounded:
              case AnnotationType.CurveRoundedMarquee:
                e = rotatePoint(e, -S.rotateRadian, S.rotateOriginPoint)
            }
            return e
          }(e);
          for (var n, a, i = !1, o = 0; o < t.length; o++) {
            var s = t[o];
            if (!i)
              if (S.clickInThumb(e, r(s)).isIn) {
                i = !0,
                    t.splice(o, 1),
                    S.points.splice(o, 1),
                    o--;
                continue
              }
            0 == o ? (n = new Point(s.x,s.y),
                a = new Point(s.x,s.y)) : k(n, a, s)
          }
          if (S.isSelected = !1,
              !i)
            return;
          S.isMeasurementChanged = !0,
              S.startPoint = S.toImagePoint(r(n)),
              S.endPoint = S.toImagePoint(r(a)),
          S.initRect && (S.initRect = new Rect(n.x,n.y,a.x - n.x,a.y - n.y));
          w.showImageShapes(),
              S.action = "Modify",
              w.setActiveShape(S),
              w.dirtyCanvas(),
              w.setSelectedEnable(!1)
        }(function(e) {
          var t = getXYfromEvent(e)
              , n = w.getCavPosition();
          return new SeadragonPoint(t[0].x - n.x,t[0].y - n.y)
        }(e)))
  }
  function n() {
    w.setDrawAnnotationType(AnnotationType.CurveEditor)
  }
  function C(e, t) {
    for (var n, a, i = 0; i < t.length; i++) {
      var o = CalcRadius(e, t[i]);
      (0 == i || o < a) && (n = i,
          a = o)
    }
    return n
  }
  function k(e, t, n) {
    e.x > n.x && (e.x = n.x),
    e.y > n.y && (e.y = n.y),
    t.x < n.x && (t.x = n.x),
    t.y < n.y && (t.y = n.y)
  }
  w.bind("beforeAnnotationChange", function(e, t, n) {
    d && (e == S && t == AnnotationAction.Del ? (n.IsCancel = !0,
        l.showMessage(MedLang.getString("delEdit", u))) : e.type == AnnotationType.CurveEditor && t == AnnotationAction.Add && (e.status = -1,
        e.color = S.color,
        e.width = S.width,
        e.editShape = S))
  }),
      $(w.getCommonCanvas()).bind("click touchstart", e),
      w.bind("shapedrawend", function() {
        console.log(w)
        if ("CurveEditor" === d) {
          var e = w.getActiveShape();
          "CurveEditor" == e.type && (w.deleteAnnotation(),
              n(),
              function(e) {
            console.log('修改曲线11111')
                var t = S.points
                    , n = S.cavPoints
                    , a = e.points
                    , i = t.slice(0);
                if (!isNaN(a[0].x) && !isNaN(a[0].y)) {
                  var o, s, r = C(a[0], i), l = C(a[a.length - 1], i), d = r < l ? 1 : -1;
                  switch (S.type) {
                    case AnnotationType.CurveRounded:
                    case AnnotationType.CurveRoundedMarquee:
                    case AnnotationType.Polygon:
                    case AnnotationType.PolygonMarquee:
                      t.length = n.length = 0;
                      for (var c = 0; c < a.length; c++) {
                        var u = a[c];
                        t.push(u),
                            n.push(S.toCanvasPoint(u, !1)),
                            0 == c ? (o = new Point(u.x,u.y),
                                s = new Point(u.x,u.y)) : k(o, s, u)
                      }
                      var p = i.length - l * d + r * d + 1
                          , g = (l - r) * d + 1;
                      if (d < 0) {
                        var h = p;
                        p = g,
                            g = h
                      }
                      d = g < p ? 1 : -1;
                      var f = 0 < (g < p) ? p : g;
                      for (c = 0; c < f; c++) {
                        var v = l + c * d;
                        v > i.length - 1 ? v -= i.length : v < 0 && (v = i.length + v),
                            u = i[v],
                            t.push(u),
                            n.push(S.toCanvasPoint(u, !1)),
                            k(o, s, u)
                      }
                      break;
                    case AnnotationType.Curve:
                      var m = (0 < d ? r : l) + 1
                          , b = m + a.length;
                      t.splice(m, Math.abs(r - l) - 1),
                          n.splice(m, Math.abs(r - l) - 1),
                          c = 0;
                      for (var y = a.length + t.length; c < y; c++)
                        c < m || b <= c ? (u = t[c],
                            n[c] = S.toCanvasPoint(u, !1)) : (u = a[0 < d ? c - m : a.length - c + m - 1],
                            t.splice(c, 0, u),
                            n.splice(c, 0, S.toCanvasPoint(u, !1))),
                            0 == c ? (o = new Point(u.x,u.y),
                                s = new Point(u.x,u.y)) : k(o, s, u)
                  }
                  S.startPoint = o,
                      S.endPoint = s,
                      o = S.toCanvasPoint(o, !1),
                      s = S.toCanvasPoint(s, !1),
                      S.initRect = new Rect(o.x,o.y,s.x - o.x,s.y - o.y),
                      w.setActiveShape(S),
                      S.isMeasurementChanged = !0,
                      w.showImageShapes(),
                      S.action = "Modify",
                      w.dirtyCanvas()
                }
              }(e),
              t.enable(!1))
        }
      }),
      this.enable = function(e) {
        if (null == e)
          return d;
        if (d === e)
          return d;
        if (!1 === e)
          return d && (S.editing = !1,
              d = !1,
          w.isSelectedEnable && w.setActiveShape(S),
          0 == S.status && setTimeout(w.saveAnnotations, 100)),
              p(!0),
              !1;
        var t = c[e]
            , n = w.getActiveShape();
        if (null != n && (-1 == n.status || -2 == n.status || -1 == t.support.indexOf(n.type)))
          return l.showMessage(MedLang.getString("nosupport", u)),
              !1;
        if (null == n && !d) {
          for (var a = w.getAnnotations(), i = 0, o = 0, s = 0; s < a.length; s++) {
            var r = a[s];
            r.status < 0 || (o++,
            -1 < t.support.indexOf(a[s].type) && (i++,
                n = r))
          }
          if (0 == i)
            return l.showMessage(MedLang.getString("noeditable", u)),
                !1;
          if (1 < o)
            return l.showMessage(MedLang.getString("select", u)),
                !1
        }
        return d = e,
            (S = n || S).editing = !0,
            l.getShapeCanvas().setSelectedEnable(!1),
            t.init(),
            p(!1),
            l.showMessage(MedLang.getString(e + ".enable", u)),
            !0
      }
}, VoiceAnnotation;
jQuery.event.special.destroyed = {
  remove: function(e) {
    e.handler && e.handler()
  }
},
    SlideProvider.prototype.getRecord = function(e, n) {
      var t = this.getActionUrl("Annotations/" + e + "/Record");
      t = this.getSigUrl(t, "GET", !0);
      var a = new XMLHttpRequest;
      a.open("GET", t, !0),
          a.responseType = "arraybuffer",
          a.onload = function() {
            var e;
            if (200 == a.status) {
              var t = new DataView(a.response);
              e = new Blob([t],{
                type: "audio/ogg;codecs=opus"
              })
            }
            n && n(a.status, e)
          }
          ,
          a.send()
    }
    ,
    SlideProvider.prototype.saveRecord = function(e, t, n) {
      var a = this.getActionUrl("Annotations/" + e + "/Record");
      a = this.getSigUrl(a, "POST", !0);
      var i = new XMLHttpRequest;
      n && (i.addEventListener("load", function(e) {
        n("ok", e)
      }, !1),
          i.addEventListener("error", function(e) {
            n("error", e)
          }, !1)),
          i.open("POST", a),
          i.send(t)
    }
    ,
    SlideProvider.prototype.deleteRecord = function(e, t) {
      var n = this.getActionUrl("Annotations/" + e + "/Record");
      this.request(n, "DELETE", {}, !0, new UpdateResult, null, t)
    }
    ,
    function() {
      var e = (VoiceAnnotation = function(e, t, n, a, i) {
            Position.apply(this, [e, t, n, a, i])
          }
      ).prototype = new Position;
      e.delete = function() {
        _viewer.provider.deleteRecord(this.guid, function(e) {
          console.log(e)
        })
      }
      ;
      var i, o, s = 0;
      function r(e) {
        i.html(e || s++),
        "recording" != MoticAudio.getStatus() || s - 1 != 60 || MoticAudio.stop()
      }
      function a(e, t) {
        clearInterval(o);
        var n = $(t.inpElmt);
        switch (e.status) {
          case "startRecord":
            t.isRecording = !0,
                n.find(".va_record>span").addClass("active"),
                t.externalData.record = null;
            break;
          case "stopRecord":
            if (t.isRecording = !1,
                n.find(".va_record>span").removeClass("active"),
            e.duration < 1e3)
              t.saveData.recordTime ? i.html(t.saveData.recordTime) : i.html("--"),
                  MoticAudio.stop(),
                  _viewer.showMessage(MedLang.getString("recordingTime_tooShort", l));
            else {
              if (t.externalData.record = e.data,
                  t.saveData.recordTime = Math.floor(e.duration / 1e3),
                  r(t.saveData.recordTime || "--"),
                  t.isDestroyed)
                return;
              var a = new FormData;
              a.append("file", e.data),
                  _viewer.provider.saveRecord(t.guid, a, function(e) {
                    "ok" == e ? (_viewer.getShapeCanvas().isShapeChanged = !0,
                        _viewer.getShapeCanvas().saveAnnotations()) : console.log(e)
                  }),
                  _viewer.trigger("recordfinish")
            }
            return;
          case "startPlay":
            t.isPlaying = !0,
                n.find(".va_play>span").addClass("active");
            break;
          case "stopPlay":
            return t.isPlaying = !1,
                n.find(".va_play>span").removeClass("active"),
                void r(t.saveData.recordTime || "--");
          case "error":
            return void _viewer.showMessage(MedLang.getString(e.msg, l))
        }
        i = n.find("div"),
            s = 0,
            r(),
            o = setInterval(r, 1e3)
      }
      var l = {
        en: {
          PERMISSION_DENIED: "You refuse to use recording function",
          PermissionDeniedError: "Could not get recording device",
          NOT_SUPPORTED_ERROR: "Your browser does not support hardware equipment",
          NotSupportedError: "Your browser does not support hardware equipment",
          MANDATORY_UNSATISHIED_ERROR: "Can't find the specified hardware equipment",
          MandatoryUnsatisfiedError: "Can't find the specified hardware equipment",
          DevicesNotFoundError: "Your device no microphones available",
          NotFoundError: "Your device no microphones available",
          BrowseNotSupport: "Your browser does not support the recording function!",
          recording: "Please recording first",
          recordingTime_tooShort: "The recording time is too short",
          NotSupportedplaying: "Your browser does not support voice playing",
          PlayError: "Play failed",
          RecordError: "Record failed",
          LoadRecordFailed: "Load audio failed",
          NotRecordFile: "Not exist audio file"
        },
        zh: {
          PERMISSION_DENIED: "您拒绝使用录音功能",
          PermissionDeniedError: "无法获取录音设备",
          NOT_SUPPORTED_ERROR: "对不起，您的浏览器不支持录音功能",
          NotSupportedError: "对不起，您的浏览器暂不支持录音功能",
          MANDATORY_UNSATISHIED_ERROR: "无法发现指定的硬件设备",
          MandatoryUnsatisfiedError: "无法发现指定的硬件设备。",
          DevicesNotFoundError: "您的设备没有可用的麦克风",
          NotFoundError: "您的设备没有可用的麦克风",
          BrowseNotSupport: "对不起，您的浏览器暂不支持录音功能",
          recording: "请录音",
          recordingTime_tooShort: "录音时间太短",
          NotSupportedplaying: "对不起，您的浏览器暂不支持音频播放",
          PlayError: "播放失败",
          RecordError: "录音失败",
          LoadRecordFailed: "获取录音文件失败",
          NotRecordFile: "无录音文件"
        }
      };
      e.createElmt = function() {
        if (null == this.inpElmt) {
          var e = this
              , t = $("<div style='display:none;position:absolute;z-index: 1;border-radius:4px;-moz-border-radius: 4px;-webkit-border-radius:4px;border:2px solid #A3AEB9; background-color: #F7F8FA;'>                      <a  class='toolbutton2 va_record'><span><span class='toolbutton-inner2 toolbtn-icon-startRecord' style='display:inline-block'></span></span></a>                       <a  class='toolbutton2 va_play'><span><span class='toolbutton-inner2 toolbtn-icon-startPlay' style='display:inline-block'></span></span></a>                       <div style='width:40px;height:38px;line-height:38px;display:inline-block;text-align:center;border-left:1px solid #fff' class='timemain'>--</div>              </div>");
          this.inpElmt = t[0],
              this.container.appendChild(this.inpElmt),
              function(e, n) {
                n.isDestroyed = !1,
                    e.bind("mousedown", function(e) {
                      e.stopPropagation(),
                      n.isSelected || n.externalData.owner || (_viewer.getShapeCanvas().setActiveShape(n),
                      _viewer.getShapeCanvas().isSelectedEnable && _viewer.getShapeCanvas().showImageShapes())
                    }).delegate("a", "click", function() {
                      switch (this.className) {
                        case "toolbutton2 va_record":
                          if (!MoticAudio.isSupport())
                            return void _viewer.showMessage(MedLang.getString("NotSupportedError", l));
                          n.isRecording ? MoticAudio.stop() : MoticAudio.record(function(e) {
                            a(e, n)
                          });
                          break;
                        case "toolbutton2 va_play":
                          if (!MoticAudio.isSupport())
                            return void _viewer.showMessage(MedLang.getString("NotSupportedplaying", l));
                          n.isPlaying ? MoticAudio.stop() : n.isRecording || n.externalData.loaded && n.externalData.record ? MoticAudio.play(n.externalData.record, function(e) {
                            a(e, n)
                          }) : n.saveData.recordTime ? _viewer.provider.getRecord(n.guid, function(e, t) {
                            200 == e ? (n.externalData.loaded = !0,
                                n.externalData.record = t,
                                MoticAudio.play(t, function(e) {
                                  a(e, n)
                                })) : 404 == e ? (n.saveData.recordTime = 0,
                                _viewer.showMessage(MedLang.getString("NotRecordFile", l))) : _viewer.showMessage(MedLang.getString("LoadRecordFailed", l))
                          }) : _viewer.showMessage(MedLang.getString(n.externalData && n.externalData.owner ? "NotRecordFile" : "recording", l))
                      }
                    }).bind("destroyed", function() {
                      n.isDestroyed = !0,
                      (n.isPlaying || n.isRecording) && MoticAudio.stop()
                    })
              }(t, this),
              setTimeout(function() {
                e.saveData && 0 < e.saveData.recordTime ? $(e.inpElmt).find("div").html(e.saveData.recordTime) : e.saveData = {},
                e.externalData || (e.externalData = {}),
                e.externalData.owner && $(e.inpElmt).find(".va_record").css({
                  display: "none"
                }),
                    e.isDemo = !1,
                !e.isLocked && e.status < 0 && (e.status = 0)
              }, 1)
        }
      }
          ,
          e.setCSS = function(e, t) {
            var n = this.inpElmt.style;
            n.left = e + "px",
                n.top = t + "px",
                n.display = "block",
            this.isSelected && this.active()
          }
          ,
          e.drawMeasurement = function() {}
          ,
          e.showMeasurement = function() {}
          ,
          e.calcMeasurementInfoMaxWidth = function() {}
          ,
          e.isHitMyArea = function(e) {
            if (!this.movePoint)
              return !1;
            var t = getTextRect(this.getContext(), this.movePoint.x, this.movePoint.y, this.calcMeasurementInfo(), this.fontSize, this.measureinfoMaxWidth);
            return this.isSelected = pointInRect(e, t, 1) || this.isHitMyFlag(e),
                this.cavRect = t,
                this.isSelected
          }
          ,
          e.drawPositionIcon = function(e) {
            if (null != e) {
              var t = this.getContext()
                  , n = this.iconRadius;
              t.beginPath(),
                  t.lineWidth = 2,
                  t.arc(e.x, e.y, n, 0, 2 * Math.PI, !1),
                  t.fillStyle = "rgba(255, 255, 255, 0.6)",
                  t.fill(),
                  t.strokeStyle = "#666465",
                  t.stroke()
            }
          }
          ,
          AnnotationType.AddType("VoiceAnnotation", "VoiceAnnotation"),
          CustomShapeTypes.AddAnnotationType("VoiceAnnotation", VoiceAnnotation)
    }(),
    function(p) {
      p.URL = p.URL || p.webkitURL;
      var g = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
      if (g) {
        g = g.bind(navigator);
        var h = "stop"
            , f = "recording"
            , v = "playing";
        p.MoticAudio = new function() {
          var t, a, n, i, o, s = this, r = h, l = [], d = new Audio;
          d.onpause = function(e) {
            r = h,
                console.log("[MoticAudio] StopPlay"),
            n && n({
              status: "stopPlay"
            })
          }
              ,
              d.onerror = function(e) {
                r = h,
                    console.error("[MoticAudio] " + e),
                n && n({
                  status: "error",
                  msg: "PlayError"
                })
              }
              ,
              d.onplaying = function(e) {
                r = v,
                    console.log("[MoticAudio] StartPlay"),
                n && n({
                  status: "startPlay"
                })
              }
          ;
          function c(e, t) {
            r = h,
                console.error("[Motic Audio] " + (t || e)),
            a && a({
              status: "error",
              msg: e
            })
          }
          function u() {
            try {
              t.start(1e3)
            } catch (e) {
              return t = null,
                  void c("RecordError")
            }
            l.length = 0,
                i = (new Date).getTime(),
                console.log("[MoticAudio] StartRecord"),
            a && a({
              status: "startRecord"
            })
          }
          this.record = function(e) {
            if (r !== h)
              return s.stop(),
                  void (o = setTimeout(function() {
                    s.record(e)
                  }, 100));
            r = f,
                a = e,
                null != t ? u() : setTimeout(function() {
                  "MediaRecorder"in p ? g({
                    audio: !0
                  }, function(e) {
                    e,
                        (t = new MediaRecorder(e,{
                          audioBitsPerSecond: 8e3
                        })).onstop = function(e) {
                          if (console.log("[MoticAudio] StopRecord"),
                              a) {
                            var t = new Blob(l,{
                              type: "audio/ogg;codecs=opus"
                            })
                                , n = (new Date).getTime() - i;
                            console.log("  --Duration:" + n / 1e3 + "s"),
                                console.log("  --Duration:" + t.size / 1024 + "kb"),
                                a({
                                  status: "stopRecord",
                                  data: t,
                                  duration: n
                                })
                          }
                        }
                        ,
                        t.ondataavailable = function(e) {
                          l.push(e.data)
                        }
                        ,
                        u()
                  }, function(e) {
                    c(e.name)
                  }) : c("BrowseNotSupport")
                }, 1)
          }
              ,
              this.stop = function() {
                r == f ? t && t.stop() : r == v && d.pause(),
                    r = h,
                    clearTimeout(o)
              }
              ,
              this.play = function(e, t) {
                if (r !== h)
                  return s.stop(),
                      void (o = setTimeout(function() {
                        s.play(e, t)
                      }, 100));
                e = e || new Blob(l,{
                  type: "audio/ogg;codecs=opus"
                }),
                    n = t,
                    d.src = URL.createObjectURL(e);
                try {
                  d.play()
                } finally {
                  setTimeout(function() {
                    p.URL.revokeObjectURL(d.src)
                  }, 0)
                }
              }
              ,
              this.getStatus = function() {
                return r
              }
              ,
              this.isSupport = function() {
                return !!g
              }
        }
      }
    }(window),
    SlideProvider.prototype.getRelevantSlideAnnotation = function(e, t) {
      var n = "/Slides/" + this.slideId() + "/RelevantSlidesAnnotations?slideId=" + e.join("&slideId=");
      this.request(n, "GET", {}, !1, {
        anns: []
      }, function(e, t) {
        e.anns = t
      }, t)
    }
;
var AnnotationList = function(y) {
  AdvancedDialog.apply(this, [y, "al", void 0, 450]);
  var S = {
    zh: {
      title: "标注列表",
      type: "类型",
      name: "名称",
      desc: "描述",
      annByGroup: "按类型显示",
      ExportData: "导出数据",
      Statistics: "平均值",
      Line: "直线",
      Arrow: "带箭头直线",
      Rectangle: "矩形",
      Ellipse: "椭圆",
      Remark: "文本注释",
      Position: "位置",
      RoundedCurve: "闭合曲线",
      FreeRoundedCurve: "自由曲线",
      Angle: "三点画角度",
      Circle: "圆",
      CircleThreePoints: "三点画圆",
      Arc: "三点画弧",
      Polygon: "多边形",
      VoiceAnnotation: "语音",
      RectangleMarquee: "矩形AOI",
      PolygonMarquee: "多边形AOI",
      CurveRoundedMarquee: "闭合曲线AOI"
    },
    en: {
      title: "Annotation list",
      type: "Type",
      name: "Name",
      desc: "Description",
      annByGroup: "Group by type",
      ExportData: "Export Data",
      Statistics: "average",
      Line: "Line",
      Arrow: "Arrow",
      Rectangle: "Rectangle",
      Ellipse: "Ellipse",
      Remark: "Remark",
      Position: "Position",
      RoundedCurve: "Closed Curve",
      FreeRoundedCurve: "Curve",
      Angle: "Angle by 3 Points",
      Circle: "Circle",
      CircleThreePoints: "Circle by 3 points",
      Arc: "Arc by 3 points",
      Polygon: "Polygon",
      VoiceAnnotation: "Voice Annotation",
      RectangleMarquee: "Rectangle AOI",
      PolygonMarquee: "Polygon AOI",
      CurveRoundedMarquee: "Closed Curve AOI"
    }
  }
      , s = '<div id="lableList" class="listMaxH"  style="overflow-y: auto;margin:-9px -14px 0px ;padding:9px 14px 0px ;background-color:rgb(250,250,250);"></div><div class="text-right" style="background-color:rgb(250,250,250);margin:0px -14px -9px -14px;padding:0px 14px;"><label class="checkbox" style="display:inline-block;float:left;margin-top:17px;margin-right:5px;"><input type="checkbox" class="ann_group" id="annGroup">' + MedLang.getString("annByGroup", S) + '</label><buton type="buton" class="btn btn-primary " id="exportData" style="margin: 9px 0px;">' + MedLang.getString("ExportData", S) + "</buton></div>";
  s = $(s),
      this.title = MedLang.getString("title", S);
  var r, l, d, c = this, w = [], i = [], C = {}, o = !1, u = [], p = g(), e = $.query.get("sa");
  function g(e) {
    var t = "al_group";
    if (null == e)
      return "true" == SlideViewerConfig.localStorage(t);
    SlideViewerConfig.localStorage(t, e)
  }
  e && T(e);
  var h = {};
  function f() {
    0 < i.length && y.provider.getRelevantSlideAnnotation(i, function(e) {
      w = e.anns.annotations
    })
  }
  function v(e, t) {
    o = !0;
    for (var n = [], a = 0; a < e.length; a++)
      -1 != e[a].status && n.push(e[a]);
    t && (n = n.concat(t)),
    p && (n = function(e) {
      for (var t = {}, n = {}, a = [], i = 0; i < e.length; i++) {
        var o = e[i]
            , s = t[o.type];
        s || (t[o.type] = s = {
          type: o.type,
          data: []
        },
            a.push(s));
        var r = o.slideId || ""
            , l = n[o.type + r];
        l || (n[o.type + r] = l = {
          slideId: o.slideId,
          data: []
        },
            s.data.push(l)),
            l.data.push(o)
      }
      return a
    }(n)),
        function(e) {
          var t = $("#exportData");
          0 < e.length ? t.removeClass("disabled") : t.addClass("disabled");
          s.eq(0).empty().append(p ? function(e) {
            e.sort(function(e, t) {
              return k[e.type] - k[t.type]
            });
            for (var t = "", n = 0, a = "", i = {}, o = 0; o < e.length; o++) {
              for (var s = "", r = "", l = "", d = 0, c = "", u = e[o].data, p = 0, g = 0, h = x(e[o].type), f = 0; f < u.length; f++) {
                for (var v = "", m = 0; m < u[f].data.length; m++) {
                  d++;
                  var b = u[f].data[m];
                  i = u[f].slideId ? A(2, b) : A(1, b),
                      p += Number(i.attribute_NO1),
                      g += Number(i.attribute_NO2),
                      b.rank = d,
                      b.attribute_NO1 = i.attribute_NO1,
                      b.attribute_NO2 = i.attribute_NO2,
                      n = .75 / parseInt(i.row) * 100 + "%",
                      1 == i.row ? a = "" : 2 == i.row && (a = '<span  class="list-header borderL" style="width:' + n + ';">' + i.attribute_NO2 + "</span>"),
                      v += '<div class="ann-item listHeight cursorP ' + (b.visible ? "" : "in_visible") + '" style="font-size: 13px;" data-id="' + (b.guid || b.id) + '" data-sid="' + (u[f].slideId || "") + '"><span class="list-header" style="width:25%;">' + d + '</span><span  class="list-header borderL onelintext" style="width:' + n + ';">' + i.attribute_NO1 + "</span>" + a + "</div>"
                }
                1 <= w.length ? (c = u[f].slideId ? C[u[f].slideId] : y.getCurrentSlide().name,
                    r = r + '<div class="tac listHeight" style="font-size: 14px;">' + c + "</div>" + v) : r += v,
                    u[f].slideName = c
              }
              l = "description" == i.category_NO1 ? "collapse" : "",
                  1 == i.row ? a = s = "" : 2 == i.row && (s = '<span  class="list-header borderL" style="width:' + n + ';">' + i.category_NO2 + "</span>",
                      a = '<span  class="list-header borderL" style="width:' + n + ';">' + floatRound(g / d) + "</span>"),
                  t += '<div style="margin-bottom:5px;background-color: #fff;border:1px solid gainsboro;border-radius:3px;"><div class="ann-head " data-type="' + e[o].type + '" style="display:table;width:100%;line-height: 30px;cursor:pointer;font-size: 14px;height:35px;" ><span class="toolbutton-inner3 ' + h + '"></span><span style="float:left;padding-top:5px;">' + MedLang.getString(e[o].type, S) + '</span><span style="float:right;padding:5px 10px 0px 0px;">' + d + '</span></div><div class="ann-body collapse ' + e[o].type + '" ><div class="listHeight" style="font-size: 14px;"  ><span class="list-header" style="width:25%;">No.</span><span  class="list-header borderL" style="width:' + n + ';">' + i.category_NO1 + "</span>" + s + "</div>" + r + '<div class="listHeight ' + l + '" style="font-size: 13px;"  ><span class="list-header" style="width:25%;">' + MedLang.getString("Statistics", S) + '</span><span  class="list-header borderL" style="width:' + n + ';">' + floatRound(p / d) + "</span>" + a + "</div></div></div>",
                  e[o].rank = d,
                  e[o].category_NO1 = i.category_NO1,
                  e[o].category_NO2 = i.category_NO2 || "",
                  e[o].typename = MedLang.getString(e[o].type, S),
                  e[o].Statistics = MedLang.getString("Statistics", S),
                  e[o].Statistics_NO1 = floatRound(p / d),
                  e[o].Statistics_NO2 = floatRound(g / d)
            }
            return t
          }(e) : function(e) {
            if (0 == e.length)
              return "";
            for (var t = "<table class='ann-list' style='width:100%;'><tr><th>No.</th><th>" + MedLang.getString("type", S) + "</th><th>" + MedLang.getString("name", S) + "</th><th>" + MedLang.getString("desc", S) + "</th></tr>", n = 0; n < e.length; n++) {
              var a = e[n];
              t += "<tr class='ann-item cursorP " + (a.visible ? "" : "in_visible") + (a.guid == r ? " active " : "") + "' data-id='" + (a.guid || a.id) + "' data-sid='" + (a.slideId || "") + "'><td>" + (n + 1) + "</td><td><span class='toolbutton-inner3 " + x(a.type) + "' title=" + MedLang.getString(a.type, S) + "></span></td><td style='font-size: 12px;text-align: left;'>" + a.name + "</td><td style='font-size: 10px;text-align: left;'>" + a.description + "</td></tr>"
            }
            return t += "</table>"
          }(e)),
              l = e
        }(n)
  }
  y.bind("loadedRelevantSlide", function(e, t, n) {
    d = n;
    for (var a = 0; a < e.length; a++)
      e[a].isCurrent || (h[e[a].id] = e[a].url,
          i.push(e[a].id),
          C[e[a].id] = e[a].name);
    1 == o && (f(),
        v(u, w))
  }),
      this.bind("init", function() {
        if (!1 !== c.initDialog(c.title, s)) {
          s.find("#annGroup").prop("checked", p),
              f();
          var e = y.getShapeCanvas();
          u = e.getAnnotations(!0);
          var t = e.getActiveShape();
          t && (r = t.guid),
              e.bind("selectshape", function(e) {
                r = e.guid,
                    o()
              }),
              s.delegate(".ann-item", "click", function() {
                var e = $(this)
                    , t = e.attr("data-id")
                    , n = e.attr("data-sid");
                n ? location.href = h[n] + "&sa=" + t : T(t)
              });
          var n, a, i = [];
          s.delegate(".ann-head", "click", function() {
            if ("active" == $(this).parent().attr("class")) {
              $(this).parent().removeClass("active");
              for (var e = 0; e < i.length; e++)
                $(i[e]).attr("data-type") == $(this).attr("data-type") && i.splice(e, 1)
            } else
              $(this).parent().addClass("active"),
                  i.push(this)
          }),
              s.delegate("#exportData", "click", function() {
                var e = p ? function(e) {
                  for (var t = "", n = 0; n < e.length; n++) {
                    t += e[n].typename + "," + e[n].rank + "\nNo.,",
                        t += e[n].category_NO1,
                    e[n].category_NO2 && (t += "," + e[n].category_NO2),
                        t += "\n";
                    for (var a = e[n].data, i = 0; i < a.length; i++) {
                      a[i].slideName && (t += b(a[i].slideName) + "\n");
                      for (var o = 0; o < a[i].data.length; o++) {
                        var s = a[i].data[o];
                        t += s.rank + "," + b(s.attribute_NO1),
                        s.attribute_NO2 && (t += "," + s.attribute_NO2),
                            t += "\n"
                      }
                    }
                    "description" != e[n].category_NO1 && (t += e[n].Statistics + "," + e[n].Statistics_NO1,
                    e[n].Statistics_NO2 && (t += "," + e[n].Statistics_NO2),
                        t += "\n")
                  }
                  return t
                }(l) : function(e) {
                  for (var t = "No.," + MedLang.getString("type", S) + "," + MedLang.getString("name", S) + "," + MedLang.getString("desc", S) + "\n", n = 0; n < e.length; ) {
                    var a = e[n++];
                    t += n + "," + a.type + "," + b(a.name) + "," + b(a.description) + "\n"
                  }
                  return t
                }(l);
                !function(e, t) {
                  if (window.navigator.msSaveBlob) {
                    var n = new Blob(["\ufeff" + t],"application/octet-stream;charset=utf-8");
                    window.navigator.msSaveBlob(n, e),
                        window.URL.revokeObjectURL(n)
                  } else {
                    var a = document.createElement("a");
                    a.style = "display: none;",
                        a.href = "data:application/octet-stream;charset=utf-8,\ufeff" + encodeURIComponent(t),
                        a.download = e,
                        document.body.appendChild(a),
                        a.click(),
                        document.body.removeChild(a)
                  }
                }(d + ".csv", e)
              }).delegate("#annGroup", "click", function() {
                p = this.checked,
                    g(this.checked),
                    o()
              }),
              y.bind("recordfinish", o),
              y.bind("shape:visible", o),
              v(u, w),
              y.bind("task.init", function(e) {
                "annotation" == e && o()
              }),
              y.bind("annotationChanged", o),
              y.bind("taskChanged", function(e) {
                a = e,
                    o()
              })
        }
        function o() {
          clearTimeout(n),
              n = setTimeout(function() {
                if (n = null,
                    v(u = y.getShapeCanvas().getAnnotations(!0), a ? [] : w),
                0 !== i.length)
                  for (var e = 0; e < i.length; e++) {
                    var t = $(i[e]).attr("data-type");
                    $("." + t).parent().addClass("active")
                  }
              }, 100)
        }
      });
  var k = {
    Line: 1,
    Arrow: 2,
    Rectangle: 3,
    Ellipse: 4,
    Circle: 5,
    RoundedCurve: 6,
    FreeRoundedCurve: 7,
    Angle: 8,
    Arc: 9,
    CircleThreePoints: 10,
    Polygon: 11,
    Remark: 12,
    Position: 13,
    VoiceAnnotation: 14,
    RectangleMarquee: 15,
    PolygonMarquee: 16,
    CurveRoundedMarquee: 17
  };
  function x(e) {
    var t = "";
    switch (e) {
      case "Rectangle":
        t = "toolbtn-icon-rect";
        break;
      case "RoundedCurve":
        t = "toolbtn-icon-curverounded";
        break;
      case "FreeRoundedCurve":
        t = "toolbtn-icon-curve";
        break;
      case "CircleThreePoints":
        t = "toolbtn-icon-circle3";
        break;
      case "VoiceAnnotation":
        t = "toolbtn-icon-record";
        break;
      case "RectangleMarquee":
        t = "toolbtn-roi-rect";
        break;
      case "PolygonMarquee":
        t = "toolbtn-roi-polygon";
        break;
      case "CurveRoundedMarquee":
        t = "toolbtn-roi-curverounded";
        break;
      default:
        t = "toolbtn-icon-" + e.toLowerCase()
    }
    return t
  }
  function A(e, t) {
    var n = {};
    if (1 == e)
      switch (t.type) {
        case "Line":
        case "Arrow":
          n = m(1, "L（μm）", floatRound(CalcRadius(t.startPoint, t.endPoint) * t.calibration));
          break;
        case "Rectangle":
        case "RectangleMarquee":
          var a = Math.abs(t.startPoint.x - t.endPoint.x)
              , i = Math.abs(t.startPoint.y - t.endPoint.y);
          n = m(2, "W（μm）", floatRound(a * t.calibration), "H（μm）", floatRound(i * t.calibration));
          break;
        case "Ellipse":
          a = Math.abs(t.startPoint.x - t.endPoint.x),
              i = Math.abs(t.startPoint.y - t.endPoint.y);
          var o = a / 2 * t.calibration
              , s = i / 2 * t.calibration;
          n = m(2, "LR（μm）", floatRound(Math.max(o, s)), "SR（μm）", floatRound(Math.min(o, s)));
          break;
        case "Circle":
          var r = CalcRadius(t.startPoint, t.endPoint) * t.calibration;
          n = m(1, "R（μm）", floatRound(r));
          break;
        case "CurveRoundedMarquee":
        case "RoundedCurve":
          n = m(2, "L（μm）", floatRound(CalcLengthClosed(t.points) * t.calibration), "S（μm²）", floatRound(CalcArea(t.points) * t.calibration * t.calibration));
          break;
        case "FreeRoundedCurve":
          var l = CalcLength(t.points) * t.calibration;
          n = m(1, "L（μm）", floatRound(l));
          break;
        case "Angle":
          n = m(1, "∠（°）", floatRound(AngleDegree(t.cavPoints[0], t.cavPoints[1], t.cavPoints[2])));
          break;
        case "Arc":
          var d = CalcCenterPoint(t.points[0], t.points[1], t.points[2])
              , c = (r = CalcRadius(d, t.points[0]) * t.calibration,
              AngleDegree(t.points[0], d, t.points[2]));
          t.isLargeArc ? c < 180 && (c = 360 - c) : 180 < c && (c = 360 - c),
              n = m(2, "R（μm）", floatRound(r), "∠（°）", floatRound(c));
          break;
        case "CircleThreePoints":
          r = CalcRadius(CalcCenterPoint(t.points[0], t.points[1], t.points[2]), t.points[0]) * t.calibration;
          n = m(1, "R（μm）", floatRound(r));
          break;
        case "Polygon":
        case "PolygonMarquee":
          n = m(2, "L（μm）", floatRound(CalcLengthClosed(t.points) * t.calibration), "S（μm²）", floatRound(CalcArea(t.points) * t.calibration * t.calibration));
          break;
        case "Remark":
        case "Position":
          n = m(1, "description", t.description);
          break;
        case "VoiceAnnotation":
          n = t.saveData.recordTime ? m(1, "Time（s）", t.saveData.recordTime) : m(1, "Time（s）", "0")
      }
    else if (2 == e)
      switch (t.type) {
        case "Line":
        case "Arrow":
          n = m(1, "L（μm）", floatRound(t.length));
          break;
        case "Rectangle":
        case "RectangleMarquee":
          n = m(2, "W（μm）", floatRound(t.witdh), "H（μm）", floatRound(t.height));
          break;
        case "Ellipse":
          n = m(2, "LR（μm）", floatRound(t.majorHalfAxis), "SR（μm）", floatRound(t.minorHalfAxis));
          break;
        case "Circle":
          n = m(1, "R（μm）", t.radius);
          break;
        case "CurveRoundedMarquee":
        case "RoundedCurve":
          n = m(2, "L（μm）", floatRound(t.perimeter), "S（μm²）", floatRound(t.area));
          break;
        case "FreeRoundedCurve":
          n = m(1, "L（μm）", floatRound(t.perimeter));
          break;
        case "Angle":
          n = m(1, "∠（°）", floatRound(t.angle));
          break;
        case "Arc":
          n = m(2, "R（μm）", floatRound(t.radius), "∠（°）", floatRound(t.angle));
          break;
        case "CircleThreePoints":
          n = m(1, "R（μm）", floatRound(t.radius));
          break;
        case "Polygon":
        case "PolygonMarquee":
          n = m(2, "L（μm）", floatRound(t.perimeter), "S（μm²）", floatRound(t.area));
          break;
        case "Remark":
        case "Position":
          n = m(1, "description", t.desc);
          break;
        case "VoiceAnnotation":
          n = m(1, "Time（s）", floatRound(t.duration))
      }
    return n
  }
  function m(e, t, n, a, i) {
    var o = {};
    return o.row = e,
        o.category_NO1 = t,
        o.attribute_NO1 = n,
        o.category_NO2 = a,
        o.attribute_NO2 = i,
        o
  }
  function b(e) {
    return "string" == typeof e && -1 != (e = (e = (e = e.replaceAll("\\n", " ")).replaceAll("\\r", "")).replaceAll('"', '""')).indexOf(",") && (e = '"' + e + '"'),
        e
  }
  function T(e) {
    for (var t, n = y.getShapeCanvas().getAnnotations(!0), a = 0; a < n.length; a++)
      if (n[a].guid == e) {
        t = n[a];
        break
      }
    if (null != t && t.visible) {
      y.getShapeCanvas().setActiveShape(t),
          t.measurement = !0,
          t.isSelected = !1;
      var i = t.movePoint;
      i = rotatePoint(i, -t.rotateRadian, t.rotateOriginPoint),
          i = y.viewport.pointFromPixel(new SeadragonPoint(i.x,i.y)),
          y.viewport.panTo(i)
    }
  }
}
    , SlideAnnotation = function(viewer) {
  var html = '<div class="anno">           <a class="toolbutton active edit style-3" id="lnkHand" data-type="Hand"><span class="toolbutton-inner toolbtn-icon-hand"></span></a>           <a class="toolbutton edit style-3" id="lnkSelect" data-type="Select"><span class="toolbutton-inner toolbtn-icon-selectanno"></span></a>           <a class="toolbutton edit" data-type="CurveEditor"><span class="toolbutton-inner toolbtn-icon-merge"></span></a>           <a class="toolbutton edit" data-type="PointMinus"><span class="toolbutton-inner toolbtn-icon-minus"></span></a>           <div style="border-bottom: 1px solid #EBEBEB;" class="clearfix style-3"></div>           <a class="toolbutton style-3" id="lnkLine" data-type="Line"><span class="toolbutton-inner toolbtn-icon-line"></span></a>           <a class="toolbutton style-3" id="lnkArrow" data-type="Arrow"><span class="toolbutton-inner toolbtn-icon-arrow"></span></a>           <a class="toolbutton style-3"  id="lnkRect" data-type="Rectangle"><span class="toolbutton-inner toolbtn-icon-rect"></span></a>           <a class="toolbutton style-3" id="lnkEllipse" data-type="Ellipse"><span class="toolbutton-inner toolbtn-icon-ellipse"></span></a>           <a class="toolbutton" id="lnkCircle" data-type="Circle"><span class="toolbutton-inner toolbtn-icon-circle"></span></a>           <a class="toolbutton task style-3" id="lnkCurveRounded" data-type="CurveRounded"><span class="toolbutton-inner toolbtn-icon-curverounded"></span></a>           <a class="toolbutton" id="lnkCurve" data-type="Curve"><span class="toolbutton-inner toolbtn-icon-curve"></span></a>           <a class="toolbutton" id="lnkAngle" data-type="Angle"><span class="toolbutton-inner toolbtn-icon-angle"></span></a>           <a class="toolbutton" id="lnkArc" data-type="Arc"><span class="toolbutton-inner toolbtn-icon-arc"></span></a>           <a class="toolbutton" id="lnkCircleThree" data-type="CircleThreePoints"><span class="toolbutton-inner toolbtn-icon-circle3"></span></a>           <a class="toolbutton task" id="lnkPolygon" data-type="Polygon"><span class="toolbutton-inner toolbtn-icon-polygon"></span></a>           <a class="toolbutton style-3" id="lnkRemark" data-type="Remark"><span class="toolbutton-inner toolbtn-icon-remark"></span></a>           <a class="toolbutton" id="lnkPosition" data-type="Position"><span class="toolbutton-inner toolbtn-icon-position"></span></a>';
  SlideViewerConfig.enableVoiceAnnotation && (html += '<a class="toolbutton " id="lnkVoiceAnnotation" data-type="VoiceAnnotation"><span class="toolbutton-inner toolbtn-icon-record"></span></a>'),
      html += '<div style="border-bottom: 1px solid #EBEBEB;" class="clearfix"></div>           <a class="toolbutton marquee task" id="lnkRectangleMarquee" data-type="RectangleMarquee"><span class="toolbutton-inner toolbtn-roi-rect"></span></a>           <a class="toolbutton marquee" id="lnkPolygonMarquee" data-type="PolygonMarquee"><span class="toolbutton-inner toolbtn-roi-polygon"></span></a>           <a class="toolbutton marquee" id="lnkCurveRoundedMarquee" data-type="CurveRoundedMarquee"><span class="toolbutton-inner toolbtn-roi-curverounded"></span></a>           <div class="clearfix style-3"></div>           <label class="checkbox"><input type="checkbox" class="demo_ann"><span data-lang="Labels.fluorescent"></span></label>           <label class="checkbox style-3" style="display: inline-block;margin-right:10px;"><input type="checkbox" class="s_name"><span data-lang="Labels.s_name"></label>           <label class="checkbox style-3" style="display: inline-block;"><input type="checkbox" class="s_measurement"><span data-lang="Labels.s_measurement"></label>           <label class="checkbox style-3" ><input type="checkbox" class="ann_list"><span data-lang="Labels.ann_list"></span></label>           <label class="checkbox style-3"><input type="checkbox" class="measurement"><span data-lang="Labels.show_measurement"></span></label>           <p style="border-bottom:1px solid #EBEBEB;color: #aaa;text-align: center;line-height: 3px;"><span style="display:none;background: white;padding: 0 5px;">App</span></p>            <label class="radio">               <input type="radio" name="visible" value="1" checked="">               <span data-lang="visible.public"></span>            </label>            <label class="radio">               <input type="radio" name="visible" value="5">               <span data-lang="visible.admin"></span>            </label>            <label class="radio">               <input type="radio" name="visible" value="0">               <span data-lang="visible.private"></span>            </label>           <p class="border-top"></p>           <div class="text-right style-3">           <span id="ann_status" style="margin-right:10px;color:#777;font-size:90%;"></span>           <a class="btn btn-primary hidden" id="lnkSave1" data-lang="Buttons.Save"></a>           <a class="btn btn-primary" id="lnkEdit" data-lang="Buttons.Edit"></a>           <a class="btn btn-danger" id="lnkDelete" data-lang="Buttons.Delete"></a>           </div>           <div class="compactshade"><span class="suport" data-lang="Compact.Message"></span></div>           <div class="canvas"><span class="suport" data-lang="Labels.NotSupported"></span></div>        </div>';
  var dialog = '<div class="modal fade" style="overflow:auto"><div class="modal-dialog" style="margin-top:2%"><div class="modal-content">        <div class="modal-header">          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>          <h3 data-lang="Annotations.Dialog.Title"></h3>        </div>        <div class="modal-body">           <form class="form-horizontal">            <div class="form-group">              <label class="col-sm-3 control-label" for="lineWidth" data-lang="Annotations.Dialog.LineWidth">Line Width:</label>              <div class="col-sm-6">                <select id="lineWidth" class="form-control" >                   <option value="1">1</option>                   <option value="2">2</option>                   <option value="5" selected="selected">5</option>                   <option value="10">10</option>                   <option value="20">20</option>                 </select>               </div>            </div>            <div class="form-group">              <label class="col-sm-3 control-label" for="annoName" data-lang="Annotations.Dialog.Name">Name:</label>              <div class="col-sm-6">                <input type="text" class="form-control" id="annoName"/>               </div>            </div>            <div class="form-group rectangle">              <label class="col-sm-3 control-label" for="annWidth" data-lang="Annotations.Measurement.TxtWidth">Width:</label>              <div class="col-sm-6">                <input type="text" class="form-control" id="annWidth"/>              </div>              <span class="col-sm-3 control-label text-left" data-lang="Annotations.Measurement.TxtUnit"/>            </div>            <div class="form-group rectangle">              <label class="col-sm-3 control-label" for="annHeight" data-lang="Annotations.Measurement.TxtHeight">Height:</label>              <div class="col-sm-6">                <input type="text" class="form-control" id="annHeight"/>              </div>              <span class="col-sm-3 control-label text-left" data-lang="Annotations.Measurement.TxtUnit"/>            </div>            <div class="form-group">              <label class="col-sm-3 control-label" for="annoDesc" data-lang="Annotations.Dialog.Description">Description:</label>              <div class="col-sm-6">                <textarea class="form-control" id="annoDesc" row="3"></textarea>               </div>            </div>            <div class="form-group">              <label class="col-sm-3 control-label" for="color" data-lang="Annotations.Dialog.Color">Color:</label>              <div class="col-sm-6" >                <div id="colorpicker" style="padding:0;border:0" class="input-group input-append color form-control " data-color="#0d29e7" data-color-format="hex">                  <input id="color" class="form-control" type="text" value="#0d29e7"  readonly>                  <span class="input-group-addon add-on"><i id="colorView" style="background-color:#0d29e7"></i></span>                </div>              </div>            </div>            <div class="form-group arrow">              <label class="col-sm-3 control-label" for="color" data-lang="Labels.Arrow">Arrow:</label>              <div class="col-sm-6" >                <label class="radio arrow_label"><input type="radio" name="which" value="2"><span data-lang="Labels.Arrow_Start"></span></label>                <label class="radio arrow_label"><input type="radio" name="which" value="1"><span data-lang="Labels.Arrow_End"></span></label>                <label class="radio arrow_label"><input type="radio" name="which" value="3"><span data-lang="Labels.Arrow_Double"></span></label>              </div>            </div>            <div class="form-group">              <div class="col-sm-offset-3 col-sm-6 controls">                <label class="checkbox">                  <input id="chkAutoShow" type="checkbox"><span data-lang="Buttons.AutoShow">Show Automatically</span>                </label>              </div>            </div>          </form>        </div>      <div class="modal-footer">        <button class="btn btn-primary" id="btnAnnDiaSubmit" data-lang="Buttons.Ok">OK</button>        <button class="btn btn-default" data-dismiss="modal" aria-hidden="true"  data-lang="Buttons.Cancel">Cancel</button>      </div>    </div></div></div>', jq = $(html), jqDialog = $(dialog), tt, isColor = !1, colorPicker, shapeCanvas, status = jq.find("#ann_status"), lnkSave = jq.find("#lnkSave").hide(), name = MedLang.getString("Menus.Annotation"), editor = new AnnotationEditor(viewer), isDemo = !1, isFirstAfterOpen = !1;
  function onBeforeAnnotationChange(e, t, n) {
    viewer.trigger("beforeAnnotationChange", e, t, n),
        t.eventAction = e,
        t.eventStatus = 1
  }
  function onAnnotationChanged(e, t) {
    viewer.trigger("annotationChanged", e, t)
  }
  function showMeasurement(e) {
    var t;
    !0 === e ? t = SlideViewerConfig.showMeasurement() : (t = !shapeCanvas.isAlwaysDisaplyMeasurement,
        SlideViewerConfig.showMeasurement(t)),
        shapeCanvas.isAlwaysDisaplyMeasurement = t,
        shapeCanvas.showMeasurement(t)
  }
  function showDialog() {
    jqDialog.modal("show").show()
  }
  function updateModel() {
    ShapeDefaultConfig.defaultColor = jqDialog.find("#color").val(),
        ShapeDefaultConfig.lineWidth = jqDialog.find("#lineWidth").val(),
        SlideViewerConfig.autoShowAnnoDialog = jqDialog.find("#chkAutoShow")[0].checked;
    var e = shapeCanvas.getActiveShape();
    e && (e.isDemo || onBeforeAnnotationChange(AnnotationAction.Modify, e),
        e.type == AnnotationType.Rectangle ? e.resize($("#annWidth").val(), $("#annHeight").val()) : e.type == AnnotationType.Arrow && (e.which = jqDialog.find("input[name=which]:checked").val()),
        e.width = ShapeDefaultConfig.lineWidth,
        e.color = ShapeDefaultConfig.defaultColor,
        e.name = jqDialog.find("#annoName").val(),
        e.description = jqDialog.find("#annoDesc").val(),
    e.inpElmt && $(e.inpElmt).val(e.description),
        e.isMeasurementChanged = !0,
    e.isDemo || shapeCanvas.dirtyCanvas())
  }
  !function() {
    jq.find("[data-lang]").html(function() {
      var e = $(this).attr("data-lang");
      return SlideViewerStrings.getString(e) || MedLang.getString(e)
    }),
        jqDialog.find("[data-lang]").html(function() {
          var e = $(this).attr("data-lang");
          return SlideViewerStrings.getString(e) || MedLang.getString(e)
        }),
        SlideViewerSupport.canvas ? SlideViewerConfig.compactBrowsing() && jq.find("div.compactshade").show() : jq.find("div.canvas").show(),
        shapeCanvas = viewer.getShapeCanvas(),
        isDemo = SlideViewerConfig.fluorescent(),
        shapeCanvas.demoShapeFadeOutInterval = 2e3,
        shapeCanvas.demo(isDemo),
        showMeasurement(!0),
        jq.delegate("[data-type]", "click", function() {
          if (!$(this).hasClass("disabled")) {
            var type = $(this).attr("data-type"), enableEdit;
            switch (type) {
              case "Hand":
                viewer.getShapeCanvas().setSelectedEnable(!1);
                break;
              case "Select":
                viewer.getShapeCanvas().setSelectedEnable(!0);
                break;
              case "CurveEditor":
              case "PointMinus":
                console.log('删除点')
                enableEdit = editor.enable(type);
                break;
              default:
                var key = "Annotations.Draw." + type;
                viewer.showMessage(SlideViewerStrings.getString(key) || MedLang.getString(key)),
                    viewer.getShapeCanvas().setDrawAnnotationType(eval("AnnotationType." + type)),
                    viewer.trigger("draw.annotation", key)
            }
            !1 !== enableEdit && $(this).addClass("active").siblings().removeClass("active"),
            enableEdit || editor.enable(!1),
                toggleEditable(!enableEdit),
                triggerToolChange()
          }
        });
    var showType = SlideViewerConfig.annShowType();
    jq.find("input.measurement").bind("click", showMeasurement)[0].checked = shapeCanvas.isAlwaysDisaplyMeasurement,
        jq.find("input.s_name").bind("click", function() {
          1 == (1 & showType) ? showType -= 1 : showType |= 1,
              SlideViewerConfig.annShowType(showType),
              viewer.getShapeCanvas().refreshImageShapes()
        })[0].checked = 0 < (1 & showType),
        jq.find("input.s_measurement").bind("click", function() {
          2 == (2 & showType) ? showType -= 2 : showType |= 2,
              SlideViewerConfig.annShowType(showType),
              viewer.getShapeCanvas().refreshImageShapes()
        })[0].checked = 0 < (2 & showType),
        $("[data-type]", jq).attr("title", function() {
          var e = "Annotations.Draw." + $(this).attr("data-type");
          return SlideViewerStrings.getString(e) || MedLang.getString(e)
        });
    var adminOp = jq.find("input[type=radio][name=visible]").bind("change", function() {
      viewer.provider.annVisible(viewer.getCurrentImage().id, this.value),
      0 < viewer.getShapeCanvas().getAnnotations().length && (shapeCanvas.isShapeChanged = !0,
          saveAnnotation())
    });
    _slideAuth < 0 && adminOp.eq(1).attr("disabled", "true").siblings("span").css("color", "#aaa"),
        jq.find("input.demo_ann").bind("click", function() {
          this.checked ? (isDemo = !0,
              viewer.showMessage(MedLang.getString("Labels.fluorescent_enter"))) : (isDemo = !1,
              viewer.showMessage(MedLang.getString("Labels.fluorescent_exit"))),
              shapeCanvas.demo(isDemo),
              SlideViewerConfig.fluorescent(isDemo)
        })[0].checked = isDemo;
    var list = new AnnotationList(viewer), module, lastAction, lastShape;
    function updateBtnStatus() {
      if (jq.find("a.toolbutton").removeClass("disabled"),
          module) {
        for (var e, t = viewer.getShapeCanvas().getAnnotations(), n = 0, a = 0; a < t.length; a++)
          -2 == t[a].status && n++;
        0 == n ? e = jq.find("a.toolbutton:not(.edit):not(.task.marquee)") : "object" == module ? e = jq.find("a.toolbutton:not(.edit):not(.task)") : "annotation" == module && (e = jq.find("a.toolbutton.marquee:not(.task),#lnkVoiceAnnotation")),
            e.addClass("disabled")
      }
    }
    function toggleEditable(e) {
      e ? $("#lnkEdit,#lnkDelete", jq).removeAttr("disabled") : $("#lnkEdit,#lnkDelete", jq).attr("disabled", !0)
    }
    function saveAnnotation() {
      if (viewer.provider.isReadOnly())
        shapeCanvas.isShapeChanged = !1;
      else if (!(lastShape = shapeCanvas.getActiveShape()) || lastShape.isEndDrawing) {
        if (updateBtnStatus(),
        "Del" == lastAction && "function" == typeof lastShape.delete && lastShape.delete(),
            status.html(MedLang.getString("Annotations.save.drawing")),
        lastShape && 0 != lastShape.status)
          return;
        if (lnkSave.show(),
        "PointMinus" == editor.enable())
          console.log('删除点3')
          return;
        editor.enable(!1),
            toggleEditable(!0),
            clearTimeout(tt),
            tt = setTimeout(shapeCanvas.saveAnnotations, 2e3)
      }
    }
    function triggerToolChange() {
      viewer.trigger("AnnotationToolChange")
    }
    list.bind("close", function() {
      jq.find("input.ann_list")[0].checked = !1,
          SlideViewerConfig.showAnnotationList(!1)
    }),
        jq.find("input.ann_list").bind("click", function() {
          this.checked ? (list.show(),
              SlideViewerConfig.showAnnotationList(!0)) : list.hide()
        }),
    SlideViewerConfig.showAnnotationList() && jq.find("input.ann_list").click(),
        viewer.bind("m.open", function() {
          isFirstAfterOpen = !0
        }),
        viewer.bind("updatefinish", function() {
          isFirstAfterOpen && (isFirstAfterOpen = !1,
              adminOp.filter("[value=" + viewer.provider.annVisible(viewer.getCurrentImage().id) + "]").attr("checked", "true"))
        }),
        viewer.bind("taskChanged", function(e, t, n) {
          module = e ? n : null,
              updateBtnStatus(),
              viewer.getShapeCanvas().setDrawAnnotationType(null),
              $("#lnkHand").click()
        }),
        $("#lnkEdit", jq).bind("click", function() {
          var e = shapeCanvas.getActiveShape();
          !e || 0 !== e.status && -4 !== e.status ? viewer.showMessage(MedLang.getString("Messages.SelectAnnotation")) : showDialog()
        }),
        $("#lnkDelete", jq).bind("click", function() {
          var e = shapeCanvas.getActiveShape();
          e && !e.isLocked ? shapeCanvas.deleteAnnotation() : viewer.showMessage(MedLang.getString("Messages.SelectAnnotation"))
        }),
        lnkSave.bind("click", function() {
          shapeCanvas.saveAnnotations()
        }),
        jqDialog.appendTo("body").modal({
          show: !1,
          backdrop: "static"
        }).on("show.bs.modal", function() {
          if (!isColor) {
            var e = shapeCanvas.getActiveShape();
            $("#chkAutoShow", jqDialog).attr("checked", SlideViewerConfig.autoShowAnnoDialog),
            e && (e.isEditing = !0,
                jqDialog.find(".rectangle,.arrow").hide(),
                e.type == AnnotationType.Rectangle ? jqDialog.find(".rectangle").show().end().find("#annWidth").val(e.originalWidth).end().find("#annHeight").val(e.originalHeight) : e.type == AnnotationType.Arrow && (jqDialog.find(".arrow").show(),
                    jqDialog.find("input[name=which]").val([e.which])),
                $("#lineWidth", jqDialog).val(e.width),
                colorPicker.colorpicker("setValue", e.color),
                $("#annoName", jqDialog).val(e.name),
                $("#annoDesc", jqDialog).val(e.description))
          }
        }).on("hide.bs.modal", function() {
          var e = shapeCanvas.getActiveShape();
          e && (e.isEditing = void 0,
              e.lastUpdateTimeStamp = Date.now())
        }).bind("click", function(e) {
          e.stopPropagation()
        }),
        colorPicker = jqDialog.find("#colorpicker").colorpicker().on("changeColor", function(e) {
          jqDialog.find("#color").val(e.color.toHex())
        }).on("show", function() {
          isColor = !0
        }).on("hide", function() {
          isColor = !1
        }),
        shapeCanvas.bind("shapechanged", saveAnnotation),
        shapeCanvas.bind("beforeAnnotationChange", function(e, t) {
          lastAction = t,
              lastShape = e
        }),
        viewer.bind("draw.annotation", function() {
          shapeCanvas.saveAnnotations(),
              clearTimeout(tt)
        }),
        shapeCanvas.bind("shapedrawend", function() {
          var e = shapeCanvas.getActiveShape();
          e.type.startsWith("Polygon") && -1 !== e.status && 2 !== e.eventStatus && (onAnnotationChanged(e.eventAction, e),
              e.eventStatus = 2,
              e.eventAction),
              SlideViewerConfig.autoShowAnnoDialog && jqDialog ? (showDialog(),
              isDemo || clearTimeout(tt)) : 0 == lastShape.status && (clearTimeout(tt),
                  tt = setTimeout(function() {
                    shapeCanvas.saveAnnotations()
                  }, 2e3)),
              jq.find("#lnkSelect").addClass("active").siblings().removeClass("active"),
              viewer.getShapeCanvas().setSelectedEnable(!0),
          "CurveEditor" == lastShape.type && setTimeout(triggerToolChange, 1)
        }),
        jqDialog.find("#btnAnnDiaSubmit").bind("click", function() {
          shapeCanvas.getActiveShape().action = "Modify",
              updateModel(),
              shapeCanvas.showImageShapes(),
              jqDialog.modal("hide")
        }),
        shapeCanvas.bind("saveimageannotationscompleted", function(e) {
          e.success ? (lnkSave.hide(),
              status.html(MedLang.getString("Annotations.save.success")),
              viewer.broadcast({
                type: "SaveAnnotation",
                slideId: viewer.getCurrentSlide().id,
                userId: userId
              })) : (viewer.showMessage(SlideViewerStrings.getString("Messages.SaveAnnotationFailed")),
              ErrorOutput("SaveAnnotations", e),
              status.html(MedLang.getString("Annotations.save.fail")))
        }),
        viewer.bind("saveAnnotationsComplated", function(e) {
          !0 === e ? (lnkSave.hide(),
              status.html(MedLang.getString("Annotations.save.success"))) : !1 === e ? status.html(MedLang.getString("Annotations.save.fail")) : status.html(MedLang.getString("Annotations.save.drawing"))
        }),
        shapeCanvas.bind("beforeAnnotationChange", function(e, t, n) {
          1 != e.eventStatus && (e.editShape && (e.eventStatus = 1,
              e = e.editShape,
              t = AnnotationAction.Modify),
              onBeforeAnnotationChange(t, e, n),
          n.IsCancel && (delete e.eventAction,
              delete e.eventStatus))
        }),
        shapeCanvas.bind("shapechanged", function(e, t) {
          if (console.log(e),
              !e) {
            var n = shapeCanvas.getActiveShape();
            -1 != n.status && 2 != n.eventStatus && (onAnnotationChanged(n.eventAction, n),
                n.eventStatus = 2,
                n.eventAction)
          }
        }),
        viewer.bind("beforeMinusPoint", function(e) {
          onBeforeAnnotationChange(AnnotationAction.Modify, e)
        }),
        $(window).bind("beforeunload", function() {
          shapeCanvas.saveAnnotations()
        }),
    3 == $.query.get("style") && jq.children(":not(.style-3)").hide()
  }(),
      this.name = function() {
        return name
      }
      ,
      this.elmt = jq[0]
};
Shape.prototype.drawMeasurement = function(e, t, n, a, i, o, s, r) {
  var l = "";
  this.externalData && null != this.externalData.owner && (l = appendLine(l, this.externalData.owner),
      r = this.externalData.color);
  var d = SlideViewerConfig.annShowType();
  0 < (1 & d) && ("" !== l && (l = appendLine(l, "")),
      l = appendLine(l, this.name),
  a && (l = appendLine(l, a))),
  0 < (2 & d) && ("" !== l && (l = appendLine(l, "")),
      l += n),
  l && this.drawText(e, t, l, i, o, s, r)
}
    ,
    ShapeCanvas.prototype.delAnnotations = function(e, t) {
      var n = [];
      if (e && "loading" != e)
        for (var a = 0; a < e.length; a++)
          n.push(e[a].guid);
      this.deleteAnnotations(n, t)
    }
;
var RelevantAnnotation = function(r) {
  var l = $('<div class="list_items relevant_annotation"></div>')
      , e = MedLang.getString("Menus.RelevantAnnotations")
      , t = SlideViewerConfig.language;
  "zh" == t && (t = "zh_CN");
  var d, n = {}, a = this, i = {}, c = r.getCurrentSlide().id.toLowerCase(), o = '<p style="border-bottom:1px solid #EBEBEB;color: #aaa;text-align: center;line-height: 3px;"><span style="display:none;background: white;padding: 0 5px;">App</span></p>', s = {
    en: {
      sensitivity: "sensitivity",
      specificity: "specificity",
      accuracy: "accuracy",
      diff: "Diff",
      copy: "Copy",
      empty: "This annotation isn't valid data",
      inference: "Analyze",
      training: "Training"
    },
    zh: {
      sensitivity: "敏感性",
      specificity: "特异性",
      accuracy: "准确度",
      diff: "对比",
      copy: "复制",
      empty: "该标注无有效数据",
      inference: "分析",
      training: "训练"
    }
  };
  function u() {
    d = r.getCurrentImage().id,
        null == n[d] ? (n[d] = "loading",
            r.provider.getAnnotationUsers(r.getCurrentImage().id, function(e) {
              e.success ? (n[d] = {
                list: e.users,
                anns: {}
              },
                  b(e.users),
                  e.users && 0 < e.users.length ? a.show(!0) : a.show(!1)) : (n[d] = void 0,
                  ErrorOutput("GetRelevantSlide", e))
            })) : "loading" !== n[d] && b(n[d].list)
  }
  r.bind("m.open", u),
      r.bind("task.finish", function(e, t) {}),
      r.bind("SubAnnotation", h),
      l.delegate("input", "change", function() {
        var t = this;
        f($(this).attr("data-id"), $(this).attr("data-name"), function(e) {
          if (t.checked) {
            if (0 == e.length)
              return t.disabled = !0,
                  t.className = "hide",
                  void $(t).closest("label").addClass("disabled");
            v(e, !1)
          } else
            m(e, !1)
        })
      }),
      r.bind("taskChanged", function(e) {
        l.find("input").prop("checked", !1).prop("disabled", !!e)
      });
  var p, g = {};
  function h(i, o, s, e) {
    var t = "/topic/Slides/" + c + "/Annotations/" + i;
    e ? r.provider.unsubscribe(t) : (r.provider.subscribe(t, function(e) {
      var t = e.body
          , n = 1 == t || 5 == _slideAuth && 5 == t;
      if (g[i] !== n) {
        var a = l.find("input[data-id=" + i + "]");
        0 == a.length && n ? l.prepend(y({
          id: i,
          name: o,
          hasAvatar: s
        }, !0)) : 0 < a.length && !n && a.closest("label").remove()
      } else {
        if (!l.find("input[data-id=" + i + "]").prop("checked"))
          return void r.provider.releaseAnnotation(d, i);
        if (!n)
          return
      }
      g[i] = n,
          f(i, o, function(e, t) {
            m(t, !1),
                v(e, !1)
          }, !0)
    }),
        l.find("input[data-id=" + i + "]").click())
  }
  function f(t, e, n, a) {
    clearTimeout(i[t]),
        i[t] = setTimeout(function() {
          w(!0, t)
        }, 1e3),
        r.provider.getAnnotation(c, d, function(e) {
          w(!1, t),
          e.success && n(e.annotations, e.oldAnnotations)
        }, t, e, a)
  }
  function v(e, t) {
    r.getShapeCanvas().addAnnotations(e, t)
  }
  function m(e, t) {
    r.getShapeCanvas().delAnnotations(e, t)
  }
  function b(e) {
    var t = ""
        , n = 0;
    if (e)
      for (var a = 0; a < e.length; a++)
        0 == n && n != e[a].type && (n = e[a].type,
            t += o),
            t += y(e[a]);
    l.prepend(t).delegate(".btn.delete", "click", function() {
      var e = this
          , t = $(this).parent().hide()
          , n = t.siblings(".deleteAlert").fadeIn("fast");
      return this.init || (this.init = !0,
          n.bind("mouseenter", function() {
            clearTimeout(e.tt)
          }).bind("mouseleave", function() {
            e.tt = setTimeout(function() {
              n.fadeOut("fast"),
                  t.css("display", "")
            }, 1e3)
          })),
          !1
    }).delegate(".deleteAlert", "click", function() {
      return !1
    }).delegate(".deleteAlert>span", "click", function() {
      var n = $(this)
          , e = n.attr("data-id");
      return r.provider.deleteTask("appId", e, function(e) {
        if (e.success) {
          var t = n.parent().parent().fadeOut(function() {
            t.remove()
          });
          t.find("input[type=checkbox]").prop("checked") && t.click()
        }
      }),
          !1
    }).delegate(".btn.copy", "click", function() {
      var i = $(this).closest("label").find("input:checkbox");
      return f(i.attr("data-id"), i.attr("data-name"), function(e) {
        for (var t = [], n = 0; n < e.length; n++) {
          var a = $.extend({}, e[n]);
          a.guid = guidGenerator(),
              delete a.isLocked,
              delete a.status,
              delete a.externalData,
              t.push(a)
        }
        v(t, !0),
        i.prop("checked") && i.click()
      }),
          !1
    }).delegate(".btn.diff", "click", function() {
      var a = $(this).closest("label")
          , e = a.find("input:checkbox");
      return f(e.attr("data-id"), e.attr("data-name"), function(e) {
        var t = r.getCurrentImage()
            , n = function(e, t, n) {
          if (!p) {
            var a, i;
            e.width > e.height ? i = (a = 256) * e.height / e.width : a = (i = 256) * e.width / e.height,
                (p = document.createElement("canvas")).scale = a / e.width,
                p.width = a,
                p.height = i,
                p.className = "diff"
          }
          var o = p.getContext("2d");
          return o.clearRect(0, 0, p.width, p.height),
              o.save(),
              o.scale(p.scale, p.scale),
              o.fillStyle = "red",
              o.globalCompositeOperation = "source-over",
              S(o, t),
              o.fillStyle = "blue",
              o.globalCompositeOperation = "lighter",
              S(o, n),
              o.restore(),
              function(e) {
                for (var t = e.data, n = 0, a = 0, i = 0, o = 0; o < t.length; o += 4) {
                  if (0 == t[o]) {
                    if (0 == t[o + 1] && 0 == t[o + 2]) {
                      i++;
                      continue
                    }
                    if (0 == t[o + 1] && 255 == t[o + 2]) {
                      a++;
                      continue
                    }
                  }
                  255 == t[o] && 0 == t[o + 1] && 0 == t[o + 2] && n++
                }
                var s = e.width * e.height - n - a - i
                    , r = 0 == n && 0 == s || 0 == a && 0 == s;
                return {
                  sensitivity: r ? 0 : s / (n + s),
                  specificity: r ? 0 : i / (i + a),
                  accuracy: r ? 0 : s / (n + a + s)
                }
              }(o.getImageData(0, 0, p.width, p.height))
        }({
          width: t.width,
          height: t.height
        }, t.annotations, e);
        !function(e, t) {
          var n = [MedLang.getString("sensitivity", s), " ", a(t.sensitivity), "<br>", MedLang.getString("specificity", s), " ", a(t.specificity), "<br>", MedLang.getString("accuracy", s), " ", a(t.accuracy)];
          function a(e) {
            return Math.round(1e3 * e) / 10 + "%"
          }
          e.find(".diff-result").html(n.join(""))
        }(a, n)
      }),
          !1
    }),
    1 == $.query.get("ra") && l.find("input").click()
  }
  function y(e, t) {
    var n = '<label class="checkbox">';
    return n += '<div><input type="checkbox" data-id="' + e.id + '" data-name="' + (e.name || e.appName || "") + '" ' + (t ? "checked" : "") + ' ></div>            <div class="thumbnail"><img src="/Account/Users/' + e.id + '/Avatar"></div>            <div style="padding-left: 5px;">',
        n += e.name,
        n += '</div><div class="diff-result"></div></label>'
  }
  function S(e, t) {
    for (var n = 0; n < t.length; n++) {
      var a = t[n];
      switch (a.type) {
        case "Polygon":
        case "RoundedCurve":
        case "FreeRoundedCurve":
          e.beginPath();
          for (var i = 0; i < a.points.length; i++) {
            var o = a.points[i];
            0 == i ? e.moveTo(o.x, o.y) : e.lineTo(o.x, o.y)
          }
          e.fill();
          break;
        case "Rectangle":
          e.fillRect(a.region.x, a.region.y, a.region.width, a.region.height);
          break;
        case "Ellipse":
          var s = a.region.width / 2
              , r = a.region.height / 2
              , l = a.region.x + s
              , d = a.region.y + r
              , c = .5522848 * s
              , u = .5522848 * r;
          e.beginPath(),
              e.moveTo(l - s, d),
              e.bezierCurveTo(l - s, d - u, l - c, d - r, l, d - r),
              e.bezierCurveTo(l + c, d - r, l + s, d - u, l + s, d),
              e.bezierCurveTo(l + s, d + u, l + c, d + r, l, d + r),
              e.bezierCurveTo(l - c, d + r, l - s, d + u, l - s, d),
              e.fill();
          break;
        case "Circle":
          var p = CalcRadius({
            x: 0,
            y: 0
          }, {
            x: a.region.width,
            y: a.region.height
          });
          e.beginPath(),
              e.arc(a.region.x, a.region.y, p, 0, 2 * Math.PI, !1),
              e.fill();
          break;
        case "CircleThreePoints":
          var g = CalcCenterPoint(a.points[0], a.points[1], a.points[2]);
          p = CalcRadius(g, a.points[0]);
          e.beginPath(),
              e.arc(g.x, g.y, p, 0, 2 * Math.PI, !1),
              e.fill()
      }
    }
  }
  function w(e, t) {
    clearTimeout(i[t]),
    !e && i[t] || (r.showMessage(MedLang.getString("Loading"), e ? 6e4 : 0),
    e && (i[t] = !1))
  }
  this.name = function() {
    return e
  }
      ,
      this.elmt = l,
      this.show = function() {
        return !1
      }
};
SlideProvider.prototype.getAnnotationUsers = function(e, t) {
  var n = this;
  this.getExtPromise().done(function(e) {
    n.getRequest("Annotations/Users?role=" + e.role, !0, {}, function(e, t) {
      e.users = t
    }, t)
  })
}
;
var SlideImageAdjustments = function(l) {
  l.slideImageAdjustments = this;
  var e = '<div><dl style="margin: 0;">            <dt id="enableAdjustment" class="hide"><label class="checkbox" style="font-weight: bold;">                    <input type="checkbox"><span data-lang="Labels.EnableAdjust">启用调节</span>                </label>            </dt>            <dt id="defaultAdjustment" class="hide" >            <div data-lang="Default.presets" style="width:100%;margin-bottom: 2px;"></div>            <div style="border-bottom:1px solid #EBEBEB;">                <div class="presets" style="display:flex;flex-wrap:wrap;justify-content:space-between;"></div><p/></div>            <p/>            </dt>\t\t\t<dd >                 <label class="label label-default" for="gamma" data-lang="ImageAdjustments.Gamma">因子</label>                 <span id="gammaValue" class="">1</span>                 <div id="gamma" class="" data-role="slider"></div>             </dd>             <p/>\t\t\t<dd data-role="fieldcontain"> \t\t\t\t<label class="label label-default" for="contrast" data-lang="ImageAdjustments.Contrast">最小值</label> \t\t\t\t<span id="minValue" class="">0</span>-<span id="maxValue" class="">255</span> \t\t\t\t<div id="contrast" data-role="slider"></div> \t\t\t</dd>\t\t\t<p/>\t\t\t<dd data-role="fieldcontain"> \t\t\t\t<label class="label label-default" for="saturation" data-lang="ImageAdjustments.Saturation">饱和度</label> \t\t\t\t<span id="saturationValue" class="">0</span> \t\t\t\t<div id="saturation" class="" data-role="slider"></div> \t\t\t\t</dd> \t\t\t<p/>\t\t\t<dd data-role="fieldcontain"> \t\t\t\t<label class="label label-default" for="sharpness" data-lang="ImageAdjustments.Sharpness">锐度</label> \t\t\t\t<span id="sharpnessValue" class="">0</span> \t\t\t\t<div id="sharpness" class="" data-role="slider"></div> \t\t\t</dd> \t\t\t<p/>\t\t\t<dt data-lang="ImageAdjustments.Channels">颜色通道</dt> \t\t\t<dd data-role="fieldcontain"> \t\t\t\t<label class="label label-default" for="red" data-lang="ImageAdjustments.Red">红</label> \t\t\t\t<span id="redValue" class="">1</span> \t\t\t\t<div id="red" class="" data-role="slider"></div> \t\t\t\t<label class="label label-default" for="green" data-lang="ImageAdjustments.Green">绿</label> \t\t\t\t<span id="greenValue" class="">1</span> \t\t\t\t<div id="green" class="" data-role="slider"></div> \t\t\t\t<label class="label label-default" for="blue" data-lang="ImageAdjustments.Blue">蓝</label> \t\t\t\t<span id="blueValue" class="">1</span> \t\t\t\t<div id="blue" class="" data-role="slider"></div> \t\t\t<label class="checkbox">                <input type="checkbox" id="chkAllChannels"><span data-lang="ImageAdjustments.AllChannels">所有通道</span>            </label>\t\t</dd> \t\t</dl>\t\t<p class="border-top"></p>\t\t<div class="text-right">          <a class="btn btn-primary"  id="lnkOK" data-lang="Buttons.Save"></a>          <a class="btn btn-primary"  id="lnkReset" data-lang="Buttons.Reset"></a>        </div><div id="shade" class="hide"></div>        <div class="compactshade"><span class="suport" data-lang="Compact.Message">不支持</span></div>        <div class="canvas"><span class="suport" data-lang="Labels.NotSupported">不支持</span></div>      </div>'
      , d = $(e);
  e = null;
  var t, n, c, a, i, o = MMDSSlideViewerStrings.getString("Menus.ImageAdjustment"), s = l.getImageProcessing(), u = this, r = SlideViewerConfig.isClientImageAdjust, p = !1, g = "#gamma", h = "#contrast", f = "#min", v = "#max", m = "#red", b = "#green", y = "#blue", S = "#saturation", w = "#sharpness", C = "#chkAllChannels";
  function k(e) {
    e.success ? (a = c.clone(),
        l.showMessage(SlideViewerStrings.getString("Messages.SaveAdjustmentSuccess")),
        $("#lnkOK", d).hide(),
        l.trigger("m.SaveImageAdjust", c)) : (l.showMessage(SlideViewerStrings.getString("Messages.SaveAdjustmentFailed")),
        $("#lnkOK", d).show(),
        ErrorOutput("SaveImageAdjustment", e))
  }
  function x() {
    clearTimeout(t),
    r && s && (SlideViewerConfig.enableImageAdjustment || (SlideViewerConfig.enableImageAdjustment = !0,
        l.reset()),
        l.update())
  }
  function A() {
    r || (l.provider.updateFactor("BASE", c),
        l.reloadImage()),
        M()
  }
  function T() {
    var e = function(e) {
      var t = 50;
      e < 1 ? t = 50 * e + .5 : 1 < e && (t = 50 + 50 * (e - 1) / 8.82 + .5);
      return t
    }(c.gamma);
    $(g, d).slider("value", e),
        $(g + "Value", d).html(c.gamma.toFixed(2).toString()),
        $(h, d).slider("values", [c.contrastMin, c.contrastMax]),
        $(f + "Value", d).html(c.contrastMin.toString()),
        $(v + "Value", d).html(c.contrastMax.toString());
    var t = I(c.red);
    $(m, d).slider("value", t),
        $(m + "Value", d).html(c.red.toFixed(2).toString()),
        t = I(c.green),
        $(b, d).slider("value", t),
        $(b + "Value", d).html(c.green.toFixed(2).toString()),
        t = I(c.blue),
        $(y, d).slider("value", t),
        $(y + "Value", d).html(c.blue.toFixed(2).toString()),
        $(S, d).slider("value", c.saturation),
        $(S + "Value", d).html(c.saturation.toString()),
        $(w, d).slider("value", c.sharpness),
        $(w + "Value", d).html(c.sharpness.toString())
  }
  function M(e) {
    n && !c.isEquals(a) && (clearTimeout(t),
        r ? (n.imageAdjustment = c,
        l.canWrite() && l.provider && s && (t = setTimeout(function() {
          s.saveImageAdjustment(n.imageAdjustment)
        }, e ? 0 : 2e3))) : t = setTimeout(function() {
          l.provider.updateImageAdjustment("SlideId", "ImageId", c, k, "BASE")
        }, e ? 0 : 2e3))
  }
  function R() {
    n = l.getCurrentImage(),
        a = r ? (c = n && n.imageAdjustment ? n.imageAdjustment : new ImageAdjustment).clone() : (c = l.provider.getAdjustFactor("BASE")).clone(),
        T(),
        function() {
          var i, o = [], s = {};
          function r(e) {
            var t = parseInt($(e).closest("[data-idx]").attr("data-idx"));
            return t = o[t],
            s["user_" + t] || s["sys_" + t]
          }
          l.provider.getDefaults(function(e) {
            adjusts = e.adjusts || [];
            for (var t = "", n = 0; n < adjusts.length; n++) {
              var a = adjusts[n];
              a.system ? (s["sys_" + a.title] = a,
                  t += '<div class="btn-group" style="margin:1px;margin-bottom:4px;" data-idx="' + o.length + '">                    <button type="button" class="btn btn-primary main" >' + a.title + '</button>                    <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">                        <span class="caret"></span>                        <span class="sr-only">Toggle Dropdown</span>                    </button>                <ul class="dropdown-menu">                    <li><a href="#" class="overwrite" data-lang="Default.overwrite">Overwrite Preset</a></li>                    <li><a href="#" class="restore" data-lang="Default.restore">Restore to Default</a></li>                </ul>                </div>',
                  o.push(a.title)) : a.adjustment && (s["user_" + a.title] = a)
            }
            t && ((t = $(t)).find("[data-lang]").html(function() {
              var e = $(this).attr("data-lang");
              return SlideViewerStrings.getString(e) || MMDSSlideViewerStrings.getString(e)
            }),
                i = d.find("#defaultAdjustment").removeClass("hide").find(".presets").append(t).delegate("button.main", "click", function(e) {
                  var t = r(this);
                  u.update(t.adjustment);
                  var n = MMDSSlideViewerStrings.getString("Default.preset");
                  n = (n = n.replace("{source}", MMDSSlideViewerStrings.getString(t.system ? "Default.msg_source_sys" : "Default.msg_source_user"))).replace("{title}", t.title),
                      l.showMessage(n)
                }).delegate("a.overwrite", "click", function(e) {
                  var t = r(this);
                  t.system && (t = $.extend(!0, {}, t)),
                      t.adjustment = $.extend(t.adjustment, c),
                      t.system = !1,
                      s["user_" + t.title] = t,
                      l.provider.updateDefault(t, function(e) {})
                }).delegate("a.restore", "click", function(e) {
                  var t = r(this);
                  t && (l.provider.deleteDefault(t, function(e) {}),
                      delete s["user_" + t.title])
                }).find(".dropdown-toggle").dropdown().end().find("button.main"))
          }),
              d.closest(".popover-content").css("overflow", "visible").bind("click", function() {
                $(document).click()
              }),
              $(document).bind("keydown", function(e) {
                if (!e.ctrlKey && !e.shiftKey && e.altKey && 49 <= e.which && e.which <= 57) {
                  var t = e.which - 49;
                  t < adjusts.length && i.eq(t).click()
                }
              })
        }(),
        $(window).bind("beforeunload", function() {
          M(!0)
        })
  }
  function I(e) {
    var t = 50;
    return e < 1 ? t = 50 * (e - .05) : 1 < e && (t = 12.5 * (e - 1) + 50),
        t
  }
  function D(e) {
    var t = 1;
    return e < 50 ? t = .05 + e / 50 : 50 < e && (t = 1 + (e - 50) / 12.5),
        t
  }
  $("[data-lang]", d).html(function() {
    var e = $(this).attr("data-lang");
    return SlideViewerStrings.getString(e) || MMDSSlideViewerStrings.getString(e)
  }),
      i = navigator.appVersion.split(";"),
      !SlideViewerSupport.canvas || 1 < i.length && "MSIE9.0" == i[1].replace(/[ ]/g, "") ? d.find("div.canvas").show() : SlideViewerConfig.compactBrowsing() && d.find("div.compactshade").show(),
      $(g, d).slider({
        min: 1,
        max: 100,
        value: 50,
        slide: function(e, t) {
          var n = D(t.value);
          $(g + "Value", d).html(n.toFixed(2).toString()),
          e.originalEvent && c.gamma != n && (c.gamma = n,
              x())
        },
        stop: A
      }),
      $(h, d).slider({
        range: !0,
        min: 0,
        max: 255,
        values: [0, 255],
        slide: function(e, t) {
          var n = t.values[0]
              , a = t.values[1];
          $(f + "Value", d).html(n.toString()),
              $(v + "Value", d).html(a.toString());
          var i = !1;
          e.originalEvent && c.contrastMin != n && (c.contrastMin = n,
              i = !0),
          e.originalEvent && c.contrastMax != a && (c.contrastMax = a,
              i = !0),
          i && x()
        },
        stop: A
      }),
      $(m, d).slider({
        min: 1,
        max: 100,
        value: 50,
        slide: function(e, t) {
          var n = t.value
              , a = D(n);
          $(m + "Value", d).html(a.toFixed(2).toString()),
          e.originalEvent && a != c.red && (c.red = a,
          p && (c.green = c.blue = c.red,
              $(b, d).slider("value", n),
              $(y, d).slider("value", n),
              $(y + "Value," + b + "Value", d).html(a.toFixed(2).toString())),
              x())
        },
        stop: A
      }),
      $(b, d).slider({
        min: 1,
        max: 100,
        value: 50,
        slide: function(e, t) {
          var n = t.value
              , a = D(n);
          $(b + "Value", d).html(a.toFixed(2).toString()),
          e.originalEvent && a != c.green && (c.green = a,
          p && (c.red = c.blue = c.green,
              $(m, d).slider("value", n),
              $(y, d).slider("value", n),
              $(y + "Value," + m + "Value", d).html(a.toFixed(2).toString())),
              x())
        },
        stop: A
      }),
      $(y, d).slider({
        min: 1,
        max: 100,
        value: 50,
        slide: function(e, t) {
          var n = t.value
              , a = D(n);
          $(y + "Value", d).html(a.toFixed(2).toString()),
          e.originalEvent && a != c.blue && (c.blue = a,
          p && (c.red = c.green = c.blue,
              $(b, d).slider("value", n),
              $(m, d).slider("value", n),
              $(b + "Value," + m + "Value", d).html(a.toFixed(2).toString())),
              x())
        },
        stop: A
      }),
      $(S, d).slider({
        min: 0,
        max: 10,
        value: 0,
        slide: function(e, t) {
          var n = t.value;
          $(S + "Value", d).html(n.toString()),
          e.originalEvent && c.saturation != n && (c.saturation = n,
              x())
        },
        stop: A
      }),
      $(w, d).slider({
        min: 0,
        max: 10,
        value: 0,
        slide: function(e, t) {
          var n = t.value;
          $(w + "Value", d).html(n.toString()),
          e.originalEvent && c.sharpness != n && (c.sharpness = n,
              x())
        },
        stop: A
      }),
      $(C, d).change(function() {
        if (p = this.checked) {
          c.green = c.blue = c.red;
          var e = I(c.red);
          $(b, d).slider("value", e),
              $(y, d).slider("value", e)
        }
      }),
      l.bind("m.open", R),
      s.bind("saveimageadjustmentcompleted", k),
      $("#lnkOK", d).bind("click", function() {
        M(!0)
      }).hide(),
      $("#lnkReset", d).bind("click", function() {
        c.reset(),
            T(),
            x(),
            A(),
        r && (SlideViewerConfig.enableProxy = !1)
      }),
  r && !SlideViewerConfig.enableProxy || ($("#enableAdjustment", d).hide(),
      $("#shade", d).hide()),
      $(".checkbox", d).bind("click", function() {
        var e = l.viewport.getBounds(!0);
        sessionStorage.setItem("sv_i", l.getCurrentImage().id),
            sessionStorage.setItem("sv_x", e.x),
            sessionStorage.setItem("sv_y", e.y),
            sessionStorage.setItem("sv_w", e.width),
            sessionStorage.setItem("sv_h", e.height),
            sessionStorage.setItem("sv_proxy", 1),
            sessionStorage.setItem("sv_sia", 1),
            window.location.href = window.location.href
      }),
      this.update = function(e, t) {
        e = e || {},
            c.gamma = e.gamma || 1,
            c.contrastMin = e.contrastMin || 0,
            c.contrastMax = e.contrastMax || 255,
            c.red = e.red || 1,
            c.green = e.green || 1,
            c.blue = e.blue || 1,
            c.saturation = e.saturation || 0,
            c.sharpness = e.sharpness || 0,
            T(),
            x(),
            A(),
            M(t)
      }
      ,
      this.getAdjustFactor = function() {
        return c
      }
      ,
      this.name = function() {
        return o
      }
      ,
      this.elmt = d[0]
}
    , RelevantSlide_Base = function(r) {
  var l, d = this;
  function e(e) {
    if (e && e.slides) {
      0 < (l = e.slides).length && d.show(!0);
      for (var t = window.sessionStorage, n = r.getCurrentSlide().id, a = $.query.get("style"), i = 0; i < l.length; i++) {
        var o = l[i]
            , s = o.id.toLowerCase();
        o.imgSrc = r.provider.getThumbnailUrl(s, "f", !0),
            o.visited = !!t.getItem(s),
            o.isCurrent = n == s,
        a && (o.url += -1 == o.url.indexOf("?") ? "?" : "&",
            o.url += "style=" + a)
      }
      d.initUI(e),
          r.trigger("loadedRelevantSlide", l, e.title)
    }
  }
  this.elmt,
      this.name = MMDSSlideViewerStrings.getString("Menus.RelevantSlide"),
      this.show = function() {
        return !1
      }
      ,
      this.initUI = function(e) {}
      ,
      setTimeout(function() {
        r.provider.getRelevantSlide(e)
      }, 1)
}
    , RelevantSlide = function(e) {
  RelevantSlide_Base.apply(this, [e]);
  var t = this
      , i = $("<div style='padding-left:10px'></div>");
  t.elmt = i[0],
  -1 < navigator.userAgent.indexOf("Safari") && -1 == navigator.userAgent.indexOf("Chrome") && i.delegate("a", "click", function() {
    $(document).fullScreen(!1)
  }),
      this.initUI = function(e) {
        e.title && i.append(['<div class="text-center"><a target="_blank" href="', e.url ? e.url : "#", '"><div class="onelintext">', e.title, "</div></a></div>"].join(""));
        for (var t = e.slides, n = 0; n < t.length; n++) {
          var a = $('<a class="media" style="position: relative;overflow: visible;"><div class="point" style="position:absolute;left:-17px;top:30px;"></div><div class="pull-left thumbnail"><img></div><div class="media-body relevant-slide"><span style="word-wrap:break-word;max-width:152px;"></span></div></a>').attr("href", t[n].url);
          a.find("img").attr("data-original", t[n].imgSrc),
              a.find("span").text(t[n].name),
          t[n].isCurrent && a.addClass("active"),
          t[n].visited && a.find(".point").css("background", "transparent"),
              i.append(a)
        }
      }
}
    , FullScreen = function(n, e) {
  var t, a = 1 === $.query.get("OpenNewWin"), i = $.support.isIE, o = parent !== window, s = !1, r = !1, l = !0;
  if (i)
    try {
      t = new ActiveXObject("WScript.Shell")
    } catch (e) {}
  var d = $('<div class="ctrl_wrap"><div class="fullscreen-group"><div class="fullscreen"></div><div></div></div></div>');
  d.find(".fullscreen-group").bind("click", function() {
    if (a) {
      var e = screen.width
          , t = screen.height;
      window.open(location.protocol + "//" + location.host + location.pathname + $.query.remove("OpenNewWin").set("full", 1).toString(), "", "fullscreen=no,scrollbars=no,toolbar=no, menubar=no,status=no,location=no,resizable=no, top=0, left=" + e + ", width=" + e + ",height=" + t)
    } else
      !i && l && r && (setTimeout(h, 10),
          l = 0),
          h()
  }),
      this.addBtn = function(e) {
        d.append(e)
      }
      ,
      e.appendChild(d[0]);
  function c() {
    return screen.height - p.height() < 70
  }
  var u, p = $(window);
  if (r = c(),
      i)
    p.bind("resize", function() {
      clearTimeout(u),
      r != c() && (u = setTimeout(function() {
        f(!r),
            v(r)
      }, 80))
    }),
        $(document).bind("keyup", function(e) {
          122 != e.keyCode || r || v(!0)
        });
  else
    var g = $(document).bind("fullscreenchange", function(e) {
      var t = !!g.fullScreen();
      !i && 0 === l && r && t ? l = !1 : (f(t),
          v(t))
    }).bind("keyup", function(e) {
      !s && 27 == e.keyCode && r && (l = 0,
          g.toggleFullScreen(),
          setTimeout(function() {
            g.fullScreen(!1),
                f(!1),
                v(!1)
          }, 50))
    });
  function h() {
    if (i)
      t ? t.SendKeys("{F11}") : n.showMessage(MMDSSlideViewerStrings.getString("Messages.F11Fullscreen"));
    else {
      try {
        if (o)
          return parent.FV_toggleFullScreen(),
              void (s = !0)
      } catch (e) {}
      $(document).toggleFullScreen()
    }
  }
  function f(e) {
    (r = e) ? d.find(".fullscreen-group").addClass("active") : d.find(".fullscreen-group").removeClass("active")
  }
  function v(e) {
    var t = {
      type: e ? "RequestFullscreen" : "ExistFullscreen",
      slideId: n.getCurrentSlide().id
    };
    n.broadcast(t)
  }
  r || 1 !== $.query.get("full") || h(),
  !i && o && (n.bind("EnterFullScreen", function() {
    v(!0),
        f(!0)
  }),
      n.bind("ExitFullScreen", function() {
        v(!1),
            f(!1)
      })),
      f(r),
      setTimeout(function() {
        r != c() && (f(r = !r),
            v(r))
      }, 1e3)
}
    , SlideRotate = function(i) {
  var o, s, r, l, d, c, a, u, p = $('<div class="rotate">\t\t<div  class="arrowN"></div>\t\t<span title="0&deg;" data-angle="0"></span>\t\t<span title="90&deg;" data-angle="90"></span>\t\t<span title="180&deg;" data-angle="180"></span>\t\t<span title="270&deg;" data-angle="270"></span>\t</div>'), g = p.find("div.arrowN"), h = p.find("span"), f = isHover = !1, e = !0, v = 0, n = 64, m = 8, b = !0;
  function y() {
    isHover = !0,
    e && (function() {
      var e = (n + 20) / 2
          , t = (n + m + 4) / 2;
      h.css("top", function() {
        return e - Math.cos(parseInt($(this).attr("data-angle")) * Math.PI / 180) * t - (m + 2) / 2
      }).css("left", function() {
        return e + Math.sin(parseInt($(this).attr("data-angle")) * Math.PI / 180) * t - (m + 2) / 2 + 1
      })
    }(),
        e = !1),
        clearTimeout(c),
        h.show()
  }
  function S() {
    isHover = !1,
    f || (c = setTimeout(function() {
      h.fadeOut()
    }, 2e3))
  }
  function w(t, e) {
    function n(e) {
      e.success ? (v = t,
          i.showMessage(MMDSSlideViewerStrings.getString("Messages.SaveRotateSuccess"))) : (i.showMessage(MMDSSlideViewerStrings.getString("Messages.SaveRotateFailed")),
          ErrorOutput("SaveRotate", e))
    }
    u = t,
        clearTimeout(a),
    null != t && t != v && (e ? i.provider.updateRotate(t, n) : a = setTimeout(function() {
      i.provider.updateRotate(t, n)
    }, 2e3))
  }
  function C(e) {
    !function(e, t, n) {
      if (e && 1 === e.nodeType && (t = parseFloat(t) || 0,
          n = parseFloat(n) || 1,
      "number" == typeof t))
        if (null != e.style.Transform)
          e.style.Transform = "rotate(" + t + "deg) scale(" + n + ")";
        else if (null != e.style.WebkitTransform)
          e.style.WebkitTransform = "rotate(" + t + "deg) scale(" + n + ")";
        else if (null != e.style.msTransform)
          e.style.msTransform = "rotate(" + t + "deg) scale(" + n + ")";
        else if (null != e.style.MozTransform)
          e.style.MozTransform = "rotate(" + t + "deg) scale(" + n + ")";
        else if (null != e.style.OTransform)
          e.style.OTransform = "rotate(" + t + "deg) scale(" + n + ")";
        else {
          var a = t * (Math.PI / 180)
              , i = Math.cos(a) * n
              , o = -1 * Math.sin(a) * n
              , s = Math.sin(a) * n
              , r = i;
          e.style.filter = "progid:DXImageTransform.Microsoft.Matrix(M11=" + i + ",M12=" + o + ",M21=" + s + ",M22=" + r + ",SizingMethod='auto expand')"
        }
    }(g[0], 180 * -o / Math.PI),
    e && (i.rotate(o, !1),
        i.update()),
        w(o)
  }
  !function() {
    var e;
    i.bind("m.open", function() {
      b = !0
    }),
        i.bind("updatefinish", function() {
          b && (b = !1,
              null == (o = i.rotate()) ? o = v = 0 : (v = o,
                  C()))
        }),
        i.bind("rotate", function(e) {
          o = e,
              C()
        }),
        h.hide(),
    $.support.touch && (p.bind("touchstart", y).bind("touchend", y),
        g.bind("touchstart", function() {
          f = !0,
              $("body").addClass("notSelect"),
          e || (e = !0,
              p.parent().bind("touchmove", a))
        })),
    $.support.mouse && (p.bind("mouseenter", y).bind("mouseleave", S),
        g.bind("mousedown", function() {
          f = !0,
              $("body").addClass("notSelect")
        }).mousewheel(function(e, t, n, a) {
          o += t * Math.PI / 180,
              C(!0)
        }));
    var t = ($.support.mouse ? "mousemove " : "") + ($.support.touch ? "touchmove" : "")
        , n = ($.support.mouse ? "mouseup " : "") + ($.support.touch ? "touchend" : "");
    function a(e) {
      if (f) {
        s || (s = p.outerWidth(),
            r = p.outerHeight());
        var t = p.offset();
        d = t.top + r / 2,
            l = t.left + s / 2;
        var n = getXYfromEvent(e);
        if (20449 < Math.pow(n[0].x - l, 2) + Math.pow(n[0].y - d, 2))
          f = !1;
        else {
          var a = n[0].y - d;
          o = Math.atan((n[0].x - l) / a),
          0 <= a && (o += Math.PI),
              C(!0)
        }
      }
    }
    $("body").bind(t, a).bind(n, function() {
      f = !1,
      isHover || (c = setTimeout(function() {
        h.fadeOut()
      }, 2e3)),
          $("body").removeClass("notSelect")
    }),
        p.delegate("span", "click", function() {
          o = -parseInt($(this).attr("data-angle")) * Math.PI / 180,
              C(!0)
        }),
        g.attr("title", function() {
          return MMDSSlideViewerStrings.getString("Labels.DragToRotate")
        }),
        $(window).bind("beforeunload", function() {
          console.log("beforeunload：rotate"),
              w(u, !0)
        })
  }(),
      this.elmt = p[0]
}
    , SlideOptions = function(a) {
  var n = "flip-navmap"
      , i = "flip-compact"
      , o = "flip-ruler"
      , s = "flip-grid"
      , r = "flip-logo"
      , l = "flip-label"
      , d = "flip-zoom"
      , c = "flip-frame2"
      , u = "flip-offset-v"
      , p = "flip-scale"
      , e = '<div style="margin: -5px -3px 2px;">        <div class="option-group">             <label for="flip-navmap" data-lang="Options.NavMap">NavMap:</label>             <div id="flip-navmap" class="btn-group"  data-toggle="buttons-radio">                <button data-type="on" class="btn btn-default" data-lang="Buttons.On">On</button>                <button data-type="off" class="btn btn-default" data-lang="Buttons.Off">Off</button>            </div>        </div>        <div class="option-group">             <label for="flip-frame" data-lang="Labels.Frame">Frame:</label>             <div id="flip-frame" class="btn-group dropdown"  data-toggle="buttons-radio">                <button class="btn btn-default dropdown-toggle" style="padding: 6px 4px; width:100%" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">                <span class="fov-btn" data-lang="Buttons.Off"></span>                <span class="caret"></span>                </button>                <ul class="dropdown-menu" aria-labelledby="dropdownMenu1" style="min-width:100%">                    <li><a href="#" data-val="0"><strong data-lang="Buttons.Off">OFF</strong></a></li>                    <li role="separator" class="divider"></li>                    <li><a href="#" data-val="0.196"><strong>40X</strong><br/><small>0.196mm<SUP>2</SUP></small></a></li>                    <li><a href="#" data-val="0.126"><strong>50X</strong><br/><small>0.126mm<SUP>2</SUP></small></a></li>                    <li><a href="#" data-val="0.031"><strong>100X</strong><br/><small>0.031mm<SUP>2</SUP></small></a></li>                </ul>            </div>        </div>        <div class="option-group">             <label for="flip-zoom" data-lang="Labels.Zoom">Zoom:</label>             <div id="flip-zoom" class="btn-group"  data-toggle="buttons-radio">                <button data-type="on" class="btn btn-default" data-lang="Buttons.On">On</button>                <button data-type="off" class="btn btn-default" data-lang="Buttons.Off">Off</button>            </div>        </div>        <div class="option-group">            <label for="flip-label" data-lang="Options.Label">Label:</label>             <div id="flip-label" class="btn-group" data-toggle="buttons-radio">                <button data-type="on" class="btn btn-default" data-lang="Buttons.On">On</button>                <button data-type="off" class="btn btn-default" data-lang="Buttons.Off">Off</button>            </div>        </div>        <div class="option-group" data-show="canvas">            <label for="flip-ruler" data-lang="Options.Ruler">Ruler:</label>             <div id="flip-ruler" class="btn-group" data-toggle="buttons-radio">                <button data-type="on" class="btn btn-default" data-lang="Buttons.On">On</button>                <button data-type="off" class="btn btn-default" data-lang="Buttons.Off">Off</button>            </div>        </div>        <div class="option-group" data-show="canvas">            <label for="flip-grid" data-lang="Options.Grid">Grid:</label>             <div id="flip-grid" class="btn-group" data-toggle="buttons-radio">                <button data-type="on" class="btn btn-default" data-lang="Buttons.On">On</button>                <button data-type="off" class="btn btn-default" data-lang="Buttons.Off">Off</button>            </div>        </div>        <div class="option-group" data-show="canvas">            <label for="flip-scale" data-lang="Labels.Scale">Scale:</label>             <div id="flip-scale" class="btn-group" data-toggle="buttons-radio">                <button data-type="on" class="btn btn-default" data-lang="Buttons.On">On</button>                <button data-type="off" class="btn btn-default" data-lang="Buttons.Off">Off</button>            </div>        </div>        <div class="option-group" data-show="canvas">            <label for="flip-logo" data-lang="Labels.Logo">Logo:</label>             <div id="flip-logo" class="btn-group" data-toggle="buttons-radio">                <button data-type="on" class="btn btn-default" data-lang="Buttons.On">On</button>                <button data-type="off" class="btn btn-default" data-lang="Buttons.Off">Off</button>            </div>        </div>        <div class="option-group">            <label for="flip-offset-h" data-lang="Labels.Overlap_h">Overlap：</label>             <div class="btn-group"><input class="form-control flip-offset" id="flip-offset-h" type="number"><span>px</span></div>        </div>        <div class="option-group">            <label for="flip-offset-v" data-lang="Labels.Overlap_v">Overlap：</label>             <div class="btn-group"><input class="form-control flip-offset" id="flip-offset-v" type="number"><span>px</span></div>        </div>        <div class="option-group" data-show="canvas">            <label for="flip-rotate" data-lang="Labels.ImageRotate">图像旋转：</label>             <div id="flip-rotate" class="btn-group text-center">            </div>        </div>        <div class="option-group" style1="display:none;">            <label for="flip-compact" data-lang="Labels.Compact">Compact:</label>             <div id="flip-compact" class="btn-group" data-toggle="buttons-radio">            <button data-type="on" class="btn btn-default" data-lang="Buttons.On">On</button>            <button data-type="off" class="btn btn-default" data-lang="Buttons.Off">Off</button>            </div>        </div></div>'
      , g = $(e);
  e = null;
  var h, t = MMDSSlideViewerStrings.getString("Menus.Options");
  function f(e) {
    if (e) {
      if (!h) {
        var t = SlideViewerConfig.logoUrl
            , n = t.lastIndexOf(".");
        t = t.substring(0, n) + "_res" + t.substring(n) + " 2x",
            (h = $('<div class="logo_wrap"><div ><img /></div></div>')).find("img").attr("src", SlideViewerConfig.logoUrl).attr("srcset", t).bind("click", function() {
              window.open(SlideViewerConfig.logoLink)
            }),
            a.addControl(h[0], Seadragon.ControlAnchor.NONE)
      }
      h.show()
    } else
      h && h.hide()
  }
  function v(e) {
    a.elmt.className = e ? "ruler" : ""
  }
  !function() {
    $("[data-lang]", g).html(function() {
      var e = $(this).attr("data-lang");
      return SlideViewerStrings.getString(e) || MMDSSlideViewerStrings.getString(e)
    }),
        $("div.btn-group", g).not("#flip-rotate,.flip-offset").each(function() {
          var e = function(e) {
            switch (e) {
              case n:
                return SlideViewerConfig.showNavMap();
              case i:
                return SlideViewerConfig.showAnimation();
              case o:
                return SlideViewerConfig.showRulers();
              case s:
                return SlideViewerConfig.showGrid();
              case l:
                return SlideViewerConfig.showLabel();
              case d:
                return SlideViewerConfig.showZoom();
              case c:
                return SlideViewerConfig.showFrame();
              case r:
                return SlideViewerConfig.showLogo();
              case p:
                return SlideViewerConfig.showScale()
            }
          }(this.id) ? "on" : "off";
          $("[data-type='" + e + "']", this).addClass("active"),
          "flip-ruler" == this.id && "on" == e && v(!0)
        }),
        g.delegate("button", "click", function() {
          var e = $(this);
          if (!e.hasClass("active")) {
            e.siblings().removeClass("active"),
                e.addClass("active");
            var t = "on" == e.attr("data-type");
            !function(e, t) {
              switch (e) {
                case n:
                  SlideViewerConfig.showNavMap(t),
                      a.getNavigationView().setVisibility(t),
                      a.update();
                  break;
                case i:
                  SlideViewerConfig.showAnimation(t),
                  t || $("div.compactshade").hide(),
                      a.update();
                  break;
                case o:
                  v(t),
                      SlideViewerConfig.showRulers(t),
                      a.update();
                  break;
                case s:
                  SlideViewerConfig.showGrid(t),
                      a.update();
                  break;
                case l:
                  SlideViewerConfig.showLabel(t),
                      a.getSlideLabel().setVisibility(t),
                      a.update();
                  break;
                case d:
                  SlideViewerConfig.showZoom(t),
                      a.zoomTools.toggle(t);
                  break;
                case c:
                  SlideViewerConfig.showFrame(t),
                      a.marker.toggle(t);
                  break;
                case r:
                  SlideViewerConfig.showLogo(t),
                      f(t);
                  break;
                case p:
                  SlideViewerConfig.showScale(t),
                      a.scaleTools.enable(t)
              }
            }(e.parent().attr("id"), t)
          }
        });
    var t = SlideViewerConfig.changeViewportOffset();
    g.find(".flip-offset").bind("change", function() {
      var e = parseInt(this.value);
      isNaN(e) || (this.id == u ? t.y = e : t.x = e,
          a.setChangeViewportOffset(-t.x, -t.y),
          SlideViewerConfig.changeViewportOffset(t))
    }).bind("mouseleave", function() {
      $(this).blur()
    }).val(function() {
      return this.id == u ? t.y : t.x
    }),
        a.setChangeViewportOffset(-t.x, -t.y),
        SlideViewerSupport.canvas ? g.find("#flip-rotate").html(new SlideRotate(a).elmt) : $("[data-show='canvas']", g).hide(),
        f(SlideViewerConfig.showLogo()),
        SlideViewerConfig.showAnimation(SlideViewerConfig.showAnimation()),
        g.find(".dropdown-toggle").dropdown(),
        g.find(".dropdown-menu").delegate("a", "click", function() {
          $(document).click(),
              g.find(".fov-btn").html($(this).find("small").html() || SlideViewerStrings.getString("Buttons.Off"));
          var e = $(this).attr("data-val");
          0 <= (e = parseFloat(e)) && (a.marker.toggle(e),
              SlideViewerConfig.frameArea(e))
        });
    var e = SlideViewerConfig.frameArea();
    (e = parseFloat(e)) && setTimeout(function() {
      g.find("a[data-val='" + e + "']").click()
    }, 10)
  }(),
      this.name = function() {
        return t
      }
      ,
      this.elmt = g[0]
};
SlideViewer.prototype.reloadImage = function() {
  SeadragonConfig.immediateRender = !0,
      this.drawer.doNotClearCanvas = !0,
      this.drawer.reset(),
      this.getNavigationView().resetUrl(this.provider.getThumbnailUrl(this.getCurrentSlide().id, this.getCurrentImage().id))
}
;
var SV_APPS = [], AdvancedMenu = function(a, n) {
  var i = '<ul class="dropdown-menu adv-menu" style="position:absolute;margin: 0;" role="menu"><div class="text-right hide1" style="padding-right:10px;margin-bottom:2px;">\t\t<a class="settings" target="_blank" href="javascript:void(0)"><i class="glyphicon glyphicon-cog"></i> <span data-lang="manager"></span></a></div><div class="empty" style="color:#aaa;margin:10px 20px;text-align: center" data-lang="desc"></div></ul>';
  (i = $(i).hide().appendTo("body")).find("a").bind("touchstart", function(e) {
    e.stopPropagation()
  });
  MedLang.interpretElem(i, {
    zh: {
      manager: "管理",
      desc: "尚无应用模块"
    },
    en: {
      manager: "Manage",
      desc: "There isn't APP module"
    }
  });
  var o = !1
      , s = $(this);
  function r(e) {
    $('<li><a href="javascript:void(0);"><span></span><footer></footer></a></li>').appendTo(i).bind(($.support.touch ? "touchstart " : "") + "click", function() {
      e.show()
    }).find("span").text(e.title).end().find("footer").text(e.desc)
  }
  !function() {
    a.provider.getExtPromise().done(function() {
      i.find("a.settings").attr("href", a.provider.getSigUrl("/Apps/Page"))
    });
    for (var e = 0; e < SV_APPS.length; e++) {
      var t = SV_APPS[e];
      if (t.premise()) {
        var n = new t.instance(a);
        if (n.isRunner)
          continue;
        r(n),
            i.find(".empty").hide()
      }
    }
  }(),
      this.showMenu = function() {
        return 0 < appCount
      }
      ,
      this.show = function(e) {
        var t = n.offset();
        return i.show().css({
          left: t.left + n.outerWidth(),
          bottom: $(window).outerHeight() - t.top - n.outerHeight(),
          top: "auto"
        }),
            o = !0,
        e && i.effect("slide", "fast"),
            s.trigger("shown"),
            i
      }
      ,
      this.hide = function() {
        o && (o = !1,
            i.hide())
      }
      ,
      this.name = MMDSSlideViewerStrings.getString("Menus.Advanced")
}, AdvancedDialog = function(d, a, t, e) {
  var c = '<div class="popover submenu" style="left:40%;top:60%;' + (e ? "max-width:" + e + "px" : "") + '">            <h3 class="popover-title">            <div class="pull-left"><nobr class="txt"></nobr></div>            <div class="pull-right" style="padding-left:5px;">                <button type="button" class="close" data-dismiss="alert">&times;</button><span class="btn_style close" type="button">&minus;</span>            </div>            <div class="clearfix"></div></h3>            <div class="popover-content"></div>            <div class="footer"></div>        </div>'
      , o = this
      , n = !1
      , i = d.getCurrentSlide().id
      , s = o.eventManager = o.eventManager || new SeadragonEventManager;
  function r(e) {
    return decodeURIComponent($("#" + t).attr(e + "_" + SlideViewerConfig.language))
  }
  this.title = r("name"),
      this.desc = r("desc"),
      this.review = "true" === $("#" + t).attr("review"),
      this.data = function(e, t, n) {
        return e = a + "_" + e,
            SlideViewerConfig.localStorage(e, t, n)
      }
  ;
  var u = window.parent && window.parent !== window ? 50 : 0
      , p = o.data("p");
  function l(e, t) {
    if (e) {
      var n = $(d.container)
          , a = n.position()
          , i = a.left + n.width()
          , o = a.top + n.height()
          , s = c.width()
          , r = c.height()
          , l = !1;
      e.left + s > i && (e.left = i - s,
          l = !0),
      e.left < a.left && (e.left = a.left,
          l = !0),
      e.top + r > o && (e.top = o - r,
          l = !0),
      e.top < a.top + u && (e.top = a.top + u,
          l = !0),
      (l || t) && c.css(e),
      t || (p = e)
    }
  }
  function g(e) {
    s.trigger(e, o)
  }
  this.initDialog = function(e, t, n) {
    c = $(c),
        d.addControl(c[0], Seadragon.ControlAnchor.NONE),
        c.draggable({
          handle: "h3",
          cursor: "move",
          containment: d.container,
          stop: function(e, t) {
            l(t.position),
                o.data("p", t.position)
          }
        }),
    $.support.touch && c.on("touchmove", function(e) {
      e.stopPropagation()
    }),
        c.find("button.close").bind("click touchstart", function() {
          c.hide(),
              g("close")
        });
    var a = !1;
    function i() {
      c.find(".popover-content").css("max-height", this.innerHeight - 40)
    }
    return c.find(".btn_style").bind("click", function() {
      $(this).html((a = !a) ? "&plus;" : "&minus;"),
          c.find("div.popover-content,div.footer").toggleClass("hidden")
    }),
        c.find("h3 .txt").append(e),
        c.find("div.popover-content").append(t),
    n && c.find("div.footer").append(n),
    null != p && l(p, !0),
        $(window).bind("resize", i),
        i(),
        c
  }
      ,
      this.show = function() {
        n || (g("init"),
            n = !0),
            g("show"),
            c.show(),
            l(p)
      }
      ,
      this.isShowBaseLocal = function(e) {
        return e == i
      }
      ,
      this.hide = function(e) {
        e ? o.data("s", null, !0) : (n && c.hide(),
            g("close"))
      }
      ,
      this.bind = function(e, t) {
        s.addListener(e, t)
      }
      ,
      o.bind("show", function() {
        o.data("s", i)
      }),
      o.bind("close", function() {
        o.data("s", 0)
      }),
      setTimeout(function() {
        var e = o.data("s");
        (null == e && -1 < location.href.indexOf("app_s=" + a) || o.isShowBaseLocal(e)) && o.show()
      }, 0)
}, IFactor = function() {
  var a = this;
  this.isDefault = function() {
    return console.warn("TODO:IFactor.isDefault"),
        !0
  }
      ,
      this.getParam = function() {
        return console.warn("TODO:IFactor.getParam"),
            ""
      }
      ,
      this.isChanged = function(e) {
        for (var t in a) {
          var n = a[t];
          if ("function" != typeof n && n != e[t])
            return !0
        }
        return !1
      }
}, Advanced_Base = function(a, i, e) {
  AdvancedDialog.apply(this, [a, i, e]);
  var t, o, s = this;
  function r(e) {
    e.success ? (o = $.extend(!0, {}, s.factor),
        a.showMessage(SlideViewerStrings.getString("Messages.SaveAdjustmentSuccess"))) : (a.showMessage(SlideViewerStrings.getString("Messages.SaveAdjustmentFailed")),
        ErrorOutput("SaveImageAdjustment", e))
  }
  this.adjusting = !1,
      this.factor,
      this.init = function(e, t, n) {
        return s.factor = a.provider.getAdjustFactor(i),
            o = $.extend(!0, {}, s.factor),
            s.initDialog(e, t, n)
      }
      ,
      this.updateFactor = function() {
        a.provider.updateFactor(i, s.factor),
            a.reloadImage(),
            clearTimeout(t),
            t = setTimeout(function() {
              if (!s.adjusting && s.factor.isChanged(o)) {
                var t = a.getCurrentSlide().id
                    , n = a.getCurrentImage().id;
                "BUAA" == i ? a.provider.updateAppConfig(e, JSON.stringify(s.factor), function(e) {
                  a.provider.updateImageAdjustment(t, n, s.factor, r, i),
                      r(e)
                }) : a.provider.updateImageAdjustment(t, n, s.factor, r, i)
              }
            }, 2500)
      }
}, _regApps = [], _appTimer, AppBase = function(l, d, o) {
  if (AppBase.lang = {
    zh: {
      locale: "zh_CN",
      pro_main: "总进度：",
      cancel: "取消",
      untitled: "未命名",
      annotation: "标注",
      object: "细胞",
      status: {
        CREATED: "创建",
        QUEUED: "队列",
        BOOTSUCCESS: "启动成功",
        STARTED: "开始处理",
        PAUSE: "暂停",
        PROCESSING: "处理中",
        BOOTFAILED: "启动失败",
        CRASH: "异常",
        ABORTED: "中止",
        CANCEL: "取消",
        FINISHED: "完成"
      }
    },
    en: {
      locale: "en",
      pro_main: "Progress:",
      cancel: "Cancel",
      untitled: "Untitled",
      annotation: "Annotation",
      object: "Object",
      status: {
        CREATED: "Created",
        QUEUED: "Queued",
        BOOTSUCCESS: "BootSuccess",
        STARTED: "Started",
        PAUSE: "Pause",
        PROCESSING: "Processing",
        BOOTFAILED: "BootFailed",
        CRASH: "Crash",
        ABORTED: "Aborted",
        CANCEL: "Cancel",
        FINISHED: "Finished"
      }
    }
  },
      !this._inited_cloud) {
    this._inited_cloud = !0,
        AdvancedDialog.apply(this, [l, o, d]),
        l.bind("m.open", function() {
          _regApps.push(d),
              clearTimeout(_appTimer),
              _appTimer = setTimeout(function() {
                l.provider.getAppTasks(_regApps, function(e) {
                  for (var t = e.tasks.length - 1; 0 <= t; t--)
                    l.trigger("task.add", e.tasks[t])
                })
              }, 100)
        });
    var a, s = this, c = "RectangleMarquee", r = l.getCurrentSlide().id, u = {
      zh: {
        busy: "有任务处理中，稍后重试",
        bootFailed: "任务启动失败",
        createFailed: "任务创建失败",
        delRoi: "确认删除该ROI，及其下%s个细胞标注？",
        delEmptyRoi: "确认删除该空ROI？"
      },
      en: {
        busy: "Service busy,retry later",
        bootFailed: "Boot failed",
        createFailed: "Create failed",
        delRoi: "Confirm to delete the AOI, and its %s cells?",
        delEmptyRoi: "Confirm to delete the empty AOI?"
      }
    };
    $(window).on("beforeunload", function(e) {
      if (a && SlideViewerConfig.exitConfirm && l && l.dataChanged() && l.canWrite()) {
        e || window.event;
        return e && (e.returnValue = SlideViewerStrings.getString("Messages.ExitConfirm")),
            SlideViewerStrings.getString("Messages.ExitConfirm")
      }
    }),
        l.bind("beforeAnnotationChange", function(e, t, n) {
          if (a)
            if (s.updateSaveStatus(),
            -2 == t.status && e == AnnotationAction.Del)
              try {
                n.IsCancel = !s.confirmDelRoi(t)
              } catch (e) {
                n.IsCancel = !0,
                    console.error(e)
              }
            else
              e == AnnotationAction.Add && (t.externalData = {},
                  t.isNew = !0,
                  s.createdShape(t))
        }),
        l.bind("annotationChanged", function(e, t) {
          a && -2 == t.status && (s.saveTaskRoi(),
          e == AnnotationAction.Del && l.trigger("deletedTaksRoi", t.externalData.roiId))
        }),
        l.getShapeCanvas().registerVisibleFilter(function(e) {
          if (a)
            return e.status < -1
        }),
        this.confirmDelRoi = function(e) {
          return !0
        }
        ,
        this.createdShape = function(e) {
          e.type == c ? e.status = -2 : e.status = -1
        }
        ,
        this.saveTaskRoi = function(o) {
          l.provider.updateTaskRoi(d, a, s.getRois(), function(e) {
            s.updateSaveStatus(e.success);
            for (var t = l.getShapeCanvas(), n = t.getAnnotations(), a = 0; a < n.length; a++) {
              var i = n[a];
              -2 != i.status || i.externalData && i.externalData.roiId || (i.externalData || (i.externalData = {}),
                  i.externalData.roiId = e.ids[i.guid])
            }
            t.isShapeChanged = !1,
            o && o()
          })
        }
        ,
        this.imgToCanvasPoint = function(e) {
          var t = l.getShapeCanvas();
          return imgToCanvasPoint(e, t.getCavScale(), t.getCavOffset(), l.rotate(), t.getRotateOriginPoint(), !0)
        }
        ,
        this.cavToImagePoint = function(e) {
          var t = l.getShapeCanvas();
          return cavToImagePoint(e, t.getCavScale(), t.getCavOffset(), l.rotate(), t.getRotateOriginPoint(), !0)
        }
    ;
    var p, g, h = this._roiLockedMap = this._roiLockedMap || {};
    this.isLockedRoi = function(e) {
      return h[e]
    }
        ,
        this.showRoi = function(e, o, s, o) {
          var r = l.getShapeCanvas();
          !a && e && r.saveAnnotations(),
              a = e,
              r.resumeAnnotations(),
          e && l.provider.getTaskRoi(d, e, function(e) {
            if (e.success) {
              for (var t = e.data, n = 0; n < t.length; n++) {
                var a = t[n]
                    , i = a.annotation;
                i.status = -2,
                    i.visible = !0,
                    (i.isLocked = a.locked || !o) ? i.color = 4286611584 : i.color = HexToNumber(ShapeDefaultConfig.defaultColor),
                i.externalData || (i.externalData = {}),
                    i.externalData.roiId = a.id,
                    t[n] = i,
                    h[a.id] = a.locked
              }
              r.addAnnotations(t),
                  r.showImageShapes(),
              s && s(t)
            }
          })
        }
        ,
        this.getTile = function(e, t) {
          for (var n = l.drawer.getLastDraw(), a = 0; a < n.length; a++) {
            var i = n[a];
            if (!(e < i.position.x || t < i.position.y || e > i.position.x + i.size.x || t > i.position.y + i.size.y))
              return i
          }
        }
        ,
        AppBase._appsDeley,
        this.getApps = function() {
          if (!AppBase._appsDeley) {
            var t = $.Deferred();
            l.provider.getApps(function(e) {
              t.resolve(e.apps)
            }),
                AppBase._appsDeley = t.promise()
          }
          return AppBase._appsDeley
        }
        ,
        this.getRois = function(e, t) {
          for (var n = [], a = l.getShapeCanvas().getAnnotations(), i = 0; i < a.length; i++)
            if (a[i].status == (null == t ? -2 : 0) && a[i].type == c) {
              var o, s = b(new AnnotationInfo, a[i]), r = s.region;
              0 == r.x && 0 == r.y && (o = l.getCurrentImage()) && r.width == o.width && r.height == o.height && (s.wsi = !0),
              e || (s = JSON.stringify(s)),
                  n.push(s)
            }
          return n
        }
        ,
        this.getRoiId = function(e, t) {
          e = s.imgToCanvasPoint(e);
          for (var n = l.getShapeCanvas().getAnnotations(), a = 0; a < n.length; a++) {
            var i = (o = n[a]).isSelected;
            if (-2 == o.status && o.isHitMyArea(e))
              return o.isSelected = i,
                  o.externalData.roiId
          }
          if (t)
            for (a = 0; a < n.length; a++) {
              var o;
              if (-2 == (o = n[a]).status)
                return o.externalData.roiId
            }
        }
        ,
        this.transShapeToAnnotation = function(e) {
          return b(new AnnotationInfo, e)
        }
        ,
        this.updateSaveStatus = function(e) {
          l.trigger("saveAnnotationsComplated", e)
        }
        ,
        this.appId = d,
        this.getAppStatus = function(e) {
          return !0
        }
        ,
        this.taskUrl = function(e, t) {
          return l.provider.getTaskUrl(t || d, e || "")
        }
        ,
        this.updateTaskStatus = function(e) {
          var t = s.taskUrl(p) + "/Status";
          l.provider.updateTaskStatus(t, e, function(e) {
            console.log(e)
          })
        }
    ;
    var t = ["BOOTFAILED", "CRASH", "ABORTED", "CANCEL"];
    this.isRunStatus = function(e) {
      return -1 == t.indexOf(e)
    }
        ,
        this.createAppTask = function(e, t, n) {
          if (g = "CREATED",
          void 0 === e.slides && !e.appId) {
            var a = {
              id: e.slideId || r
            };
            a.id == r && l.provider.getTitle(function(e) {
              a.alias = e
            }),
                e.slides = [a]
          }
          delete e.slideId,
              e.appName = e.appName || o,
          e.model || (e.model = "wsi");
          var i = e.appId || d;
          delete e.appId;
          l.provider.createAppTask(i, e, function(e) {
            if (e.success) {
              if (l.trigger("task.add", {
                appId: i,
                appName_en: e.appName_en,
                appName_zh_CN: e.appName_zh_CN,
                createTime: e.createTime,
                id: e.id,
                title: e.title,
                mine: !0,
                dataType: e.dataType,
                status: e.status,
                hasAnno: "FINISHED" == g && e.hasAnno,
                userId: e.ownerId,
                userName: e.owner,
                params: e.params,
                parentId: e.parentId
              }, !0),
              "FINISHED" == e.status)
                return t && t(e),
                    void s.updateRunStatus(!1);
              if ("QUEUED" == e.status || "BOOTSUCCESS" == e.status)
                return s.subscribeTask(e.id, e),
                    void (t && t(e));
              if (!s.isRunStatus(e.status))
                return l.showMessage(e.status + ":" + e.desc),
                    s.updateRunStatus(!1, e.status),
                    console.error(e),
                    void ("function" == typeof n && n(e))
            }
            l.showMessage(MedLang.getString("createFailed", u)),
                s.updateRunStatus(!1),
                console.error(e),
            "function" == typeof n && n(e)
          }),
              s.updateRunStatus(!0, "CREATED", -1)
        }
        ,
        this.createSubTask = function(t, e, n) {
          g = "CREATED",
          null == e.slideId && (e.slideId = r),
              l.provider.createSubTask(d, t, e, function(e) {
                e.success ? s.subscribeTask(t, e, n) : (l.showMessage(MedLang.getString("createFailed", u)),
                    s.updateRunStatus(!1),
                    console.error(e))
              }),
              s.updateRunStatus(!0, "CREATED")
        }
        ,
        this.registerNewTask = function() {
          if (!AppBase.StorageActions) {
            var n = AppBase.StorageActions = {};
            $(window).bind("storage", function(e) {
              e = e.originalEvent;
              var t = n[e.key];
              t && e.newValue && t(e.newValue)
            })
          }
          var e = "gallery_app_" + d + "_" + r + "_new_task";
          AppBase.StorageActions[e] = function(e) {
            g = "CREATED",
                s.updateRunStatus(!0, "CREATED");
            var t = JSON.parse(e);
            s.subscribeTask(t.taskId, t)
          }
        }
        ,
        this.cancelTask = function(e, t, n) {
          var a = s.taskUrl(e || p, n) + "/Status?appName=" + o + "&slideId=" + r;
          l.provider.updateTaskStatus(a, "CANCEL", function(e) {
            "success" != e.status && setTimeout(function() {
              l.showMessage("CANCEL:" + e.desc),
                  console.error("CancelTaskFaild:" + e.desc)
            }, 20),
            t && t(e)
          })
        }
        ,
        this.confirmDelTask = function(e, t) {
          return !1
        }
        ,
        this.action = function(e, t, n) {
          if (e) {
            var a = s.taskUrl(e) + "/Action";
            l.provider.postTaskAction(a, t, n)
          } else
            console.error("TaskId required")
        }
    ;
    var n = {};
    this.subscribeTask = function(i, e) {
      n[p = i] || (l.provider.subscribe("/topic/Tasks/" + i + "/Status", function(e) {
        var t = JSON.parse(e.body)
            , n = "FINISHED" == (m = $.extend(m, t)).status || !s.isRunStatus(m.status);
        if (g != m.status) {
          if ("BOOTSUCESS" == (g = m.status) && (-1 == f && (f = 0),
              s.progressUI(!n, m, f, i)),
              n) {
            var a = m.status;
            m.desc && m.desc.msg && (a += ":" + m.desc.msg),
                l.showMessage(a),
                s.updateRunStatus(!n, m.status),
                l.trigger("task.finish", {
                  appId: d,
                  id: i
                }),
                s.unsubscribeTask(i)
          }
        } else
          s.progressUI(!n, m, f, i)
      }),
          n[i] = 1)
    }
        ,
        this.unsubscribeTask = function(e) {
          n[e] && (l.provider.unsubscribe("/topic/Tasks/" + e + "/Status"),
              n[e] = 0)
        }
        ,
        this.getTask = function(e) {
          AppBase.status ? e(AppBase.tasks[d]) : (null == AppBase.status && (AppBase.status = 0,
              l.provider.subscribe("/app/Slides/" + r + "/Tasks", function(e) {
                AppBase.status = 1;
                for (var t = AppBase.tasks = {}, n = JSON.parse(e.body), a = 0; a < n.length; a++) {
                  var i = n[a];
                  t[i.appId] = i;
                  var o = AppBase.cbs[i.appId];
                  if (o)
                    try {
                      o(i)
                    } catch (e) {
                      console.error(e)
                    }
                }
                l.trigger("SlideTasks", n)
              }),
              AppBase.status = 0,
              AppBase.cbs = {}),
              AppBase.cbs[d] = e)
        }
        ,
        s.getTask(function(e) {
          s.show();
          var t = "QUEUED" == e.status ? -1 : parseInt(((new Date).getTime() - e.startTime) / 1e3);
          s.updateRunStatus(!0, e.status, t),
              s.subscribeTask(e.id)
        });
    var f = 0
        , v = null
        , m = {};
    this.updateRunStatus = function(e, t, n, a, i) {
      if (clearInterval(v),
          m.status = t || m.status,
          e)
        f = n,
            v = setInterval(function() {
              0 <= n && f++,
                  s.progressUI(!0, m, f, a, i)
            }, 1e3);
      else {
        var o = m;
        m = {},
            f = 0,
            s.progressUI(!1, o, f, a, i)
      }
    }
        ,
        this.progressUI = function(e, t, n, a, i) {}
  }
  function b(e, t) {
    return e.imageId = t.imageId,
        e.guid = null == t.guid ? guidGenerator() : t.guid,
        e.name = t.name,
        e.description = t.description,
        e.scale = t.scale,
        e.width = t.width,
        e.type = t.type,
        e.fontUnderLine = t.fontUnderLine,
        e.fontSize = t.fontSize,
        e.fontFamily = t.fontFamily,
        e.fontItalic = t.fontItalic,
        e.fontBold = t.fontBold,
        e.visible = t.visible,
        e.color = HexToNumber(t.color),
        e.measurement = t.measurement,
        e.radius = t.radius,
        e.arcLength = t.arcLength,
        e.angle = t.angle,
        e.which = t.which,
        e.isLocked = t.isLocked,
        e.status = t.status,
        e.saveData = t.saveData,
        e.points = function(e) {
          for (var t = [], n = 0; n < e.length; n++)
            t.push(new Point(e[n].x,e[n].y));
          return t
        }(t.points),
        e.region = new SeadragonRect(t.startPoint.x,t.startPoint.y,t.endPoint.x - t.startPoint.x,t.endPoint.y - t.startPoint.y),
        e
  }
};
SlideProvider.prototype.getAppUrl = function(e, t) {
  return "/Apps/" + e + (t || "")
}
    ,
    SlideProvider.prototype.getTaskUrl = function(e, t, n) {
      return this.getAppUrl(e, "/Tasks/" + t + (n || ""))
    }
    ,
    SlideProvider.prototype.createAppTask = function(e, t, n) {
      var a = this.getAppUrl(e, "/Tasks");
      t.taskId && (a += "/" + t.taskId,
          delete t.taskId),
          this.request(a, "POST", JSON.stringify(t), !0, new UpdateResult, function(e, t) {
            e = $.extend(e, t)
          }, n, {
            "Content-Type": "application/json;charset=utf-8"
          }, !1, !1)
    }
    ,
    SlideProvider.prototype.createSubTask = function(e, t, n, a) {
      this.request(this.getAppUrl(e, "/Tasks/" + t + "/Process"), "POST", n, !1, new UpdateResult, function(e, t) {
        e = $.extend(e, t)
      }, a)
    }
    ,
    SlideProvider.prototype.getApps = function(e) {
      this.request(this.getAppUrl(""), "GET", {}, !0, {}, function(e, t) {
        e.apps = t
      }, e)
    }
    ,
    SlideProvider.prototype.getAppStatus = function(e, t, n) {
      this.request(this.getAppUrl(e, "/Status"), "GET", {}, n, {}, function(e, t) {
        e.status = t
      }, t)
    }
    ,
    SlideProvider.prototype.updateTaskStatus = function(e, t, n) {
      this.request(e, "PUT", t, !0, new UpdateResult, function(e, t) {
        e = $.extend(e, t)
      }, n)
    }
    ,
    SlideProvider.prototype.postTaskAction = function(e, t, n) {
      this.request(e, "POST", t, !0, new UpdateResult, function(e, t) {
        e.body = t
      }, function(e) {
        n(e.body)
      })
    }
    ,
    SlideProvider.prototype.getAppTasks = function(e, t) {
      this.request(this.getAppUrl("Tasks?app=", e.join("&app=")), "GET", {
        slideId: this.slideId()
      }, !0, {
        tasks: []
      }, function(e, t) {
        e.tasks = t
      }, t)
    }
    ,
    SlideProvider.prototype.deleteTask = function(e, t, n) {
      this.request(this.getAppUrl(e, "/Tasks/" + t + "/Slides/" + this.slideId()), "DELETE", {}, !0, new UpdateResult, function(e, t) {
        e.op = t
      }, n)
    }
    ,
    SlideProvider.prototype.updateAppConfig = function(e, t, n) {
      this.request(this.getAppUrl(e, "/Config?slideId=") + this.slideId(), "PUT", t, !0, new UpdateResult, function(e, t) {
        e = $.extend(e, t)
      }, n)
    }
    ,
    SlideProvider.prototype.getAppConfig = function(e, t) {
      this.request(this.getAppUrl(e, "/Config?slideId=") + this.slideId(), "GET", {}, !0, {}, function(e, t) {
        e.data = t
      }, t)
    }
    ,
    SlideProvider.prototype.getTaskRoi = function(e, t, n) {
      this.request(this.getAppUrl(e, "/Tasks/" + t + "/Slides/" + this.slideId() + "/Rois"), "GET", {}, !0, {}, function(e, t) {
        e.data = t
      }, n)
    }
    ,
    SlideProvider.prototype.updateTaskRoi = function(e, t, n, a) {
      var i;
      this.getTitle(function(e) {
        i = e
      }),
          this.request(this.getAppUrl(e, "/Tasks/" + t + "/Slides/" + this.slideId() + "/Rois?slideAlias=" + encodeURIComponent(i)), "PUT", JSON.stringify(n), !0, new UpdateResult, function(e, t) {
            e.ids = t
          }, a, {
            "Content-Type": "application/json"
          })
    }
    ,
    SlideProvider.prototype.loadTileIndex = function(e, t, n) {
      this.request(this.getAppUrl(e, "/Tasks/" + t + "/Overlays/Index?slideId=" + this.slideId()), "GET", {}, !0, {}, function(e, t) {
        e.data = t
      }, n)
    }
;
var AppOverlay = function(p, g, t, e) {
  var n, c, u, h, f = this, v = p.drawer.getLastDraw(), a = p.getCurrentSlide().id, s = p.getCurrentImage(), m = Math.ceil(Math.log(Math.max(s.width, s.height)) / Math.log(2)), b = "949F3311-0273-E911-80CA-AA57E72A2A6F" == g ? "yellow" : "red";
  this.updateTaskId = function(e, t) {
    e && (n != e || t) ? (n = e,
        y.rest(),
        c = e && e.substring(0, 4),
        u = (new Date).getTime() % 1e4,
        f.update()) : e || (n = e,
        f.update())
  }
      ,
      this.getCanvas = function() {
        return h
      }
      ,
      this.update = function(e) {
        (e && delete e[c],
            t) ? (h.getContext("2d").clearRect(0, 0, h.width, h.height),
            S()) : p.getShapeCanvas().renderCommonCanvas()
      }
      ,
  f.beforeDraw || (this.beforeDraw = function() {
        return !!n
      }
  ),
      function(e, t) {
        if (e) {
          function n() {
            var e = p.viewport.getContainerSize();
            h.width = e.x,
                h.height = e.y
          }
          (h = document.createElement("canvas")).id = "cav_" + g,
              h.style.position = "absolute",
              n(),
              p.insertOverlay(h, t || 0),
              p.addEventListener("resize", n),
              p.addEventListener("animation", f.update),
              p.addEventListener("rotate", f.update)
        } else
          h = p.getShapeCanvas().getCommonCanvas(),
              p.getShapeCanvas().bind("renderComCav", function() {
                S()
              })
      }(t, e);
  var y = new LinkCache(100);
  function S(e) {
    if (f.beforeDraw()) {
      var t = h.getContext("2d");
      t.save();
      var n = p.rotate();
      if (n) {
        var a = p.viewport.getContainerSize()
            , i = new SeadragonPoint(a.x / 2,a.y / 2);
        i = new SeadragonPoint(0,0).rotate(n, i),
            t.translate(i.x, i.y),
            t.rotate(-n)
      }
      var o = p.getShapeCanvas()
          , s = o.getCavOffset()
          , r = o.getCavScale();
      if (t.strokeStyle = b,
          t.translate(s.x, s.y),
          t.scale(r, r),
          t.lineWidth = 1 / r,
          e)
        w(t, e);
      else {
        var l = m - Math.floor(Math.log(r) / Math.log(.5));
        m < l && (l = m);
        for (var d = 0; d < v.length; d++)
          l == (e = v[d]).level && e[c] != u && (e.key || (e.key = [e.level, e.y, e.x].join("_")),
              w(t, e, function(n) {
                C(n, function(e, t) {
                  e && (0 < t.length ? (y.push(n.key, t),
                  n.beingDrawn && S(n)) : n[c] = u)
                })
              }))
      }
      t.restore()
    }
  }
  function w(e, t, n) {
    e.beginPath();
    var a = e.strokeStyle;
    e.strokeStyle = "white";
    var i = t.position
        , o = p.getShapeCanvas()
        , s = cavToImagePoint(i, o.getCavScale(), o.getCavOffset(), p.rotate(), o.getRotateOriginPoint(), !0)
        , r = cavToImagePoint({
      x: i.x + t.size.x,
      y: i.y + t.size.y
    }, o.getCavScale(), o.getCavOffset(), p.rotate(), o.getRotateOriginPoint(), !0);
    e.moveTo(s.x, s.y),
        e.lineTo(r.x, s.y),
        e.moveTo(s.x, s.y),
        e.lineTo(s.x, r.y),
        e.stroke(),
        e.font = (r.x - s.x) / 20 + "px microsoft yahei",
        e.strokeStyle = "white",
        e.strokeText(t.key, s.x, s.y + (r.x - s.x) / 20),
        e.strokeStyle = a;
    var l = y.get(t.key);
    l ? f.drawTile(e, t, l) : "function" == typeof n && n(t)
  }
  function l(e, t, n) {
    var a = {
      x: t.cx + 1,
      y: t.cy + 1
    };
    e.beginPath(),
        e.moveTo(a.x - n, a.y),
        e.lineTo(a.x + n, a.y),
        e.moveTo(a.x, a.y - n),
        e.lineTo(a.x, a.y + n),
        e.stroke()
  }
  function d(e, t) {
    var n = t.detail;
    if (!n)
      return !1;
    e.beginPath();
    var a = n.x0 + 1
        , i = n.y0 + 1;
    e.moveTo(a, i);
    for (var o = n.contour, s = 0; s < o.length; s++) {
      switch (o[s]) {
        case "Q":
          a--,
              i--;
          break;
        case "W":
          i--;
          break;
        case "E":
          a++,
              i--;
          break;
        case "A":
          a--;
          break;
        case "D":
          a++;
          break;
        case "Z":
          a--,
              i++;
          break;
        case "X":
          i++;
          break;
        case "C":
          a++,
              i++
      }
      e.lineTo(a, i)
    }
    return e.closePath(),
        e.stroke(),
        !0
  }
  this.drawTile = function(e, t, n) {
    for (var a, i = m - t.level, o = Math.round(3 / p.getScale()), s = 0; s < n.length; s++) {
      var r = n[s];
      switch (i) {
        case 0:
          if (d(e, r))
            break;
        case 1:
        case 2:
          a = r,
              e.strokeRect(a.x + 1, a.y + 1, a.w - 1, a.h - 1);
          break;
        default:
          l(e, r, o)
      }
    }
  }
      ,
      this.getTileCell = function(e) {
        var t = y.get(e);
        return t || (t = [],
            y.push(e, t)),
            t
      }
      ,
      this.eachTileCell = function(e) {
        for (var t = y.first(); null != t; )
          e(t.key, t.data),
              t = t.next
      }
  ;
  var r = {};
  function C(i, o) {
    if (!r[i.key]) {
      r[i.key] = 1;
      var e = f.getUrl(a, n, s.id, m - i.level, i.y, i.x, s.tileSize);
      $.ajax({
        dataType: "jsonp",
        url: e,
        cache: !0,
        crossDomain: !1,
        jsonpCallback: "cb",
        complete: function(e, t, n, a) {
          delete r[i.key],
              200 == e.status && "parsererror" == t ? o(!0, JSON.parse(e.responseText)) : "success" != t && o(!1, e.responseText)
        },
        success: function(e) {
          o(!0, e)
        }
      })
    }
  }
  this.getUrl = function(e, t, n, a, i, o, s) {
    var r = o * s * Math.pow(2, a)
        , l = i * s * Math.pow(2, a)
        , d = (o + 1) * s * Math.pow(2, a)
        , c = (i + 1) * s * Math.pow(2, a)
        , u = p.provider.getAppUrl(g, "/Tasks/" + t + "/Objects?slideId=" + e + "&x1=" + r + "&x2=" + d + "&y1=" + l + "&y2=" + c);
    return u += "&t=" + [a, i, o].join("_")
  }
}
    , AppOverlay2 = function(c, s, t, e) {
  var u, a, r, p, g = this, h = c.drawer.getLastDraw(), l = c.getCurrentSlide().id, n = c.getCurrentImage(), f = Math.ceil(Math.log(Math.max(n.width, n.height)) / Math.log(2)), v = "949F3311-0273-E911-80CA-AA57E72A2A6F" == s ? "yellow" : "red", i = [], d = {};
  this.updateTaskId = function(e, t) {
    r == e && !t || (r = e,
        m.rest(),
        i.length = 0,
        d = {},
        function() {
          if (!r)
            return;
          c.provider.loadTileIndex(s, r, function(e) {
            e.success && (i = e.data,
                g.update())
          })
        }(),
        g.update())
  }
      ,
      this.getCanvas = function() {
        return p
      }
      ,
      this.update = function(e) {
        t ? (p.getContext("2d").clearRect(0, 0, p.width, p.height),
            b()) : c.getShapeCanvas().renderCommonCanvas()
      }
      ,
      this.updateAlpha = function(e) {
        g.getCanvas().style.opacity = e
      }
      ,
      this.beforeDraw = function() {
        return !!r
      }
      ,
      function(e, t) {
        if (e) {
          function n() {
            var e = c.viewport.getContainerSize();
            p.width = e.x,
                p.height = e.y
          }
          (p = document.createElement("canvas")).id = "cav_" + s,
              p.style.position = "absolute",
              n(),
              c.insertOverlay(p, t || 0),
              c.addEventListener("resize", n),
              c.addEventListener("animation", function() {
                u = f - Math.floor(Math.log(c.getShapeCanvas().getCavScale()) / Math.log(.5)),
                f < u && (u = f),
                    a = c.viewport.getContainerSize(),
                    g.update()
              }),
              c.addEventListener("rotate", g.update)
        } else
          p = c.getShapeCanvas().getCommonCanvas(),
              c.getShapeCanvas().bind("renderComCav", function() {
                u = f - Math.floor(Math.log(c.getShapeCanvas().getCavScale()) / Math.log(.5)),
                f < u && (u = f),
                    a = c.viewport.getContainerSize(),
                    b()
              })
      }(t, e);
  var m = new LinkCache(100,function(e) {
        d[e.key] = e.data.src
      }
  );
  function b(e) {
    if (g.beforeDraw()) {
      var t = p.getContext("2d");
      t.save();
      var n = c.rotate();
      if (n) {
        var a = c.viewport.getContainerSize()
            , i = new SeadragonPoint(a.x / 2,a.y / 2);
        i = new SeadragonPoint(0,0).rotate(n, i),
            t.translate(i.x, i.y),
            t.rotate(-n)
      }
      var o = c.getShapeCanvas()
          , s = o.getCavOffset()
          , r = o.getCavScale();
      if (t.strokeStyle = v,
          t.translate(s.x, s.y),
          t.scale(r, r),
          t.lineWidth = 1 / r,
          e)
        S(t, e);
      else
        for (var l = 0; l < h.length; l++) {
          e = h[l];
          var d = f - e.level;
          u == e.level && g.hasTile(d, e.y, e.x) && S(t, e, function(e) {
            y(d, e.y, e.x, function() {
              m.push(e.key, this),
              e.beingDrawn && b(e)
            }, e.key)
          })
        }
      t.restore()
    }
  }
  function o(e) {
    if (u != e.level)
      return !1;
    var t = e.position;
    if (t.x > a.x || t.y > a.y)
      return !1;
    var n = e.size.plus(t);
    return !(n.x < 0 || n.y < 0)
  }
  function y(e, t, n, a, i) {
    if (1 !== d[i]) {
      var o = d[i];
      o ? console.log("Cache:" + i) : (o = c.provider.getAppUrl(s, "/Tasks/" + r + "/Overlays/" + e + "_" + t + "_" + n + "?slideId=" + l),
          o = c.provider.getSigUrl(o, "GET", !0)),
          $("<img/>").bind("load", a).attr("src", o),
          d[i] = 1
    }
  }
  function S(e, t, n) {
    t.key || (t.key = [f - t.level, t.y, t.x].join("_")),
        e.beginPath();
    var a = e.strokeStyle;
    e.strokeStyle = "white";
    var i = t.position
        , o = c.getShapeCanvas()
        , s = cavToImagePoint(i, o.getCavScale(), o.getCavOffset())
        , r = cavToImagePoint({
      x: i.x + t.size.x,
      y: i.y + t.size.y
    }, o.getCavScale(), o.getCavOffset());
    e.moveTo(s.x, s.y),
        e.lineTo(r.x, s.y),
        e.moveTo(s.x, s.y),
        e.lineTo(s.x, r.y),
        e.stroke(),
        e.font = (r.x - s.x) / 20 + "px microsoft yahei",
        e.strokeStyle = "blue",
        e.strokeText(t.key, s.x, s.y + (r.x - s.x) / 20),
        e.strokeStyle = a;
    var l = m.get(t.key);
    l ? g.drawTile(e, t, l, s, {
      x: r.x - s.x,
      y: r.y - s.y
    }) : "function" == typeof n && n(t)
  }
  c.drawer.addListener("loadTile", function(e) {
    if (g.beforeDraw()) {
      var t = f - e.level;
      g.hasTile(t, e.y, e.x) && o(e) && (e.key || (e.key = [t, e.y, e.x].join("_")),
      d[e.key] || y(t, e.y, e.x, function() {
        m.push(e.key, this),
        o(e) && b(e)
      }, e.key))
    }
  }),
      this.hasTile = function(e, t, n) {
        var a;
        return e + 1 < i.length && 0 < (a = i[e]).length && " " !== a[t][n]
      }
      ,
      this.drawTile = function(e, t, n, a, i) {
        e.drawImage(n, a.x, a.y, i.x, i.y)
      }
      ,
      this.getTileCell = function(e) {
        var t = m.get(e);
        return t || (t = [],
            m.push(e, t)),
            t
      }
      ,
      this.eachTileCell = function(e) {
        for (var t = m.first(); null != t; )
          e(t.key, t.data),
              t = t.next
      }
}
    , LinkCache = function(i, o) {
  var s, r, l = 0, d = {}, n = this;
  this.push = function(e, t) {
    var n = d[e];
    if (n) {
      if (1 == l || n == r)
        return;
      n.next && (n.next.pre = n.pre),
      n.pre && (n.pre.next = n.next),
      n == s && (s = n.next),
          n.next = null
    } else
      d[e] = n = {
        key: e,
        pre: null,
        next: null,
        data: t
      },
          l++;
    if (1 == l ? s = r = n : ((r.next = n).pre = r,
        r = n),
    i < l) {
      var a = s;
      s.next.pre = null,
          delete d[s.key],
          s = s.next,
          l--,
      o && o(a)
    }
  }
      ,
      this.get = function(e) {
        var t = d[e];
        return t && n.push(e),
        t && t.data
      }
      ,
      this.first = function() {
        return s
      }
      ,
      this.rest = function() {
        s = r = null,
            d = {},
            l = 0
      }
};
SlideProvider.prototype.updateObject = function(e, t, n, a) {
  this.request(this.getAppUrl(e, "/Tasks/" + t + "/Objects/" + n.id), "PUT", JSON.stringify(n), !0, new UpdateResult, function(e, t) {
    e = $.extend(e, t)
  }, a, {
    "Content-Type": "application/json"
  })
}
    ,
    SlideProvider.prototype.createObject = function(e, t, n, a) {
      this.request(this.getAppUrl(e, "/Tasks/" + t + "/Objects"), "POST", JSON.stringify(n), !0, new UpdateResult, function(e, t) {
        e.id = t
      }, a, {
        "Content-Type": "application/json"
      })
    }
    ,
    SlideProvider.prototype.deleteObject = function(e, t, n, a) {
      this.request(this.getAppUrl(e, "/Tasks/" + t + "/Objects/" + n), "DELETE", null, !0, new UpdateResult, function(e, t) {
        e = $.extend(e, t)
      }, a)
    }
;
var AppObject = function(p, g, e) {
  AppBase.apply(this, [p, g, e]);
  var h, a, f, r = {
    zh: {
      delTask: "确认从训练集“%t”中删除该切片%r%a？（如无其它切片,训练集将被一并删除）",
      roiCount: "，及其下%s个ROI",
      annCount: "、%s个标注",
      delRoi: "确认删除该ROI，及其下%s个标注？",
      delEmptyRoi: "确认删除该空ROI？"
    },
    en: {
      delTask: 'Confirm to delete the slide from "%t"%r%a?',
      roiCount: ", and its %s AOIs",
      annCount: "、%s objects",
      delRoi: "Confirm to delete the AOI, and its %s annotations?",
      delEmptyRoi: "Confirm to delete the empty AOI?"
    }
  }, v = this, m = 0;
  function n(e) {
    return "RoundedCurve" == e.type || "Polygon" == e.type
  }
  this.bind("init", function() {
    p.bind("taskChanged", function(e, t, n) {
      "object" == n
    });
    var l, d, c, u = p.getShapeCanvas(), t = u.getCommonCanvas();
    $(t).bind("click", function(e) {
      var t = v.cavToImagePoint({
        x: e.clientX,
        y: e.clientY
      });
      if (f) {
        if (f && !l.editing && l != u.getActiveShape()) {
          var i = v.transShapeToObject(l, d.roiId);
          i.id = d.id,
              m++,
              p.provider.updateObject(g, h, i, function(e) {
                if (e.success) {
                  b(),
                      $.extend(d, i),
                      u.deleteAnnotations([l.guid]),
                      f = !1;
                  var t = v.imgToCanvasPoint(new Point(d.cx,d.cy))
                      , n = v.getTile(t.x, t.y);
                  if (n != c) {
                    var a = v.getTileCell(c.key);
                    a.splice(a.indexOf(d), 1),
                        v.getTileCell(n.key).push(d)
                  }
                  v.update(n)
                }
                v.updateSaveStatus(e.success)
              })
        }
      } else {
        var n = v.getTile(e.clientX, e.clientY);
        if (!n)
          return;
        var a = v.getTileCell(n.key);
        if (a)
          for (var o = 0; o < a.length; o++) {
            var s = a[o];
            if (t.x > s.x && t.y > s.y && t.x < s.x + s.w && t.y < s.y + s.h) {
              if (v.isLockedRoi(s.roiId))
                return void console.log("LockedRoi");
              var r = y(s.detail);
              u.addAnnotations([r]),
                  u.setActiveShapeByGUID(r.guid),
                  d = s,
                  l = u.getActiveShape(),
                  c = n,
                  f = !0;
              break
            }
          }
      }
    }).bind("click", function(e) {
      if (h && e.ctrlKey) {
        var t = v.cavToImagePoint({
          x: e.clientX,
          y: e.clientY
        });
        t.model = "parse",
            t.taskId = h,
            v.createAppTask(t, function(e) {
              console.log(e)
            })
      }
    }),
        $(document).bind("keyup keydown", function(e) {
          h && (e.ctrlKey ? t.style.cursor = "copy" : t.style.cursor = "auto")
        }),
        u.bind("shapechanged", function() {
          var e;
          h && -3 == (e = u.getActiveShape()).status && n(e) && ("Del" != e.eventAction || e.isNew || (s(d),
              v.taskRoiStatus(!1, "")))
        }),
        u.bind("shapedrawend", function() {
          var e;
          a && -3 == (e = u.getActiveShape()).status && e.isNew && n(e) && (f = !0,
              function(i, o) {
                var s = v.transShapeToObject(i);
                if (!s.roiId)
                  return;
                m++,
                    p.provider.createObject(g, h, s, function(e) {
                      if (e.success) {
                        b(),
                            f = !1,
                            s.id = e.id,
                            i.isNew = !1;
                        var t = v.imgToCanvasPoint(new Point(s.cx,s.cy))
                            , n = v.getTile(t.x, t.y)
                            , a = v.getTileCell(n.key);
                        a.push(s),
                            p.getShapeCanvas().deleteAnnotations([i.guid]),
                            v.update(n),
                        o && o(i, s, n, a)
                      }
                      v.updateSaveStatus(e.success)
                    })
              }(l = e, function(i, o, e, t) {
                v.eachTileCell(function(e, t) {
                  for (var n = 0; n < t.length; n++) {
                    var a = t[n];
                    a.roiId == o.roiId && a.id !== o.id && i.isHitMyArea(v.imgToCanvasPoint(new Point(a.cx,a.cy))) && s(a)
                  }
                })
              }))
        })
  });
  var t = this.createdShape;
  this.createdShape = function(e) {
    a && n(e) ? (e.status = -3,
        e.groupId = a) : t(e)
  }
  ;
  var o = this.confirmDelRoi;
  this.confirmDelRoi = function(e) {
    if (!h)
      return o(e);
    var a = e.externalData.roiId
        , i = 0;
    return v.eachTileCell(function(e, t) {
      for (var n = 0; n < t.length; n++)
        t[n].roiId == a && i++
    }),
        confirm(MedLang.getString(0 < i ? "delRoi" : "delEmptyRoi", r).replace("%s", i))
  }
  ;
  var l = this.confirmDelTask;
  function s(i, o) {
    m++,
        p.provider.deleteObject(g, h, i.id, function(e) {
          if (e.success) {
            if (b(),
            null == o) {
              var t = v.imgToCanvasPoint(new Point(i.cx,i.cy))
                  , n = v.getTile(t.x, t.y);
              o = v.getTileCell(n.key)
            }
            if (o)
              for (var a = 0; a < o.length; a++) {
                if (o[a].id == i.id) {
                  o.splice(a, 1),
                      v.update(),
                      f = !1;
                  break
                }
              }
          }
          v.updateSaveStatus(e.success)
        })
  }
  function b() {
    0 == --m && (p.getShapeCanvas().isShapeChanged = !1)
  }
  function y(e) {
    for (var t = e.x0 + 1, n = e.y0 + 1, a = new Point(t,n), i = new Point(t,n), o = [new Point(t,n)], s = 0; s < e.contour.length; s++) {
      switch (e.contour[s]) {
        case "Q":
          t--,
              n--;
          break;
        case "W":
          n--;
          break;
        case "E":
          t++,
              n--;
          break;
        case "A":
          t--;
          break;
        case "D":
          t++;
          break;
        case "Z":
          t--,
              n++;
          break;
        case "X":
          n++;
          break;
        case "C":
          t++,
              n++
      }
      t < a.x ? a.x = t : t > i.x && (i.x = t),
          n < a.y ? a.y = n : n > i.y && (i.y = n),
          o.push(new Point(t,n))
    }
    return {
      points: o,
      imageId: "f",
      guid: guidGenerator(),
      name: "新标注 1",
      description: "请输入",
      scale: 1,
      width: 1,
      type: "RoundedCurve",
      fontUnderLine: !1,
      fontSize: 12,
      fontFamily: "Microsoft Sans Serif",
      fontItalic: !1,
      fontBold: !1,
      color: HexToNumber(ShapeDefaultConfig.defaultColor),
      measurement: !0,
      radius: 0,
      arcLength: 0,
      angle: 0,
      isLocked: !1,
      status: -3,
      visible: !0,
      region: {
        x: a.x,
        y: a.y,
        width: i.x - a.x,
        height: i.y - a.y
      }
    }
  }
  this.confirmDelTask = function(e, t) {
    if ("object" !== t.dataType)
      return l(e, t);
    var n = v.getRois(!0).length
        , a = 0;
    v.eachTileCell(function(e, t) {
      for (var n = 0; n < t.length; n++)
        a++
    });
    var i = 0 < n ? MedLang.getString("roiCount", r).replace("%s", n) : ""
        , o = 0 < a ? MedLang.getString("annCount", r).replace("%s", a) : ""
        , s = MedLang.getString("delTask", r).replace("%t", e).replace("%r", i).replace("%a", o);
    return confirm(s)
  }
      ,
      this.editObject = function(e, t, n) {
        t ? (h = e,
            a = n,
            p.bind("deletedTaksRoi", function(a) {
              v.eachTileCell(function(e, t) {
                for (var n = 0; n < t.length; n++)
                  t[n].roiId == a && (t.splice(n, 1),
                      n--)
              }),
                  v.update()
            })) : (h = a = null,
            p.unbind("deletedTaksRoi"))
      }
      ,
      this.transAnnotationToDetail = function(e) {
        var p = [["Q", "A", "Z"], ["W", "S", "X"], ["E", "D", "C"]]
            , t = e.points
            , g = []
            , n = Math.round(t[0].x)
            , h = n
            , f = n
            , a = Math.round(t[0].y)
            , v = a
            , m = a;
        return function(e) {
          for (var t = 0; t < e.length; t++) {
            var n, a, i, o = e[t], s = Math.round(o.x), r = Math.round(o.y), l = v - r, d = s - h, c = 0 <= d ? 1 : (d = -d,
                -1), u = l <= 0 ? 1 : (l = -l,
                -1);
            if (-l <= d)
              for (n = 2 * l + d,
                       a = 2 * l,
                       i = 2 * (l + d); h != s; )
                n < 0 ? (v += u,
                    n += i) : n += a,
                    h += c,
                    g.push(p[h - f + 1][v - m + 1]),
                    f = h,
                    m = v;
            else
              for (n = 2 * d + l,
                       a = 2 * d,
                       i = 2 * (l + d); v != r; )
                n < 0 ? n += a : (h += c,
                    n += i),
                    v += u,
                    g.push(p[h - f + 1][v - m + 1]),
                    f = h,
                    m = v
          }
        }(t),
            {
              x0: n - 1,
              y0: a - 1,
              contour: g.join("")
            }
      }
      ,
      this.transShapeToObject = function(e, t) {
        var n = v.transShapeToAnnotation(e)
            , a = function(e) {
          switch (e.type) {
            case "RoundedCurve":
              return e.region;
            case "Polygon":
              return function(e) {
                for (var t = e[0].x, n = e[0].y, a = t, i = n, o = 1; o < e.length; o++) {
                  var s = e[o];
                  s.x < t ? t = s.x : s.x > a && (a = s.x),
                      s.y < n ? n = s.y : s.y > i && (i = s.y)
                }
                return {
                  x: t,
                  y: n,
                  width: a - t,
                  height: i - n
                }
              }(e.points)
          }
        }(n)
            , i = {
          groupId: e.groupId,
          x: a.x,
          y: a.y,
          w: a.width,
          h: a.height,
          cx: a.x + a.width / 2,
          cy: a.y + a.height / 2,
          detail: v.transAnnotationToDetail(n),
          confidence: 100,
          area: a.width * a.height
        };
        return i.roiId = t || v.getRoiId(new Point(i.cx,i.cy)),
            i
      }
};
SlideProvider.prototype.getTaskAnnotation = function(e, t, n) {
  var a = this.getTaskUrl(e, t, "/Annotations/Query?slideId=" + this.slideId());
  this.request(a, "POST", {}, !0, {}, function(e, t) {
    e.anns = t
  }, n)
}
    ,
    SlideProvider.prototype.updateAnnotation = function(e, t, n, a) {
      this.request(this.getAppUrl(e, "/Tasks/" + t + "/Annotations/" + n.id), "PUT", JSON.stringify(n), !0, new UpdateResult, function(e, t) {
        e = $.extend(e, t)
      }, a, {
        "Content-Type": "application/json"
      })
    }
    ,
    SlideProvider.prototype.createAnnotation = function(e, t, n, a) {
      this.request(this.getAppUrl(e, "/Tasks/" + t + "/Annotations"), "POST", JSON.stringify(n), !0, new UpdateResult, function(e, t) {
        e.id = t
      }, a, {
        "Content-Type": "application/json"
      })
    }
    ,
    SlideProvider.prototype.deleteAnnotation = function(e, t, n, a) {
      this.request(this.getAppUrl(e, "/Tasks/" + t + "/Annotations/" + n), "DELETE", null, !0, new UpdateResult, function(e, t) {
        e = $.extend(e, t)
      }, a)
    }
;
var AppAnnotation = function(c, s, e) {
  AppBase.apply(this, [c, s, e]);
  var r, u = {
    zh: {
      delTask: "确认从训练集“%t”中删除该切片%r%a？（如无其它切片,训练集将被一并删除）",
      roiCount: "，及其下%s个ROI",
      annCount: "、%s个标注",
      delRoi: "确认删除该ROI，及其下%s个标注？",
      delEmptyRoi: "确认删除该空ROI？",
      saveFailed: "保存失败：",
      RoiLockedOrNotExist: "ROI已锁定"
    },
    en: {
      delTask: 'Confirm to delete the slide from "%t"%r%a',
      roiCount: ", and its %s AOIs",
      annCount: "、%s annotations",
      delRoi: "Confirm to delete the AOI, and its %s annotations?",
      delEmptyRoi: "Confirm to delete the empty AOI?",
      saveFailed: "Save Failed:",
      RoiLockedOrNotExist: "AOI locked"
    }
  }, o = 0, l = c.getShapeCanvas(), d = this, a = -1, i = [], n = {
    redo: !1,
    undo: !1
  };
  function p(e, t) {
    if (h(t))
      switch (e) {
        case AnnotationAction.Add:
          d.createAnnotation(t, function(e, t, n, a) {});
          break;
        case AnnotationAction.Del:
          !function(e) {
            o++,
                c.provider.deleteAnnotation(s, r, e, function(e) {
                  e.success && m(),
                      d.updateSaveStatus(e.success)
                })
          }(t.externalData.id);
          break;
        case AnnotationAction.Modify:
          var n = {
            id: t.externalData.id,
            roiId: t.externalData.roiId,
            annotation: d.transShapeToAnnotation(t)
          };
          o++,
              c.provider.updateAnnotation(s, r, n, function(e) {
                e.success ? (m(),
                    c.getShapeCanvas().showImageShapes()) : g(e),
                    d.updateSaveStatus(e.success)
              })
      }
  }
  function g(e) {
    var t = e.errorMessage;
    t = MedLang.getString("saveFailed", u) + (MedLang.getString(t, u) || t),
        c.showMessage(t)
  }
  function h(e) {
    return e && "VoiceAnnotation" !== e.type && !e.type.endsWith("Marquee") && !e.type.endsWith("Editor")
  }
  this.bind("init", function() {
    c.bind("beforeAnnotationChange", function(e, t, n) {
      r && -4 == t.status && S("init_" + e, t)
    }),
        c.bind("annotationChanged", function(e, t) {
          r && -4 == t.status && (S(e, t),
              p(e, t))
        })
  });
  var t = this.createdShape;
  this.createdShape = function(e) {
    h(e) ? e.status = -4 : t(e)
  }
  ;
  var f = this.confirmDelRoi;
  this.confirmDelRoi = function(e) {
    if (!r)
      return f(e);
    for (var t = e.externalData.roiId, n = 0, a = c.getShapeCanvas().getAnnotations(), i = 0; i < a.length; i++) {
      var o = a[i];
      -4 == o.status && o.externalData.roiId == t && n++
    }
    return confirm(MedLang.getString(0 < n ? "delRoi" : "delEmptyRoi", u).replace("%s", n))
  }
  ;
  var v = this.confirmDelTask;
  function m() {
    0 == --o && (c.getShapeCanvas().isShapeChanged = !1)
  }
  function b() {
    n.undo = 0 < a,
        n.redo = a < i.length - 1,
        d.redoUndoUpdate(n)
  }
  function y(e, t) {
    d.updateSaveStatus();
    var n = t.shape;
    switch (e) {
      case "init_Add":
      case "Del":
        l.deleteAnnotations([n.guid]),
            p(AnnotationAction.Del, n);
        break;
      case "Add":
      case "init_Del":
        l.getAnnotations().push(n),
            l.setActiveShapeByGUID(n.guid),
            p(AnnotationAction.Add, n);
        break;
      default:
        var a = l.getShapeByGUID(n.guid);
        for (var i in a) {
          var o = a[i];
          "object" == typeof o && 0 < o.length && (o.length = 0)
        }
        $.extend(!0, a, n),
            l.setActiveShapeByGUID(n.guid),
            p(AnnotationAction.Modify, n)
    }
    l.showImageShapes(!0)
  }
  function S(e, t) {
    var n;
    switch (i.length = ++a,
        console.log("idx:" + a + " action:" + e),
        e) {
      case "init_Add":
      case "Del":
        n = {
          guid: t.guid,
          type: t.type
        };
        break;
      case "Add":
      case "init_Del":
        n = $.extend(!0, JSON.parse(JSON.stringify(t)), t);
        break;
      default:
        n = JSON.parse(JSON.stringify(t))
    }
    n.isSelected = !1,
        n.measurement = !1,
        n.editing = !1,
        n.externalData = t.externalData = t.externalData || {},
        i.push({
          action: e,
          shape: n
        }),
        b()
  }
  this.confirmDelTask = function(e, t) {
    if ("annotation" != t.dataType)
      return v(e, t);
    for (var n = 0, a = 0, i = c.getShapeCanvas().getAnnotations(), o = 0; o < i.length; o++) {
      var s = i[o].status;
      -2 == s ? n++ : -4 == s && a++
    }
    var r = 0 < n ? MedLang.getString("roiCount", u).replace("%s", n) : ""
        , l = 0 < a ? MedLang.getString("annCount", u).replace("%s", a) : ""
        , d = MedLang.getString("delTask", u).replace("%t", e).replace("%r", r).replace("%a", l);
    return confirm(d)
  }
      ,
      this.editAnnotation = function(e, t) {
        t ? (r = e,
            c.bind("deletedTaksRoi", function(e) {
              for (var t = c.getShapeCanvas().getAnnotations(), n = [], a = 0; a < t.length; a++) {
                var i = t[a];
                -4 == i.status && i.externalData.roiId == e && n.push(i.guid)
              }
              c.getShapeCanvas().deleteAnnotations(n, !1)
            }),
            c.provider.getTaskAnnotation(s, e, function(e) {
              for (var t = e.anns, n = [], a = 0; a < t.length; a++) {
                var i = t[a]
                    , o = i.annotation;
                o.status = -4,
                    o.visible = !0,
                o.externalData || (o.externalData = {}),
                    o.externalData.id = i.id,
                    o.externalData.roiId = i.roiId,
                    o.externalData.appId = s,
                    o.isLocked = d.isLockedRoi(i.roiId),
                    n.push(o)
              }
              c.getShapeCanvas().addAnnotations(n),
                  c.trigger("task.init", "annotation")
            })) : (r = null,
            c.unbind("deletedTaksRoi"))
      }
      ,
      this.createAnnotation = function(t, n) {
        var e = d.transShapeToAnnotation(t);
        e.status = -4,
            e.visible = !0;
        var a = function(e) {
          switch (e.type) {
            case "RoundedCurve":
              return e.region;
            case "Polygon":
              return function(e) {
                for (var t = e[0].x, n = e[0].y, a = t, i = n, o = 1; o < e.length; o++) {
                  var s = e[o];
                  s.x < t ? t = s.x : s.x > a && (a = s.x),
                      s.y < n ? n = s.y : s.y > i && (i = s.y)
                }
                return {
                  x: t,
                  y: n,
                  width: a - t,
                  height: i - n
                }
              }(e.points);
            default:
              return e.region
          }
        }(e)
            , i = {
          roiId: d.getRoiId(new Point(a.x + a.width / 2,a.y + a.height / 2), !0),
          annotation: e
        };
        i.roiId && (t.externalData || (t.externalData = {}),
            t.externalData.roiId = i.roiId,
            o++,
            c.provider.createAnnotation(s, r, i, function(e) {
              e.success ? (m(),
                  t.externalData.id = i.id = e.id,
                  t.isNew = !1,
                  c.getShapeCanvas().showImageShapes(),
              n && n(t, i)) : g(e),
                  d.updateSaveStatus(e.success)
            }))
      }
      ,
      c.bind("taskChanged", function(e, t) {
        r && t && t.appId == s && (a = -1,
            i.length = 0,
            n.action = void 0,
            b())
      }),
      this.redoUndoUpdate = function(e) {}
      ,
      this.redo = function() {
        if (a < i.length - 1) {
          n.action = "redo";
          var e = i[++a];
          e.action.startsWith("init") && a < i.length - 1 && (e = i[++a]),
              y(e.action, e),
              b()
        }
      }
      ,
      this.undo = function() {
        if (0 < a) {
          n.action = "undo";
          var e = i[--a];
          y(e.action, e),
              b(),
          e.action.startsWith("init") && 0 < a && --a
        }
      }
};
$.getMultiScripts = function(e, t) {
  var n = $.map(e, function(e) {
    return $.getScript((t || "") + e)
  });
  return n.push($.Deferred(function(e) {
    $(e.resolve)
  })),
      $.when.apply($, n)
}
    ,
    SlideProvider.prototype.updateTaskTitle = function(e, t, n, a) {
      var i = this.getTaskUrl(e, t, "/Title");
      this.request(i, "PUT", n, !0, new UpdateResult, function(e, t) {
        e = $.extend(e, t)
      }, a, {
        "Content-Type": "application/json;charset=UTF-8"
      })
    }
    ,
    SlideProvider.prototype.getSubTasks = function(e, t) {
      var n = $.Deferred();
      return this.request(this.getAppUrl(e, "/Tasks/" + t + "/SubTasks"), "GET", {}, !0, {}, function(e, t) {
        e.data = t
      }, function(e) {
        n.resolve(e.data)
      }),
          n.promise()
    }
    ,
    SlideProvider.prototype.getTaskRoi = function(e, t, n) {
      this.request(this.getAppUrl(e, "/Tasks/" + t + "/Slides/" + this.slideId() + "/Rois"), "GET", {}, !0, {}, function(e, t) {
        e.data = t
      }, n)
    }
;
var TaskList = function(o, l, e, d) {
  TaskList.initDrag || ($(document).delegate("label.app-task", "dragstart", function(e) {
    e = e.originalEvent;
    var t = $(this).find("input[type=checkbox]")
        , n = t.attr("data-type");
    n ? TaskList.dragData = {
      id: t.attr("data-id"),
      appId: t.attr("data-app"),
      type: n
    } : e.preventDefault()
  }).delegate("label.app-task", "dragover", function(e) {
    e = e.originalEvent;
    var t = $(this).find("input[type=checkbox]").attr("data-type");
    t && t === TaskList.dragData.type && (this.style.borderColor = "black",
        e.preventDefault())
  }).delegate("label.app-task", "dragleave", function(e) {
    this.style.borderColor = "transparent"
  }).delegate("label.app-task", "drop", function(e) {
    e = e.originalEvent,
        this.style.borderColor = "transparent";
    var t = TaskList.dragData
        , n = $(this).find("input[type=checkbox]")
        , a = n.attr("data-type");
    if (t.type === a) {
      var i = "/Apps/" + n.attr("data-app") + "/Tasks/" + n.attr("data-id") + "/Diff";
      i = o.provider.getSigUrl(i),
          i += "&fromApp=" + t.appId + "&fromTask=" + t.id + "&slideId=" + v + "&type=" + a,
          window.open(i)
    }
  }),
      TaskList.initDrag = !0);
  var c = $("<div class='list_items task_list'></div>")
      , u = {
    review: !1,
    subTask: !1,
    multiSelect: !0,
    annotation: !0,
    selectable: function(e) {
      return e.hasAnno
    },
    change: function(e, t) {},
    confirmDel: null,
    paramsHtml: function(e) {
      return ""
    },
    link: null
  };
  u = $.extend(u, e);
  var p = {}
      , g = [];
  function h(e) {
    return "<li>" + e["appName_" + a] + "<br/>" + new Date(e.createTime + 288e5).toISOString().substring(0, 19).replace("T", " ") + "</li>"
  }
  c.delegate("input[type=checkbox]", "change", function() {
    var e = $(this).attr("data-id")
        , t = p[e]
        , s = $(this).closest("label");
    if (this.checked) {
      if (u.multiSelect || c.find("input").not(this).each(function() {
        if ($(this).closest("label").removeClass("checked"),
            this.checked) {
          this.checked = !1;
          var e = p[$(this).attr("data-id")];
          e.annotations && o.getShapeCanvas().delAnnotations(e.annotations, !1);
          for (var t = 0; t < g.length; t++) {
            var n = g[t];
            n.parentId == e.id && (d.unsubscribeTask(n.id),
                g.splice(t, 1),
                t--)
          }
          0 == g.length && d && d.updateRunStatus(!1)
        }
      }),
          c.addClass("checked"),
          s.addClass("checked"),
          !this.loadSubTasks) {
        var r = e;
        o.provider.getSubTasks(l, e).then(function(e) {
          for (var t = "<ul>", n = !1, a = 0; a < e.length; a++) {
            var i = e[a];
            if (i.elmt = b(i),
                t += h(i),
            !n && "FINISHED" != i.status && d.isRunStatus(i.status)) {
              var o = parseInt(((new Date).getTime() - i.createTime) / 1e3);
              d.updateRunStatus(!0, i.status, o, i.id, i.appId),
                  d.subscribeTask(i.id),
                  i.parentId = r,
                  g.push(i),
                  n = !0
            }
          }
          t += "</ul>",
              s.find(".sub-tasks").empty().append(t)
        })
      }
    } else {
      c.removeClass("checked"),
          s.removeClass("checked");
      for (var n = 0; n < g.length; n++)
        d.unsubscribeTask(g[n].id);
      d && d.updateRunStatus(!1)
    }
    o.trigger("taskChanged", this.checked ? e : null, t, t.dataType || u.type),
        u.change(p[e], this.checked)
  }).delegate(".btn.delete", "click", function() {
    var n = $(this).closest("label")
        , a = n.find("[type=checkbox]").attr("data-id");
    if ("annotation" == p[a].dataType && "function" == typeof u.confirmDel)
      u.confirmDel(n.find(".title-wrap span").text(), p[a]) && o.provider.deleteTask(l, a, function(e) {
        if (e.success) {
          var t = n.fadeOut(function() {
            0 == t.siblings().length && c.hide(),
                t.remove()
          });
          t.find("input[type=checkbox]").prop("checked") && t.click(),
              o.trigger("task.delete", l, a, e.op)
        } else
          "HaveLockedRoi" == e.errorMessage && o.showMessage(MedLang.getString("delLockedRoi", r))
      });
    else {
      var e = this
          , t = $(this).parent().hide()
          , i = t.siblings(".deleteAlert").fadeIn("fast");
      this.init || (this.init = !0,
          i.bind("mouseenter", function() {
            clearTimeout(e.tt)
          }).bind("mouseleave", function() {
            e.tt = setTimeout(function() {
              i.fadeOut("fast"),
                  t.css("display", "")
            }, 1e3)
          }))
    }
    return !1
  }).delegate(".deleteAlert", "click", function() {
    return !1
  }).delegate(".deleteAlert>span", "click", function() {
    var n = $(this);
    return o.provider.deleteTask(l, n.attr("data-id"), function(e) {
      if (e.success) {
        var t = n.parent().parent().fadeOut(function() {
          0 == t.siblings().length && c.hide(),
              t.remove()
        });
        t.find("input[type=checkbox]").prop("checked") && t.click(),
            o.trigger("task.delete", l, n.attr("data-id"), e.op)
      } else
        "HaveLockedRoi" == e.errorMessage && o.showMessage(MedLang.getString("delLockedRoi", r))
    }),
        !1
  }).delegate(".btn.copy", "click", function() {
    var i = $(this).closest("label").find("input:checkbox");
    return t(i.attr("data-id"), function(e) {
      for (var t = [], n = 0; n < e.length; n++) {
        var a = $.extend({}, e[n].annotation);
        a.guid = guidGenerator(),
            a.status = 0,
            delete a.isLocked,
            delete a.externalData,
            t.push(a)
      }
      o.getShapeCanvas().addAnnotations(t, !0),
      i.prop("checked") && i.click()
    }),
        !1
  }).delegate(".btn.diff", "click", function() {
    var a = $(this).closest("label")
        , e = a.find("input:checkbox");
    return t(e.attr("data-id"), e.attr("data-name"), function(e) {
      var t = o.getCurrentImage()
          , n = function(e, t, n) {
        if (!s) {
          var a, i;
          e.width > e.height ? i = (a = 256) * e.height / e.width : a = (i = 256) * e.width / e.height,
              (s = document.createElement("canvas")).scale = a / e.width,
              s.width = a,
              s.height = i,
              s.className = "diff"
        }
        var o = s.getContext("2d");
        return o.clearRect(0, 0, s.width, s.height),
            o.save(),
            o.scale(s.scale, s.scale),
            o.fillStyle = "red",
            o.globalCompositeOperation = "source-over",
            f(o, t),
            o.fillStyle = "blue",
            o.globalCompositeOperation = "lighter",
            f(o, n),
            o.restore(),
            function(e) {
              for (var t = e.data, n = 0, a = 0, i = 0, o = 0; o < t.length; o += 4) {
                if (0 == t[o]) {
                  if (0 == t[o + 1] && 0 == t[o + 2]) {
                    i++;
                    continue
                  }
                  if (0 == t[o + 1] && 255 == t[o + 2]) {
                    a++;
                    continue
                  }
                }
                255 == t[o] && 0 == t[o + 1] && 0 == t[o + 2] && n++
              }
              var s = e.width * e.height - n - a - i
                  , r = 0 == n && 0 == s || 0 == a && 0 == s;
              return {
                sensitivity: r ? 0 : s / (n + s),
                specificity: r ? 0 : i / (i + a),
                accuracy: r ? 0 : s / (n + a + s)
              }
            }(o.getImageData(0, 0, s.width, s.height))
      }({
        width: t.width,
        height: t.height
      }, t.annotations, e);
      !function(e, t) {
        var n = [MedLang.getString("sensitivity", r), " ", a(t.sensitivity), "<br>", MedLang.getString("specificity", r), " ", a(t.specificity), "<br>", MedLang.getString("accuracy", r), " ", a(t.accuracy)];
        function a(e) {
          return Math.round(1e3 * e) / 10 + "%"
        }
        e.find(".diff-result").html(n.join(""))
      }(a, n)
    }),
        !1
  }).delegate(".btn.edit", "click", function() {
    $(this).closest("label");
    var e = $(this).closest("label").find("input:checkbox").attr("data-id")
        , t = $("#ng");
    return TaskList.editTask || angular.bootstrap(t[0], ["gallery"]),
        TaskList.editTask = p[e],
        angular.element(t[0]).scope().loadTask(l, e),
        t.find(">div").modal("show"),
        !1
  }).delegate(".title-wrap span", "click", function() {
    return $(this).parent().hide().siblings().show().select().closest("label").find(".tools").addClass("hide"),
        !1
  }).delegate(".title-wrap input", "click", function() {
    return !1
  }).delegate(".title-wrap input", "blur", function() {
    var e = $(this);
    if ("" != e.val() && e.val() != e.siblings().text()) {
      var t = e.closest("label").find("input[type=checkbox]").attr("data-id");
      o.provider.updateTaskTitle(l, t, e.val(), function() {
        e.hide().siblings().show().find("span").text(e.val()).closest("label").find(".tools").removeClass("hide"),
            p[t].title = e.val(),
            o.trigger("task.change", p[t])
      })
    } else
      e.hide().siblings().show().closest("label").find(".tools").removeClass("hide")
  }).delegate("input[type=text]", "keydown", function(e) {
    13 == e.keyCode && $(this).blur()
  }).delegate(".btn.review", "click", function(e) {
    var t = $(this).closest("label").find("input").attr("data-id")
        , n = "/Apps/" + l + "/Tasks/" + t + "/Page";
    return n = o.provider.getSigUrl(n),
        n += "&slideId=" + v,
        window.open(n),
        !1
  }),
      o.bind("task.add", function(e, t) {
        if (e.appId == l) {
          var n = p[e.id.toUpperCase()];
          if (n) {
            if ("FINISHED" != e.status)
              return;
            n.elmt.find("input[type=checkbox]")[0].checked && n.elmt.click(),
                n.elmt.remove()
          }
          (p[e.id] = e).createTime = new Date(e.createTime + 288e5).toISOString().substring(0, 19).replace("T", " "),
              e.elmt = b(e),
              c.prepend(e.elmt),
              c.show(),
              "FINISHED" == e.status ? t && e.elmt.click() : e.elmt.find("input[type=checkbox]").prop("disabled", !0)
        } else
          e.parentId && p[e.parentId.toUpperCase()] && p[e.parentId.toUpperCase()].elmt.find(".sub-tasks ul").prepend(h(e))
      }),
      o.bind("task.finish", function(e) {
        if (e.appId == l) {
          var t = p[e.id.toUpperCase()];
          t.elmt.find("input[type=checkbox]").prop("disabled", !1).parent().removeClass("hide"),
              t.elmt.find(".btn.delete").removeClass("hide"),
              t.elmt.find(".btn.review").removeClass("hide"),
              c.show(),
              t.elmt.find("input[type=checkbox]")[0].checked = !1,
              t.elmt.click()
        }
      });
  var a = SlideViewerConfig.language;
  "zh" == a && (a = "zh_CN");
  var n, s, r = {
    en: {
      review: "Review",
      diff: "Diff",
      copy: "Copy",
      inference: "Analyze",
      training: "Training",
      sensitivity: "sensitivity",
      specificity: "specificity",
      accuracy: "accuracy",
      untitled: "Untitled",
      share: "Share",
      delLockedRoi: "Contain locked AOI cannot be delete",
      annotation: "Annotation",
      object: "Object"
    },
    zh: {
      review: "复核",
      diff: "对比",
      copy: "复制",
      inference: "分析",
      training: "训练",
      sensitivity: "敏感性",
      specificity: "特异性",
      accuracy: "准确度",
      untitled: "未命名",
      share: "共享",
      delLockedRoi: "包含锁定ROI无法删除",
      annotation: "标注",
      object: "细胞"
    }
  };
  function t(e, t) {
    n = setTimeout(function() {
      i(!0)
    }, 1e3),
        o.provider.getTaskAnnotation(l, e, function(e) {
          i(!1),
              t(e.anns)
        })
  }
  function i(e) {
    clearTimeout(n),
    !e && n || (o.showMessage(MedLang.getString("Loading"), e ? 6e4 : 0),
    e && (n = !1))
  }
  function f(e, t) {
    for (var n = 0; n < t.length; n++) {
      var a = t[n];
      switch (a.type) {
        case "Polygon":
        case "RoundedCurve":
        case "FreeRoundedCurve":
          e.beginPath();
          for (var i = 0; i < a.points.length; i++) {
            var o = a.points[i];
            0 == i ? e.moveTo(o.x, o.y) : e.lineTo(o.x, o.y)
          }
          e.fill();
          break;
        case "Rectangle":
          e.fillRect(a.region.x, a.region.y, a.region.width, a.region.height);
          break;
        case "Ellipse":
          var s = a.region.width / 2
              , r = a.region.height / 2
              , l = a.region.x + s
              , d = a.region.y + r
              , c = .5522848 * s
              , u = .5522848 * r;
          e.beginPath(),
              e.moveTo(l - s, d),
              e.bezierCurveTo(l - s, d - u, l - c, d - r, l, d - r),
              e.bezierCurveTo(l + c, d - r, l + s, d - u, l + s, d),
              e.bezierCurveTo(l + s, d + u, l + c, d + r, l, d + r),
              e.bezierCurveTo(l - c, d + r, l - s, d + u, l - s, d),
              e.fill();
          break;
        case "Circle":
          var p = CalcRadius({
            x: 0,
            y: 0
          }, {
            x: a.region.width,
            y: a.region.height
          });
          e.beginPath(),
              e.arc(a.region.x, a.region.y, p, 0, 2 * Math.PI, !1),
              e.fill();
          break;
        case "CircleThreePoints":
          var g = CalcCenterPoint(a.points[0], a.points[1], a.points[2]);
          p = CalcRadius(g, a.points[0]);
          e.beginPath(),
              e.arc(g.x, g.y, p, 0, 2 * Math.PI, !1),
              e.fill()
      }
    }
  }
  var v = o.getCurrentSlide().id
      , m = $.query.get("case");
  function b(e) {
    var t = u.selectable(e)
        , n = '<label class="checkbox app-task" style="border: 1px dashed transparent;" draggable="true" ' + (t ? "" : "disabled") + '">';
    n += '<span class="tools btn-group">',
    "annotation" == (e.dataType || u.type) && (n += '<span class="btn btn-xs btn-primary copy">' + MedLang.getString("copy", r) + "</span>"),
    u.review && (n += '<a class="btn btn-xs btn-primary review ' + ("FINISHED" == e.status ? "" : "hide") + '" target1="_blank" href="javascript:void(0)" href1="/MoticGallery/Apps/' + l + "/Tasks/" + e.id + "/Page?slideId=" + v + "&caseType=" + (m ? "&caseId=" + m : "") + '">' + (u.reviewText || MedLang.getString("review", r)) + "</a>");
    e.mine ? (e.hasAnno && (n += '<span class="btn btn-xs btn-primary diff">' + MedLang.getString("diff", r) + "</span>"),
        n += '<span class="btn btn-xs btn-primary edit">' + MedLang.getString("share", r) + "</span>",
        n += '<span class="btn btn-xs btn-danger delete ' + (-1 < "BOOTFAILED(11),CRASH(13),ABORTED(15),CANCEL(17),FINISHED(0)".indexOf(e.status) ? "" : "hide") + '"><i class="glyphicon glyphicon-remove"></i></span></span>',
        n += '<div class="deleteAlert" style="height: 100%;display:none"><span class="btn btn-sm btn-danger" data-id="' + e.id + '" data-lang="Buttons.Delete">删除</span></div>') : n += "</span>";
    return n += '<div class="' + (t ? "" : "hide") + '"><input type="checkbox" data-app="' + l + '" data-id="' + e.id + '" data-name="' + e["appName_" + a] + '" data-type="' + ("unknown" == e.dataType && u.type || e.dataType) + '" ' + (t ? "" : "disabled") + '></div>        <div style="padding-left: 5px;">',
    e.title || (e.title = MedLang.getString("untitled", r)),
        n += '<div class="title-wrap"><div>',
    e.mine && (n += "<span>"),
        n += e.title,
    e.mine && (n += "</span>"),
    u.type || (n += ' <small style="font-size:50%;color:#777;">' + MedLang.getString(e.dataType, r) + "</small>"),
        n += "</div>",
    e.mine && (n += '<input class="blur" style="display:none;" type="text" value="' + e.title + '">'),
        n += "</div>",
        n += '<div style="font-weight:normal;font-size: 50%;font-style: italic"> ' + e.userName + " " + e.createTime + "<br/>",
        n += u.paramsHtml(e),
        n += '<div class="diff-result"></div>',
        n += '<div class="sub-tasks"></div></div></div></label>',
        $(n)
  }
  this.elmt = c[0]
}, SlideRescan = function(n, e) {
  var a = {
    zh: {
      name: "Require Rework",
      title: "Reject Scan",
      reject: "Reject",
      undo: "Undo",
      desc: "<h4>Please confirm scan rejection</h4><div>Rejection requires clinician rework.</div>",
      rejected: "Scan Rejected",
      failed: "Update rescan failed."
    },
    en: {
      name: "Require Rework",
      title: "Reject Scan",
      reject: "Reject",
      undo: "Undo",
      desc: "<h4>Please confirm scan rejection</h4><div>Rejection requires clinician rework.</div>",
      rejected: "Scan Rejected",
      failed: "Update rescan failed."
    }
  }
      , i = this;
  this.name = MedLang.getString("name", a);
  var t = '<div style="position:fixed;top:0;width:100%;z-index:999;background-color:rgba(0,0,0,0.5);padding:10px;display:none;">            <div class="container text-center">                <span style="display:inline-block;color:#ffffff;font-size: 150%" data-lang="rejected">rejected</span>                <button class="btn btn-default pull-right" data-lang="undo"></button>            </div>        </div>';
  t = $(t).find("button").bind("click", function() {
    s(!1)
  }).end().find("[data-lang]").html(function() {
    var e = $(this).attr("data-lang");
    return MedLang.getString(e, a) || SlideViewerStrings.getString(e)
  }).end(),
  0 === $.query.get("menu") && t.find("button").hide(),
      this.elmt = t[0];
  var o = !1;
  setTimeout(function() {
    n.provider.getPropPromise().then(function(e) {
      r(o = !!e.rescan)
    })
  });
  function s(t) {
    n.provider.updateProp("rescan", !!t, function(e) {
      e.success ? r(o = t) : n.showMessage(MedLang.getString("failed", a))
    })
  }
  function r(n) {
    n ? t.show() : t.hide(),
        e.find("li").each(function(e) {
          var t = $(this);
          -1 != t.text().indexOf(i.name) && (n ? t.addClass("disabled") : t.removeClass("disabled"))
        })
  }
  this.show = function() {
    o || s(!0)
  }
      ,
      this.hide = function() {}
}, SubmenuPanel = function(t, n, a) {
  var e = '<div class="popover submenu">                <h3 class="popover-title"><span></span><button type="button" class="close" data-dismiss="alert">&times;</button></h3>                <div class="popover-content"></div>                <div class="footer"></div>             </div>'
      , i = $(e);
  e = null;
  var o = !1
      , s = !1
      , r = $(this)
      , l = $.support
      , d = 0;
  function c(e) {
    e ? o = !1 : (i.animate({
      left: 0
    }),
    s && r.trigger("keepSide"))
  }
  function u(e) {
    a ? i.css(e) : i.css({
      left: e.left,
      bottom: "25px",
      top: "auto"
    })
  }
  !function() {
    i.find("h3>span").html(t.name);
    var e = $(window).height() - 330;
    e < 540 && (e = 540),
    t.footer && (i.find("div.footer").html(t.footer),
        e -= 180);
    var n = i.find("div.popover-content").html(t.elmt).css("max-height", e);
    i.hide().bind("click", function(e) {
      l.mouse && i.bind("mouseleave", function(e) {
        i.unbind("mouseleave"),
            r.trigger("mouseleave", [e, c])
      }),
      s && (o = !0),
          e.stopPropagation()
    }).find("button.close").bind("click", function(e) {
      l.mouse && i.unbind("mouseleave"),
          i.fadeOut("fast"),
          o = !1,
          r.trigger("close"),
          e.stopPropagation()
    }),
    l.touch && (i.bind("touchstart touchmove", function(e) {
      e.stopPropagation()
    }),
        $("body").bind("touchstart", function(e) {
          s && o && r.trigger("mouseleave", [e, c])
        }),
        n.bind("touchstart", function(e) {
          d = this.scrollTop + e.originalEvent.touches[0].pageY
        }).bind("touchmove", function(e) {
          this.scrollTop = d - e.originalEvent.touches[0].pageY
        })),
        $(t).bind("append", function(e, t) {
          n[0].scrollTop = t
        })
  }(),
      this.show = function(e) {
        return i.show().position({
          of: n,
          my: "left " + (a ? "top" : "bottom"),
          at: "right " + (a ? "top" : "bottom"),
          collision: "fit fit",
          using: u
        }),
            s = !0,
        e && i.effect("slide", "fast"),
            r.trigger("shown"),
            i
      }
      ,
      this.hide = function(e) {
        !s || !e && o || (i.hide(),
            s = o = !1)
      }
      ,
      this.elmt = i
}, RegionList2 = function(c, u, p) {
  var g = $('<ul class="regions">\t\t\t  </ul>')
      , e = MMDSSlideViewerStrings.getString("Menus.SearchResult")
      , h = MMDSSlideViewerStrings.getString("Labels.Size")
      , f = MMDSSlideViewerStrings.getString("Labels.Similarity");
  !function() {
    for (var e = "", t = c.getCurrentImage(), n = t.width, a = 0; a < u.length; a++) {
      var i = u[a]
          , o = i.x2 - i.x1 + 1
          , s = i.y2 - i.y1 + 1
          , r = t.scanObjective / i.o
          , l = (i.x1 + o / 2) * r / n
          , d = (i.y1 + s / 2) * r / n;
      e += ['<li data-o="' + i.o + '" data-x="', l, '" data-y="', d, '"><div>', h, o, "x", s, "</div><div>", f, (100 * i.s).toFixed(1), "%", "</div></li>"].join(""),
      p === a && (c.zoomToObj(i.o),
          c.viewport.panTo(new SeadragonPoint(l,d)))
    }
    g.append(e).delegate("li", "click", function() {
      var e = $(this);
      c.zoomToObj(parseInt(e.attr("data-o"))),
          c.viewport.panTo(new SeadragonPoint(parseFloat(e.attr("data-x")),parseFloat(e.attr("data-y"))))
    })
  }(),
      this.name = function() {
        return e
      }
      ,
      this.elmt = g[0]
}, SlideMenu = function(d, c) {
  var u = $('<li style="font-size:16px;"><a class="blur" tabindex="-1"></a></li>')
      , p = '<div id="menu" style="margin:20px 0">                <ul style="display:block;" class="dropdown-menu">                    <div class="pin"></div>                </ul>                <a class="dropdown-toggle menu"></a>\t          </div>';
  p = $(p);
  var g = !0
      , h = SlideViewerConfig
      , f = h.showMenu()
      , v = f ? 1 : -1
      , m = new Array
      , b = p.find("ul")
      , y = p.find("a")
      , S = $.support;
  function w(e, t) {
    g = !0;
    var n = e ? 0 : -(b.outerWidth() + 10);
    e && y.hide(),
        v = 0,
        b.animate({
          left: n
        }, function() {
          v = e ? 1 : -1,
          !e && t && y.show()
        })
  }
  function C(e, t) {
    var n = new SubmenuPanel(e,b,c.topAlign);
    if (!1 !== t) {
      $(n).bind("close", function() {
        g = !0,
            f ? w(!0) : -1 == v && y.fadeIn()
      }).bind("keepSide", function() {
        v = 0,
            w(g = !1)
      }).bind("mouseleave", function(e, t, n) {
        var a = (t.offsetX < 0 || t.clientX < b.outerWidth()) && t.pageY > b.offset().top;
        "function" == typeof n && n(a)
      });
      var a = u.clone().bind("click", function(e) {
        if (1 == v) {
          for (var t = 0; t < m.length; t++)
            m[t].hide(S.touch || !1);
          n.show(g)
        }
        g = !1,
            $(this).addClass("dropdown-submenu"),
            e.stopPropagation()
      });
      a.appendTo(b).find("a").html(e.name),
      e.show && !1 === e.show() && a.hide(),
          e.show = function(e) {
            return e ? a.show() : a.hide(),
                e
          }
          ,
          m.push(n)
    }
    return d.addControl(n.elmt[0], Seadragon.ControlAnchor.NONE),
        n
  }
  !function() {
    var e = $.query;
    h.enableMenu || p.addClass("hidden");
    var t = !1 !== c.capture && h.enableSnapshot;
    if (C(new SlideCapture(d,t), t),
    2 === h.enableAnnotation && (C(new SlideAnnotation(d)),
    h.enableRelevantAnnotation && SlideViewerSupport.canvas && C(new RelevantAnnotation(d))),
    !1 !== c.rs && h.enableRelevantSlide) {
      var n = new RelevantSlide(d)
          , a = $(C(n)).one("shown", function() {
        a.trigger("scroll")
      })[0].elmt.find(".popover-content");
      d.bind("loadedRelevantSlide", function() {
        $(n.elmt).find("img").lazyload({
          container: a
        })
      })
    }
    if (h.enableImageAdjustment) {
      var i = C(new SlideImageAdjustments(d));
      1 != e.get("sia") && 1 != sessionStorage.getItem("sv_sia") || (sessionStorage.removeItem("sv_sia"),
          setTimeout(function() {
            i.show(!1).css("left", 0)
          }, 500))
    }
    if (h.enableAdvanced && !d.provider.isReadOnly()) {
      var o = new AdvancedMenu(d,b)
          , s = u.clone().bind("click", function(e) {
        if (1 == v) {
          for (var t = 0; t < m.length; t++)
            m[t].hide(S.touch || !1);
          o.show(g)
        }
        g = !1,
            $(this).addClass("dropdown-submenu"),
            e.stopPropagation()
      });
      o.showMenu() || s.hide(),
          s.appendTo(b).find("a").html(o.name),
          m.push(o)
    }
    if (5 == e.get("style")) {
      var r = new SlideRescan(d,b);
      u.clone().bind("click", function(e, t) {
        if (1 == v) {
          for (var n = 0; n < m.length; n++)
            m[n].hide(S.touch || !1);
          t || r.show()
        }
        $(this).addClass("dropdown-submenu"),
            e.stopPropagation()
      }).appendTo(b).find("a").html(r.name),
          m.push(r),
          d.addControl(r.elmt, Seadragon.ControlAnchor.NONE)
    }
    h.showOption && (b.append('<li class="divider"></li>'),
        C(new SlideOptions(d)));
    var l = 0 !== $.query.get("hover") ? "mouseenter click" : "click";
    y.bind(l, function(e) {
      w(!0)
    }),
        p.bind("touchstart touchmove mousedown click", function(e) {
          e.stopPropagation()
        }),
        $("body").bind((S.touch ? "touchstart " : "") + "click", function() {
          if (1 == v) {
            for (var e = 0; e < m.length; e++)
              m[e].hide();
            g = !0,
                b.find("li").removeClass("dropdown-submenu"),
            f || w(!1, !0)
          }
        }),
    S.mouse && b.delegate("a", "mousemove", function() {
      g && 1 == v && $(this).focus().parent().trigger("click", !0)
    }).menuAim({
      activate: function(e) {
        if (e = $(e),
        1 != v || e.hasClass("divider"))
          return !1;
        e.trigger("click", !0).find("a").focus()
      },
      deactivate: function(e) {
        $(e).removeClass("dropdown-submenu")
      },
      eventName: "mouseenter"
    }),
        b.find("div.pin").bind("click", function() {
          return f = !f,
              h.showMenu(f),
              $(this).toggleClass("active"),
              !1
        }),
    f && (w(f),
        b.find("div.pin").addClass("active"))
  }(),
      this.elmt = p[0]
}, MsgBox;
!function() {
  var a, i, o, s = '<div class="modal fade" style="overflow:auto"><div class="modal-dialog" style="margin-top:2%"><div class="modal-content">        <div class="modal-header">          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>          <h3></h3>        </div>        <div class="modal-body">        </div>      <div class="modal-footer">        <button class="btn btn-primary" data-lang="Buttons.Ok"></button>        <button class="btn btn-default" data-dismiss="modal" aria-hidden="true"  data-lang="Buttons.Cancel"></button>      </div>    </div></div></div>', r = !0;
  MsgBox = {
    confirm: function(e, t, n) {
      r && (r = !1,
          (s = $(s)).find("[data-lang]").html(function() {
            return SlideViewerStrings.getString($(this).attr("data-lang"))
          }),
          s.appendTo("body").modal({
            show: !1,
            backdrop: "static"
          }),
          i = s.find("h3"),
          o = s.find(".modal-body"),
          s.find(".btn-primary").bind("click", function() {
            a && a(),
                s.modal("hide")
          })),
          a = n,
          i.html(e),
          o.html(t),
          s.modal("show")
    }
  }
}();
var LeapMotion = function(k) {
  var x = !0
      , e = new Leap.Controller({
    enableGestures: !0
  });
  e.on("deviceConnected", function() {
    console.debug("A Leap device has been connected.")
  }),
      e.on("deviceDisconnected", function() {
        console.debug("A Leap device has been disconnected.")
      }),
      e.on("focus", function() {
        x = !0
      }),
      e.on("blur", function() {
        x = !1
      });
  var A, T = null, M = null, R = k.is3DImage(), I = $(document);
  function D(e) {
    var t = k.viewport.deltaPointsFromPixels(new Seadragon.Point(document.width / 2 - 10,document.height / 2 - 10), !0);
    e.x = n(e.x, t.x),
        e.y = n(e.y, t.y),
        k.viewport.panTo(e)
  }
  function n(e, t) {
    return 1 - t < e ? 1 - t : e < t ? t : e
  }
  e.loop(function(e) {
    if (x)
      if (1 == e.hands.length) {
        for (var t = 0; t < e.gestures.length; t++) {
          var n = e.gestures[t];
          if ("swipe" == n.type) {
            var a = n.position
                , i = n.startPosition
                , o = a[0] - i[0]
                , s = a[1] - i[1]
                , r = a[2] - i[2];
            if (Math.abs(r) > Math.abs(o) && Math.abs(r) > Math.abs(s))
              break;
            o *= -4,
                s *= 4;
            var l = I.width()
                , d = I.height();
            if (Math.abs(o) > l && (o = o / Math.abs(o) * l),
            Math.abs(s) > d && (s = s / Math.abs(s) * d),
                s += d / 2,
                o += l / 2,
            isNaN(o) || isNaN(s))
              return;
            var c = new Seadragon.Point(o,s);
            return void D(c = k.viewport.pointFromPixel(c, !0))
          }
        }
        var u = e.hands[0].palmPosition;
        if (e.hands[0].pointables.length <= 2) {
          var p = e.hands[0].pointables;
          for (t = 0; t < p.length; t++) {
            var g = p[t];
            if (1 == p.length)
              A = g.id;
            else if (g.id != A)
              continue;
            if (Math.abs(u[0]) < 80 && Math.abs(u[1] - 200) < 80 && Math.abs(u[2] - 20) < 80) {
              var h = g.direction;
              o = h[0],
                  s = h[1];
              o *= 150,
                  s *= -150,
                  o += I.width() / 2,
                  s += I.height() / 2;
              c = new Seadragon.Point(o,s);
              D(c = k.viewport.pointFromPixel(c, !0))
            }
          }
          return
        }
        if (R) {
          if (null == M)
            return void (M = u);
          var f = Math.abs(u[0] - M[0])
              , v = Math.abs(u[1] - M[1])
              , m = Math.abs(u[2] - M[2]);
          if (4 * f < m && 4 * v < m)
            1 <= (r = Math.floor(m / 20)) && (u[2] < M[2] && (r = -r),
                k.tierScroll.addTierIndex(r, !0),
                M = u)
        }
      } else if (2 == e.hands.length) {
        if (e.hands[0].pointables.length < 2 || e.hands[1].pointables.length < 2)
          return void (T = null);
        var b = e.hands[0].palmPosition[0]
            , y = e.hands[1].palmPosition[0]
            , S = Math.abs(b - y);
        if (null == T)
          return void (T = S);
        var w = S - T
            , C = k.viewport.getZoom();
        0 < w ? C += w * w / 200 : C -= w * w / 200,
            C > k.viewport.getMaxZoom() ? C = k.viewport.getMaxZoom() : C < k.viewport.getMinZoom() && (C = k.viewport.getMinZoom()),
            k.viewport.zoomTo(C),
            T = S
      } else
        M = null
  })
}
    , MMDSSlideViewer = function(e) {
  var f = this
      , v = 0
      , m = $.query
      , b = m.get("i") || sessionStorage.getItem("sv_i") || "f";
  sessionStorage.removeItem("sv_i");
  var i = top != window
      , y = m.get("taskId") || ""
      , w = new SlideViewer(e)
      , n = w.showMessage;
  w.showMessage = function(e, t) {
    n($("<span></span>").text(e).html(), t)
  }
  ;
  var a = "mg_slideviewer"
      , o = (new Date).getTime();
  function s() {
    var e = {
      type: "Focus",
      slideId: w.getCurrentSlide().id
    };
    w.provider.postMessage(JSON.stringify(e))
  }
  w.broadcast = function(e, t) {
    0 <= (t = t || 0) && (e.pageId = o,
        localStorage.setItem(a, JSON.stringify(e)),
        localStorage.removeItem(a),
        w.provider.postMessage(e)),
    t <= 0 && w.trigger(e.type, e)
  }
      ,
      $(window).bind("storage", function(e) {
        if ((e = e.originalEvent).key == a && e.newValue) {
          var t = JSON.parse(e.newValue);
          t.pageId != o && w.trigger(t.type, t)
        }
      }).on("message", function(e) {
        if ((e = e.originalEvent).data) {
          var t = "object" == typeof e.data ? e.data : JSON.parse(e.data);
          t.type && w.trigger(t.type, t)
        }
      }),
      $(document).delegate("input[type=checkbox]", "change", function() {
        $(this).blur()
      }).bind("click", function(e) {
        e.target !== document.activeElement && $(document.activeElement).blur(),
            s()
      }),
      w.bind("beforecreatenavigationview", function(e) {
        var t, n = $(document).width();
        t = n < 1280 ? 150 : n < 1600 ? 200 : 250,
            e.x > e.y ? (e.y = Math.floor(e.y / e.x * t),
                e.x = t) : (e.x = Math.floor(e.x / e.y * t),
                e.y = t),
        SlideViewerConfig.isPhone && (e.x *= .5,
            e.y *= .5)
      });
  var C = !1;
  function S() {
    var e = w.getCurrentSlide().id
        , t = (w.getCurrentImage(),
        $(window));
    "full" == $.query.get("fitHome") && w.provider.getSlideExtPromise().then(function(e) {
      !function(e, t) {
        if (!C) {
          var n = w.viewport
              , a = 0
              , i = 0
              , o = e.width
              , s = e.height
              , r = new Point(a,i)
              , l = new Point(a + o,i + s)
              , d = new Point(l.x,i)
              , c = new Point(a,l.y)
              , u = new Point(a + o / 2,i + s / 2)
              , p = x(r, -t, u)
              , g = x(l, -t, u)
              , h = x(d, -t, u)
              , f = x(c, -t, u);
          a = Math.min(p.x, g.x, h.x, f.x),
              i = Math.min(p.y, g.y, h.y, f.y),
              o = Math.max(p.x, g.x, h.x, f.x) - a,
              s = Math.max(p.y, g.y, h.y, f.y) - i,
              a /= e.width,
              i /= e.width;
          var v = (o /= e.width) / (s /= e.width)
              , m = n.getAspectRatio()
              , b = new SeadragonRect(a,i,o,s)
              , y = n.getHomeCenter()
              , S = m <= v;
          (S = !S) ? (b.height = b.width / m,
              b.y = y.y - b.height / 2) : (b.width = b.height * m,
              b.x = y.x - b.width / 2),
              n.fitBounds(b)
        }
      }(w.getCurrentImage(), e.rotation)
    }),
        w.bind("resize", function() {
          var t = w.viewport.getBounds(!0);
          w.viewport.fitBounds(t, !0),
              w.zoomByRatio(.999999999),
              setTimeout(function() {
                w.viewport.fitBounds(t);
                var e = w.rotate();
                e && w.rotate(e)
              }, 50)
        }),
    i && (t.bind("mouseover", function(e) {
      0 == (1 & e.buttons) && w.tracker.releaseMouse()
    }),
        w.bind("mouseup", function() {
          w.tracker.releaseMouse()
        }));
    try {
      window.sessionStorage && window.sessionStorage.setItem(e, 1)
    } catch (e) {
      window.sessionStorage.setItem = function() {}
    }
    if (SlideViewerConfig.isSimple) {
      w.getNavigationView().setVisibility(!1),
          w.bind("updatefinish", function(e) {
            window.status = "LoadFinish",
                document.title = "LoadFinish",
                console.log("LoadFinish")
          });
      var n = $.query.get("taskId");
      w.bind("updateTask", function(e) {
        for (var t = [], n = w.getCurrentSlide().id, a = 0; a < e.data.length; a++)
          n == e.data[a].slideId.toLowerCase() && t.push(e.data[a].annotation);
        w.getShapeCanvas().initImageAnnotationsShape(t, !1),
            w.getShapeCanvas().showImageShapes(!1)
      }),
          w.broadcast({
            type: "initTask",
            taskId: n
          })
    } else
      w.provider.getTitle(function(e) {
        document.title = e + " - " + document.title
      }),
      window.ROICapture && new ROICapture(w),
          f.initUI(w);
    function a(e) {
      if (e.data) {
        var t = "object" == typeof e.data ? e.data : JSON.parse(e.data);
        w.trigger(t.t, t)
      }
    }
    window.addEventListener ? window.addEventListener("message", a, !1) : window.attachEvent("message", a),
        $(document).bind("keydown", function(e) {
          switch (e.keyCode) {
            case 37:
            case 38:
            case 39:
            case 40:
              -1 != e.target.className.indexOf("ui-slider-handle") && e.stopPropagation();
              break;
            case 33:
              w.provider.postMessage("[PrePage]");
              break;
            case 34:
              w.provider.postMessage("[NextPage]")
          }
        }),
        $(w.getShapeCanvas().getCommonCanvas()).mousewheel(function(e, t, n, a) {
          if (s(),
              e.ctrlKey)
            return 0 < t ? w.rotateOffset(-ShortcutConfig.Rotate.degree) : w.rotateOffset(ShortcutConfig.Rotate.degree),
                !1
        }),
        s(),
        w.trigger("m.open")
  }
  w.bind("open", function() {
    var o = w.getCurrentImage()
        , s = w.getShapeCanvas();
    if (s.isSelectedEnable = !1,
    v < 1 && b != o.id) {
      v = 1;
      for (var e = w.getCurrentSlide().ROIs, t = 0; t < e.length; t++)
        if (e[t].id == b)
          return void w.openImage(e[t])
    }
    if (v < 2 && b == o.id) {
      v = 2;
      var n = $.isNumeric
          , a = m.get("w");
      a = n(a) ? a : parseFloat(sessionStorage.getItem("sv_w"));
      var i = m.get("h");
      i = n(i) ? i : parseFloat(sessionStorage.getItem("sv_h"));
      var r = m.get("x");
      r = n(r) ? r : parseFloat(sessionStorage.getItem("sv_x"));
      var l = m.get("y");
      l = n(l) ? l : parseFloat(sessionStorage.getItem("sv_y"));
      var d, c = m.get("s"), u = m.get("rotation");
      sessionStorage.removeItem("sv_w"),
          sessionStorage.removeItem("sv_h"),
          sessionStorage.removeItem("sv_x"),
          sessionStorage.removeItem("sv_y"),
      n(r) && n(l) && (f.panTo(r, l, a, i, c, u, !0),
      y && function(n, e, t, a, i) {
        var o = "sv_task_" + n
            , s = {
          x: e,
          y: t,
          w: a,
          h: i
        };
        SlideViewerConfig.localStorage(o, (new Date).getTime()),
            $(window).bind("unload", function() {
              SlideViewerConfig.localStorage(o, null, !0)
            }),
            w.bind("mv-panTo", function(e) {
              if (n == e.taskId)
                if (e.slideId == w.getCurrentSlide().id)
                  s = e;
                else {
                  var t = [w.provider.getRelevantSlideUrl(e.slideId), "?x=", e.x, "&y=", e.y, "&w=", e.w, "&h=", e.h, "&s=", e.s, "&taskId=", n].join("");
                  location.href = t
                }
            });
        var r = w.getShapeCanvas().getCommonCanvas().getContext("2d");
        w.getShapeCanvas().bind("renderComCav", function() {
          r.save();
          var e = w.rotate();
          if (e) {
            var t = w.viewport.getContainerSize()
                , n = new SeadragonPoint(t.x / 2,t.y / 2);
            n = new SeadragonPoint(0,0).rotate(e, n),
                r.translate(n.x, n.y),
                r.rotate(-e)
          }
          var a = w.getShapeCanvas()
              , i = a.getCavOffset()
              , o = a.getCavScale();
          r.translate(i.x, i.y),
              r.scale(o, o),
              r.lineWidth = 2 / o,
              r.strokeStyle = "#000000",
              r.strokeRect(s.x, s.y, s.w, s.h),
              r.strokeStyle = "#ffffff",
              r.setLineDash([10 / o, 8 / o]),
              r.strokeRect(s.x, s.y, s.w, s.h),
              r.restore()
        })
      }(y, r, l, a, i),
          C = !0),
      w.is3DImage() && !isNaN(d = parseInt(m.get("t"))) && w.change3DTierIndex(d);
      var p = m.get("sm");
      "1" == p ? (s.isAlwaysDisaplyMeasurement = !0,
          s.showMeasurement(!0)) : (p = m.get("a")) && s.setActiveShapeByGUID(p, !1, !0);
      var g = m.get("R");
      g && $.each(g, function() {
        var e = o.scanObjective / this.o
            , t = e * this.x1
            , n = e * this.x2
            , a = e * this.y1
            , i = e * this.y2;
        s.addShape(AnnotationType.Rectangle, new Point(t,a), new Point(n,i), null, !1, !1)
      })
    }
    if (w.bind("mv-panTo", function(e) {
      e.slideId == w.getCurrentSlide().id && f.panTo(e.x, e.y, e.w, e.h, e.s, e.rotation)
    }),
        w.drawer.addListener("loadError", function(e) {
          w.provider.sendMessage(JSON.stringify(e))
        }),
        w.drawer.addListener("disConnection", function(e) {
          w.provider.enableProxy() && w.reloadImage()
        }),
    v < 3) {
      v = 3,
          w.provider.subscribeMessage(function(e) {
            if (e.status) {
              if (SlideViewerConfig.isSimple)
                return;
              e.connected ? w.showMessage(MMDSSlideViewerStrings.getString("Messages.Connected")) : w.showMessage(MMDSSlideViewerStrings.getString("Messages.Disconnected"), 4e3)
            } else
              w.drawer.reset(e)
          }),
      SlideViewerSupport.canvas && w.provider.getRotate(A, !0);
      var h = SlideViewerConfig.changeViewportOffset();
      w.setChangeViewportOffset(-h.x, -h.y),
      window.Watermark && new Watermark(w),
      window.Exchange && (w.exchange = new Exchange(w))
    }
    v < 4 ? (v = 4,
        setTimeout(S, 1)) : w.trigger("m.open")
  }),
      this.openSlide = function(e) {
        w.openMds(e)
      }
  ;
  this.getObjectives = function() {}
      ,
      this.getRotation = function() {
        return w.rotate()
      }
  ;
  var k = $.isNumeric;
  function x(e, t, n) {
    var a = e.x
        , i = e.y
        , o = n.x
        , s = n.y
        , r = (a - o) * Math.cos(t) - (i - s) * Math.sin(t) + o
        , l = (a - o) * Math.sin(t) + (i - s) * Math.cos(t) + s;
    return new Point(r,l)
  }
  function A(e) {
    if (e.error)
      throw "Get radian error:" + e.error;
    0 != e.radian && w.rotate(e.radian, !1)
  }
  this.panTo = function(g, h, f, v, e, m, b) {
    if (k(e)) {
      k(f) && k(v) && (g += f / 2,
          h += v / 2);
      var t = w.getCurrentImage().width;
      g /= t,
          h /= t,
          e = t * e / w.viewport.getContainerSize().x,
          w.viewport.zoomTo(e, null, b),
          w.viewport.panTo(new SeadragonPoint(g,h), b)
    } else
      w.provider.getSlideExtPromise().then(function(e) {
        if (k(m))
          w.rotate(m);
        else if (e.rotation) {
          var t = e.rotation
              , n = new Point(g,h)
              , a = new Point(g + f,h + v)
              , i = new Point(a.x,h)
              , o = new Point(g,a.y)
              , s = new Point(g + f / 2,h + v / 2)
              , r = x(n, -t, s)
              , l = x(a, -t, s)
              , d = x(i, -t, s)
              , c = x(o, -t, s);
          g = Math.min(r.x, l.x, d.x, c.x),
              h = Math.min(r.y, l.y, d.y, c.y),
              f = Math.max(r.x, l.x, d.x, c.x) - g,
              v = Math.max(r.y, l.y, d.y, c.y) - h
        }
        var u = w.getCurrentImage().width;
        f /= u,
            v /= u,
            g /= u,
            h /= u;
        var p = new SeadragonRect(g,h,f,v);
        w.zoomByRatio(.999999999),
            setTimeout(function() {
              w.viewport.fitBounds(p, b)
            }, 20)
      })
  }
      ,
      this.getCaptureParam = function(e) {
        var t = w.getShapeCanvas()
            , n = t.hasAnnotationOnView()
            , a = w.getScale()
            , i = w.getCurrentImage()
            , o = w.viewport.getBounds()
            , s = i.width * a
            , r = {
          image: i,
          bounds: new SeadragonRect(s * o.x,s * o.y,s * o.width,s * o.height),
          scale: w.getScale(),
          tierIndex: w.getCurrent3DTierIndex(),
          is3DImage: w.is3DImage(),
          hasAnnotation: n,
          description: {
            rotation: w.rotate() || 0
          },
          isROI: !0,
          getParam: !0
        };
        t && (r.activeShape = t.getActiveShape()),
            w.provider.capture(r, e),
            r.scanObjective = w.getCurrentImage().scanObjective
      }
      ,
      this.bind = function(e, t) {
        w.bind(e, t)
      }
      ,
      this.getNativeViewer = function() {
        return w
      }
      ,
      $(window).bind("unload", function() {
        SlideViewerConfig.localStorage("sv_task_" + y, null, !0),
            w.provider.stopBrowse()
      })
};
MMDSSlideViewer.prototype.initUI = function(i) {
  var e = document.createElement("div");
  e.style.textAlign = "right",
      e.className = "tool-fixed",
      i.addControl(e, Seadragon.ControlAnchor.TOP_RIGHT);
  var t = document.createElement("div");
  t.style.textAlign = "center",
      t.style.display = "inline-block",
      (n = document.createElement("div")).className = "ctrl_wrap",
      t.appendChild(n),
      e.appendChild(t),
      t.appendChild(new BackBaseImage(i).elmt),
      i.zoomTools = new SlideZoom(i),
      i.scaleTools = new Scale(i),
      t.appendChild(i.zoomTools.elmt),
  i.is3DImage() && t.appendChild(new TierScroll(i).elmt);
  var n, o = document.createElement("div");
  e.appendChild(o),
      (n = document.createElement("div")).className = "ctrl_wrap",
      n.style.marginTop = "-10px",
      o.appendChild(n),
  SlideViewerConfig.enableLabel && i.provider.isSensitive(function(e) {
    if (!e) {
      var t = i.getSlideLabel();
      t.bindContainer(o);
      var n = new MedSlideLabel(i.provider.getLabelUrl());
      o.appendChild(n.elmt),
          t.add(n);
      var a = new MedSlideLabel(i.provider.getSlideSlideUrl(),i);
      o.appendChild(a.elmt),
          t.add(a)
    }
  }),
      i.addControl(new SlideMenu(i,{
        show: SlideViewerConfig.enableMenu
      }).elmt, Seadragon.ControlAnchor.BOTTOM_LEFT);
  var a = document.createElement("div");
  a.className = "tool-fixed",
      a.style.textAlign = "right",
      new FullScreen(i,a),
      i.addControl(a, Seadragon.ControlAnchor.BOTTOM_RIGHT),
      i.bind("m.open", function() {
        $("#Thumbnail").css({
          top: "10px",
          left: "10px",
          zIndex: "2"
        })
      }),
      i.marker = new SlideMarker(i),
      i.addControl(i.marker.elmt, Seadragon.ControlAnchor.NONE),
  "Leap"in window && new LeapMotion(i)
}
    ,
    SlideViewer.prototype.insertOverlay = function(e, t) {
      var n = $(this.getShapeCanvas().getCommonCanvas()).parent();
      null == t ? n.append(e) : n.children().eq(t).before(e)
    }
;
//# sourceMappingURL=viewer.med.min.js.map
